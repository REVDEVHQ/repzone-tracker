<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>RepZone Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif; }
  .leaflet-container { height: 100% !important; width: 100% !important; touch-action: pan-x pan-y; }
  
  .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }
  @keyframes progress {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  @keyframes slideIn { 
    from { transform: translateX(400px); opacity: 0; } 
    to { transform: translateX(0); opacity: 1; } 
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }
  
  .tracking-indicator { animation: pulse 2s infinite; }
  .tab { padding: 0.875rem 1.25rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; transition: all 0.3s; font-size: 0.9375rem; }
  .tab.active { border-bottom-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
  .tab:hover { background: #f1f5f9; }
  .toast { position: fixed; top: 5rem; right: 1rem; background: white; padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 10001; animation: slideIn 0.3s ease; max-width: 400px; border-left: 4px solid #3b82f6; }
  
  .stat-card {
    background: white;
    border-radius: 1rem;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s;
    border: 1px solid #e5e7eb;
  }
  
  .stat-card:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  
  .modern-button {
    transition: all 0.2s;
    font-weight: 600;
    cursor: pointer;
  }
  
  .modern-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .modern-button:active {
    transform: translateY(0);
  }
  
  .loading-shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 1000px 100%;
    animation: shimmer 2s infinite;
  }
  
  .hamburger-btn {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    width: 54px;
    height: 54px;
    background: white;
    border: none;
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 1002;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.3s;
  }
  
  .hamburger-btn:hover {
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  }
  
  .hamburger-btn span {
    width: 26px;
    height: 3px;
    background: #1e293b;
    border-radius: 2px;
    transition: all 0.3s;
  }
  
  .hamburger-btn.open span:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
  }
  
  .hamburger-btn.open span:nth-child(2) {
    opacity: 0;
  }
  
  .hamburger-btn.open span:nth-child(3) {
    transform: rotate(-45deg) translate(6px, -6px);
  }
  
  .mobile-dropdown {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: white;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
    z-index: 1001;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .mobile-dropdown.open {
    max-height: 85vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .desktop-sidebar {
    display: flex;
  }
  
  @media (max-width: 768px) {
    .hamburger-btn {
      display: flex;
    }
    
    .mobile-dropdown {
      display: block;
    }
    
    .desktop-sidebar {
      display: none !important;
    }
    
    .toast {
      left: 1rem;
      right: 1rem;
      top: 1rem;
    }
  }
  
  @media (min-width: 769px) {
    .hamburger-btn {
      display: none !important;
    }
    
    .mobile-dropdown {
      display: none !important;
    }
    
    .desktop-sidebar {
      display: flex !important;
    }
  }
  
  ::-webkit-scrollbar {
    width: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>
</head>
<body>
<div id="root"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SUPABASE_URL = 'https://cytikhfyygkovnjtpsth.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dGlraGZ5eWdrb3ZuanRwc3RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTc3NzYsImV4cCI6MjA3NjI5Mzc3Nn0.ItJObIXo_Ks8TEigj5RkUA4vXbze_3FMMIzYyVHrthQ';

const COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];

const LEAD_TYPES = {
  estimate: { icon: 'üí∞', label: 'A - Estimate', color: '#10b981', display: 'A' },
  callback: { icon: 'üìû', label: 'B - Callback 1-2 Weeks', color: '#f59e0b', display: 'B' },
  notinterested: { icon: 'üìã', label: 'C - Not Interested (Has Info)', color: '#64748b', display: 'C' },
  flyer_dropped: { icon: 'üì¨', label: 'FD - Flyer Dropped', color: '#3b82f6', display: 'FD' },
  knocked: { icon: '‚úÖ', label: 'Knocked', color: '#16a34a', display: '‚úÖ' },
  flyer: { icon: 'üì¨', label: 'Flyer', color: '#2563eb', display: 'üì¨' },
  skipped: { icon: '‚è≠Ô∏è', label: 'Skipped', color: '#ef4444', display: '‚è≠Ô∏è' }
};

const GPS_MAX_AGE_MS = 30000;

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c * 3.28084;
}

function getVerificationStatus(distance) {
  if (distance <= 50) return { status: 'verified', color: '#10b981', icon: '‚úÖ', label: 'Verified' };
  if (distance <= 150) return { status: 'questionable', color: '#f59e0b', icon: '‚ö†Ô∏è', label: 'Questionable' };
  return { status: 'suspicious', color: '#ef4444', icon: 'üö´', label: 'Suspicious' };
}

function isPointInPolygon(point, polygon) {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i][0], yi = polygon[i][1];
    const xj = polygon[j][0], yj = polygon[j][1];
    const intersect = ((yi > point[1]) !== (yj > point[1])) && (point[0] < (xj - xi) * (point[1] - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function isGPSFresh(location) {
  if (!location || !location.timestamp) return false;
  const age = Date.now() - location.timestamp;
  return age < GPS_MAX_AGE_MS;
}

function getGPSAge(location) {
  if (!location || !location.timestamp) return null;
  return Math.floor((Date.now() - location.timestamp) / 1000);
}

// üè† FULL ADDRESS GEOCODING - Returns address + snapped coordinates
async function reverseGeocode(lat, lng) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`,
      {
        headers: {
          'User-Agent': 'RepZone Door Knocking App'
        }
      }
    );
    
    if (!response.ok) return null;
    
    const data = await response.json();
    
    if (!data || !data.address) return null;
    
    const addr = data.address;
    const houseNumber = addr.house_number || '';
    const road = addr.road || addr.street || '';
    const city = addr.city || addr.town || addr.village || '';
    const state = addr.state || '';
    const postcode = addr.postcode || '';
    const county = addr.county || '';
    const suburb = addr.suburb || addr.neighbourhood || '';
    
    // Build full address string
    let fullAddress = '';
    if (houseNumber && road) {
      fullAddress = `${houseNumber} ${road}`;
      if (suburb) fullAddress += `, ${suburb}`;
      if (city) fullAddress += `, ${city}`;
      if (state) fullAddress += `, ${state}`;
      if (postcode) fullAddress += ` ${postcode}`;
    } else if (road) {
      fullAddress = road;
      if (suburb) fullAddress += `, ${suburb}`;
      if (city) fullAddress += `, ${city}`;
      if (state) fullAddress += `, ${state}`;
    } else if (suburb && city) {
      fullAddress = `${suburb}, ${city}`;
      if (state) fullAddress += `, ${state}`;
    } else if (city) {
      fullAddress = city;
      if (state) fullAddress += `, ${state}`;
    } else {
      fullAddress = 'Address Not Found';
    }
    
    // Build short address (for compact display)
    let shortAddress = '';
    if (houseNumber && road) {
      shortAddress = `${houseNumber} ${road}`;
    } else if (road) {
      shortAddress = road;
    } else if (suburb) {
      shortAddress = suburb;
    } else {
      shortAddress = city || 'Unknown';
    }
    
    return {
      fullAddress,
      shortAddress,
      houseNumber,
      street: road,
      suburb,
      city,
      county,
      state,
      postcode,
      lat: parseFloat(data.lat),
      lng: parseFloat(data.lon),
      displayName: data.display_name,
      addressType: data.addresstype || data.type
    };
  } catch (error) {
    console.error('Geocoding error:', error);
    return null;
  }
}

// üîç FORWARD GEOCODING - Search for address
async function forwardGeocode(query) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`,
      {
        headers: {
          'User-Agent': 'RepZone Door Knocking App'
        }
      }
    );
    
    if (!response.ok) return [];
    
    const data = await response.json();
    
    return data.map(result => ({
      displayName: result.display_name,
      lat: parseFloat(result.lat),
      lng: parseFloat(result.lon),
      type: result.type,
      importance: result.importance
    }));
  } catch (error) {
    console.error('Forward geocoding error:', error);
    return [];
  }
}

function RepZoneApp() {
  const [pins, setPins] = useState([]);
  const [zones, setZones] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [liveLocations, setLiveLocations] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentLocation, setCurrentLocation] = useState(null);
  const [mode, setMode] = useState("drop-pin");
  const [status, setStatus] = useState("estimate");
  const [activeZoneId, setActiveZoneId] = useState(null);
  const [selectedZone, setSelectedZone] = useState(null);
  const [note, setNote] = useState("");
  const [filter, setFilter] = useState({ status: "all", userId: "all" });
  const [activeTab, setActiveTab] = useState("map");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [mapReady, setMapReady] = useState(false);
  const [showUserModal, setShowUserModal] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [newUserName, setNewUserName] = useState("");
  const [newUserRole, setNewUserRole] = useState("rep");
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [leaderboardPeriod, setLeaderboardPeriod] = useState('week');
  const [leaderboardType, setLeaderboardType] = useState('d2d');
  const [trackingEnabled, setTrackingEnabled] = useState(false);
  const [showLiveTracking, setShowLiveTracking] = useState(true);
  const [toastMessage, setToastMessage] = useState(null);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [geocoding, setGeocoding] = useState(false);
  const [addressSearch, setAddressSearch] = useState("");
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const supabase = useRef(null);
  const locationWatchId = useRef(null);
  const locationUpdateInterval = useRef(null);
  const searchTimeoutRef = useRef(null);
  
  const zoneLayerRef = useRef(null);
  const pinLayerRef = useRef(null);
  const liveLayerRef = useRef(null);
  const userLocationLayerRef = useRef(null);

  async function setSupabaseUser(userId) {
    if (!userId || !supabase.current) return;
    try {
      await supabase.current.rpc('set_current_user', { user_id: userId });
    } catch (e) {
      console.error('Error setting user context:', e);
    }
  }

  function showToast(message, duration = 4000) {
    setToastMessage(message);
    setTimeout(() => setToastMessage(null), duration);
  }

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    supabase.current = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    loadData();
    const saved = localStorage.getItem('current_user_id');
    if (saved) {
      try {
        const user = JSON.parse(saved);
        setCurrentUser(user);
        requestLocationPermission(user);
      } catch (e) {
        console.error('Error parsing saved user:', e);
      }
    }
  }, []);

  useEffect(() => {
    if (!supabase.current) return;
    loadLiveLocations();
    const interval = setInterval(loadLiveLocations, 10000);
    return () => clearInterval(interval);
  }, []);

  async function loadLiveLocations() {
    try {
      const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      const { data, error } = await supabase.current
        .from('live_locations')
        .select('*')
        .gte('last_updated', fiveMinutesAgo)
        .eq('is_active', true);
      if (!error && data) setLiveLocations(data);
    } catch (e) {}
  }

  async function requestLocationPermission(user) {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      () => startLocationTracking(user),
      () => {}
    );
  }

  function startLocationTracking(user) {
    if (!user || locationWatchId.current) return;
    setTrackingEnabled(true);
    locationWatchId.current = navigator.geolocation.watchPosition(
      (position) => {
        setCurrentLocation({
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: Date.now()
        });
      },
      () => {},
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
    );
    locationUpdateInterval.current = setInterval(() => {
      if (currentLocation && user) updateLiveLocation(user.id, currentLocation);
    }, 30000);
  }

  function stopLocationTracking() {
    if (locationWatchId.current) {
      navigator.geolocation.clearWatch(locationWatchId.current);
      locationWatchId.current = null;
    }
    if (locationUpdateInterval.current) {
      clearInterval(locationUpdateInterval.current);
      locationUpdateInterval.current = null;
    }
    setTrackingEnabled(false);
    if (currentUser) {
      updateLiveLocationInactive(currentUser.id);
    }
  }

  async function updateLiveLocation(userId, location) {
    try {
      await setSupabaseUser(userId);
      await supabase.current.from('live_locations').upsert({
        team_member_id: userId,
        lat: location.lat,
        lng: location.lng,
        accuracy: location.accuracy,
        last_updated: new Date().toISOString(),
        is_active: true
      }, { onConflict: 'team_member_id' });
      loadLiveLocations();
    } catch (e) {}
  }

  async function updateLiveLocationInactive(userId) {
    try {
      await setSupabaseUser(userId);
      await supabase.current.from('live_locations').update({ is_active: false }).eq('team_member_id', userId);
    } catch (e) {}
  }

  useEffect(() => {
    if (currentLocation && currentUser && trackingEnabled) {
      updateLiveLocation(currentUser.id, currentLocation);
    }
  }, [currentLocation, currentUser, trackingEnabled]);

  useEffect(() => () => stopLocationTracking(), []);

  async function loadData() {
    try {
      const [pinsRes, zonesRes, teamRes] = await Promise.all([
        supabase.current.from('pins').select('*'),
        supabase.current.from('zones').select('*'),
        supabase.current.from('team_members').select('*')
      ]);
      setPins(pinsRes.data || []);
      setZones(zonesRes.data || []);
      setTeamMembers(teamRes.data || []);
    } catch (e) {}
    setLoading(false);
  }

  async function deletePin(pinId) {
    if (!confirm('Delete this pin?')) return;
    if (!currentUser) return;
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('pins').delete().eq('id', pinId);
      setPins(prev => prev.filter(p => p.id !== pinId));
      showToast('‚úÖ Pin deleted successfully!');
    } catch (e) {
      showToast('‚ùå Error deleting pin: ' + e.message);
    }
  }

  async function updatePinStatus(pinId, newStatus) {
    if (!currentUser) return;
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('pins').update({ status: newStatus }).eq('id', pinId);
      setPins(prev => prev.map(p => p.id === pinId ? {...p, status: newStatus} : p));
      showToast(`‚úÖ Updated to ${LEAD_TYPES[newStatus]?.label || newStatus}!`);
    } catch (e) {
      showToast('‚ùå Error updating pin: ' + e.message);
    }
  }

  async function deleteUser(userId) {
    if (!confirm('Delete this user? All their pins will remain.')) return;
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can delete users!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').delete().eq('id', userId);
      setTeamMembers(prev => prev.filter(u => u.id !== userId));
      if (currentUser?.id === userId) setCurrentUser(null);
      showToast('‚úÖ User deleted!');
    } catch (e) {
      showToast('‚ùå Error deleting user: ' + e.message);
    }
  }

  async function updateUserRole(userId, newRole) {
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can change roles!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').update({ role: newRole }).eq('id', userId);
      setTeamMembers(prev => prev.map(u => u.id === userId ? {...u, role: newRole} : u));
      if (currentUser?.id === userId) {
        const updatedUser = {...currentUser, role: newRole};
        setCurrentUser(updatedUser);
        localStorage.setItem('current_user_id', JSON.stringify(updatedUser));
      }
      setEditingUser(null);
      showToast(`‚úÖ Role updated to ${newRole}!`);
    } catch (e) {
      showToast('‚ùå Error updating role: ' + e.message);
    }
  }

  async function assignZone(zoneId, userId) {
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can assign zones!');
      return;
    }
    
    const member = teamMembers.find(m => m.id === userId);
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').update({ 
        assigned_to: userId,
        color: member?.color || COLORS[0]
      }).eq('id', zoneId);
      setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: userId, color: member?.color} : z));
      setSelectedZone(null);
      showToast(`‚úÖ Zone assigned to ${member.name}!`);
    } catch (e) {
      showToast('‚ùå Error assigning zone: ' + e.message);
    }
  }

  async function unassignZone(zoneId) {
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can unassign zones!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').update({ assigned_to: null }).eq('id', zoneId);
      setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: null} : z));
      setSelectedZone(null);
      showToast('‚úÖ Zone unassigned!');
    } catch (e) {
      showToast('‚ùå Error unassigning zone: ' + e.message);
    }
  }

  async function deleteZone(zoneId) {
    if (!confirm('Delete this zone permanently?')) return;
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can delete zones!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').delete().eq('id', zoneId);
      setZones(prev => prev.filter(z => z.id !== zoneId));
      setSelectedZone(null);
      showToast('‚úÖ Zone deleted!');
    } catch (e) {
      showToast('‚ùå Error deleting zone: ' + e.message);
    }
  }

  useEffect(() => {
    window.deletePinGlobal = deletePin;
    window.updatePinStatusGlobal = updatePinStatus;
    return () => {
      delete window.deletePinGlobal;
      delete window.updatePinStatusGlobal;
    };
  }, [currentUser]);

  async function addTeamMember() {
    if (!newUserName.trim()) return;
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can add team members!');
      return;
    }
    
    const newMember = {
      id: `user-${Date.now()}`,
      name: newUserName,
      color: COLORS[teamMembers.length % COLORS.length],
      role: newUserRole,
      created_at: new Date().toISOString()
    };
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').insert([newMember]);
      setTeamMembers(prev => [...prev, newMember]);
      setNewUserName("");
      setNewUserRole("rep");
      setShowUserModal(false);
      showToast(`‚úÖ ${newUserName} added as ${newUserRole}!`);
    } catch (e) {
      showToast('‚ùå Error adding team member: ' + e.message);
    }
  }

  function selectCurrentUser(user) {
    setCurrentUser(user);
    localStorage.setItem('current_user_id', JSON.stringify(user));
    requestLocationPermission(user);
  }

  function getLeaderboard() {
    const now = new Date();
    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
    startOfWeek.setHours(0, 0, 0, 0);
    const startOfDay = new Date();
    startOfDay.setHours(0, 0, 0, 0);

    // Define which statuses count for each leaderboard type
    const d2dStatuses = ['estimate', 'callback', 'notinterested', 'knocked'];
    const flyerStatuses = ['flyer', 'flyer_dropped'];
    const countStatuses = leaderboardType === 'd2d' ? d2dStatuses : flyerStatuses;

    return teamMembers.map(member => {
      const memberPins = pins.filter(p => p.team_member_id === member.id);
      const weekPins = memberPins.filter(p => new Date(p.created_at) >= startOfWeek);
      const dayPins = memberPins.filter(p => new Date(p.created_at) >= startOfDay);

      let count = 0;
      if (leaderboardPeriod === 'week') count = weekPins.filter(p => countStatuses.includes(p.status)).length;
      else if (leaderboardPeriod === 'day') count = dayPins.filter(p => countStatuses.includes(p.status)).length;
      else count = memberPins.filter(p => countStatuses.includes(p.status)).length;

      const liveLocation = liveLocations.find(l => l.team_member_id === member.id);
      const isOnline = liveLocation && new Date(liveLocation.last_updated) > new Date(Date.now() - 5 * 60 * 1000);

      return { ...member, knockCount: count, isOnline, liveLocation };
    }).sort((a, b) => b.knockCount - a.knockCount);
  }

  // üîç ADDRESS SEARCH FUNCTIONALITY
  useEffect(() => {
    if (searchTimeoutRef.current) {
      clearTimeout(searchTimeoutRef.current);
    }

    if (addressSearch.trim().length < 3) {
      setSearchResults([]);
      return;
    }

    setSearching(true);
    searchTimeoutRef.current = setTimeout(async () => {
      const results = await forwardGeocode(addressSearch);
      setSearchResults(results);
      setSearching(false);
    }, 500);

    return () => {
      if (searchTimeoutRef.current) {
        clearTimeout(searchTimeoutRef.current);
      }
    };
  }, [addressSearch]);

  function selectSearchResult(result) {
    if (mapInstanceRef.current) {
      mapInstanceRef.current.setView([result.lat, result.lng], 18);
      setAddressSearch("");
      setSearchResults([]);
    }
  } 
 useEffect(() => {
    if (!mapRef.current || mapInstanceRef.current || loading) return;
    
    const map = L.map(mapRef.current, {
      center: [47.6062, -122.3321],
      zoom: isMobile ? 12 : 13,
      zoomControl: !isMobile,
      tap: true,
      tapTolerance: 15
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    if (isMobile) L.control.zoom({ position: 'topright' }).addTo(map);

    zoneLayerRef.current = L.layerGroup().addTo(map);
    pinLayerRef.current = L.layerGroup().addTo(map);
    liveLayerRef.current = L.layerGroup().addTo(map);
    userLocationLayerRef.current = L.layerGroup().addTo(map);

    mapInstanceRef.current = map;
    
    setTimeout(() => {
      map.invalidateSize();
      setMapReady(true);
    }, 300);
  }, [loading, isMobile]);

  useEffect(() => {
    const map = mapInstanceRef.current;
    if (!map || !mapReady) return;

    const handleClick = async (e) => {
      const { lat, lng } = e.latlng;
      
      if (mode === "drop-pin" && currentUser) {
        if (!currentLocation) {
          showToast('‚ö†Ô∏è Enable GPS tracking first!');
          return;
        }

        if (!isGPSFresh(currentLocation)) {
          const age = getGPSAge(currentLocation);
          showToast(`‚ö†Ô∏è GPS data is ${age}s old! Move around to get fresh GPS signal, then try again.`, 6000);
          return;
        }

        setSaving(true);
        setGeocoding(true);

        try {
          // üè† GET FULL ADDRESS + SNAP TO BUILDING
          const addressData = await reverseGeocode(lat, lng);
          
          let finalLat = lat;
          let finalLng = lng;
          let address = null;
          let shortAddress = null;
          
          if (addressData && addressData.fullAddress !== 'Address Not Found') {
            finalLat = addressData.lat;
            finalLng = addressData.lng;
            address = addressData.fullAddress;
            shortAddress = addressData.shortAddress;
            
            showToast(`üìç Found: ${shortAddress}`, 3000);
          } else {
            showToast('‚ö†Ô∏è No address found - saving location anyway', 3000);
          }

          const distance = calculateDistance(currentLocation.lat, currentLocation.lng, finalLat, finalLng);
          const verification = getVerificationStatus(distance);
          const clickedZone = zones.find(z => {
            if (!z.points || z.points.length < 3) return false;
            return isPointInPolygon([finalLat, finalLng], z.points);
          });

          const newPin = {
            id: `pin-${Date.now()}`,
            lat: finalLat, 
            lng: finalLng, 
            status,
            address: address, // üè† STORE FULL ADDRESS
            rep_name: currentUser.name,
            team_member_id: currentUser.id,
            zone_id: clickedZone?.id || null,
            note: note || null,
            actual_lat: currentLocation.lat,
            actual_lng: currentLocation.lng,
            distance_from_pin: Math.round(distance),
            verification_status: verification.status,
            created_at: new Date().toISOString()
          };
          
          await setSupabaseUser(currentUser.id);
          const { data, error } = await supabase.current.from('pins').insert([newPin]).select();
          
          if (error) {
            showToast('‚ùå Error saving pin: ' + error.message);
          } else {
            setPins(prev => [...prev, newPin]);
            setNote("");
            const leadTypeLabel = LEAD_TYPES[status]?.label || status;
            const gpsAge = getGPSAge(currentLocation);
            if (verification.status === 'verified') {
              showToast(`‚úÖ ${leadTypeLabel} at ${shortAddress || 'location'}! (${Math.round(distance)}ft, GPS: ${gpsAge}s)`, 5000);
            } else if (verification.status === 'suspicious') {
              showToast(`‚ö†Ô∏è ${leadTypeLabel} saved but ${Math.round(distance)}ft away - marked suspicious`, 5000);
            } else {
              showToast(`‚ö†Ô∏è ${leadTypeLabel} saved (${Math.round(distance)}ft - questionable)`, 5000);
            }
          }
        } catch (error) {
          showToast('‚ùå Error: ' + error.message);
        }
        
        setSaving(false);
        setGeocoding(false);
      } else if (mode === "draw-zone") {
        if (currentUser?.role !== 'admin') {
          showToast('‚ö†Ô∏è Only admins can create zones!');
          return;
        }

        const id = activeZoneId || `zone-${Date.now()}`;
        const existing = zones.find(z => z.id === id);
        const newPoints = existing ? [...existing.points, [lat, lng]] : [[lat, lng]];
        
        try {
          await setSupabaseUser(currentUser.id);
          
          if (existing) {
            await supabase.current.from('zones').update({ points: newPoints }).eq('id', id);
            setZones(prev => prev.map(z => z.id === id ? {...z, points: newPoints} : z));
          } else {
            const newZone = {
              id, 
              name: `Zone ${zones.length + 1}`,
              color: COLORS[zones.length % COLORS.length],
              points: newPoints,
              created_by: currentUser?.name || 'Admin',
              assigned_to: null,
              created_at: new Date().toISOString()
            };
            await supabase.current.from('zones').insert([newZone]);
            setZones(prev => [...prev, newZone]);
            showToast('üìç Zone point added! Double-click to finish.');
          }
          setActiveZoneId(id);
        } catch (error) {
          showToast('‚ùå Error creating zone: ' + error.message);
        }
      }
    };

    map.on('click', handleClick);
    map.on('dblclick', () => {
      if (mode === "draw-zone" && activeZoneId) {
        setActiveZoneId(null);
        setMode("select");
        showToast('‚úÖ Zone completed!');
      }
    });

    return () => map.off('click', handleClick);
  }, [mode, status, note, activeZoneId, zones, mapReady, currentUser, currentLocation, teamMembers]);

  useEffect(() => {
    if (!mapReady || !zoneLayerRef.current) return;
    
    zoneLayerRef.current.clearLayers();

    zones.forEach(zone => {
      if (zone.points?.length >= 3) {
        const assigned = teamMembers.find(u => u.id === zone.assigned_to);
        const polygon = L.polygon(zone.points, {
          color: assigned?.color || zone.color,
          fillColor: assigned?.color || zone.color,
          fillOpacity: 0.2,
          weight: 3,
          interactive: mode !== "drop-pin",
          bubblingMouseEvents: true
        });

        polygon.addTo(zoneLayerRef.current);

        if (mode === "select") {
          polygon.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            setSelectedZone(zone);
          });
        }

        polygon.bindPopup(`
          <div style="padding:12px;min-width:180px;font-family:-apple-system,sans-serif">
            <b style="font-size:17px;color:#1e293b">${zone.name}</b><br>
            <div style="margin-top:8px">
              ${assigned ? `<span style="color:${assigned.color};font-weight:600;font-size:15px">üë§ ${assigned.name}</span>` : '<span style="color:#64748b;font-weight:600">‚ö†Ô∏è Unassigned</span>'}
            </div>
            ${mode === "select" ? '<div style="margin-top:8px;font-size:13px;color:#64748b">Click to manage zone</div>' : ''}
          </div>
        `);
      }
    });
  }, [zones, teamMembers, mode, mapReady]);

  useEffect(() => {
    if (!mapReady || !pinLayerRef.current) return;
    
    pinLayerRef.current.clearLayers();

    const filtered = pins.filter(p => {
      if (filter.status !== "all" && p.status !== filter.status) return false;
      if (filter.userId !== "all" && p.team_member_id !== filter.userId) return false;
      return true;
    });

    filtered.forEach(pin => {
      const user = teamMembers.find(u => u.id === pin.team_member_id);
      const leadType = LEAD_TYPES[pin.status] || LEAD_TYPES.knocked;
      const verification = pin.verification_status ? getVerificationStatus(pin.distance_from_pin || 0) : null;
      
      // üé® BIGGER, MODERN PIN MARKERS (44px)
      const icon = L.divIcon({
        html: `<div style="background:${user?.color || '#64748b'};width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;border:4px solid ${verification ? verification.color : 'white'};box-shadow:0 4px 12px rgba(0,0,0,0.25);position:relative">${leadType.display}${verification ? `<div style="position:absolute;top:-10px;right:-10px;background:${verification.color};color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:14px;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.2)">${verification.icon}</div>` : ''}</div>`,
        iconSize: [44, 44],
        iconAnchor: [22, 44]
      });
      
      const marker = L.marker([pin.lat, pin.lng], { icon });
      marker.addTo(pinLayerRef.current);
      
      // üé® BEAUTIFUL GRADIENT POPUPS WITH FULL ADDRESS
      marker.bindPopup(`
        <div style="min-width:240px;padding:0;font-family:-apple-system,sans-serif;border-radius:12px;overflow:hidden">
          <div style="background:linear-gradient(135deg, ${leadType.color} 0%, ${leadType.color}dd 100%);padding:16px;color:white">
            <div style="font-size:24px;margin-bottom:4px">${leadType.icon}</div>
            <div style="font-size:18px;font-weight:700">${leadType.label}</div>
          </div>
          
          <div style="padding:16px;background:white">
            ${pin.address ? `
              <div style="padding:12px;background:#f8fafc;border-left:4px solid #3b82f6;margin-bottom:12px;border-radius:6px">
                <div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:6px">üìç ADDRESS</div>
                <div style="font-weight:600;color:#1e293b;font-size:14px;line-height:1.5">${pin.address}</div>
              </div>
            ` : ''}
            
            <div style="padding:10px;background:${user?.color || '#64748b'}15;border-left:4px solid ${user?.color || '#64748b'};margin-bottom:12px;border-radius:6px">
              <div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:4px">üë§ REP</div>
              <div style="font-weight:700;color:${user?.color || '#64748b'};font-size:14px">${pin.rep_name || 'Unknown'}</div>
            </div>
            
            ${pin.note ? `
              <div style="padding:10px;background:#f8fafc;border-left:4px solid #64748b;margin-bottom:12px;border-radius:6px">
                <div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:4px">üìù NOTE</div>
                <div style="color:#1e293b;font-size:13px">${pin.note}</div>
              </div>
            ` : ''}
            
            ${verification ? `
              <div style="padding:12px;background:${verification.color}15;border-left:4px solid ${verification.color};margin-bottom:12px;border-radius:6px">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
                  <span style="font-size:24px">${verification.icon}</span>
                  <div>
                    <div style="font-weight:700;color:${verification.color};font-size:15px">${verification.label}</div>
                    <div style="font-size:13px;color:#64748b;margin-top:2px">Distance: <b>${pin.distance_from_pin} feet</b></div>
                  </div>
                </div>
              </div>
            ` : ''}
            
            <div style="font-size:12px;color:#94a3b8;margin-bottom:14px;text-align:center">
              ${new Date(pin.created_at).toLocaleString()}
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px">
              ${Object.entries(LEAD_TYPES).slice(0,3).map(([key, type]) => `
                <button onclick="window.updatePinStatusGlobal('${pin.id}','${key}')" class="modern-button" style="padding:10px 6px;background:${type.color};color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;box-shadow:0 2px 6px ${type.color}40">${type.display}</button>
              `).join('')}
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px">
              ${Object.entries(LEAD_TYPES).slice(3).map(([key, type]) => `
                <button onclick="window.updatePinStatusGlobal('${pin.id}','${key}')" class="modern-button" style="padding:10px 6px;background:${type.color};color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;box-shadow:0 2px 6px ${type.color}40">${type.display}</button>
              `).join('')}
            </div>
            
            <button onclick="window.deletePinGlobal('${pin.id}')" class="modern-button" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;box-shadow:0 2px 8px rgba(239,68,68,0.3)">üóëÔ∏è Delete Pin</button>
          </div>
        </div>
      `, {
        maxWidth: 280
      });
    });
  }, [pins, filter, teamMembers, mapReady]);

  useEffect(() => {
    if (!mapReady || !liveLayerRef.current || !showLiveTracking) return;
    
    liveLayerRef.current.clearLayers();

    liveLocations.forEach(loc => {
      const member = teamMembers.find(m => m.id === loc.team_member_id);
      if (!member || loc.team_member_id === currentUser?.id) return;

      const minutesAgo = Math.floor((Date.now() - new Date(loc.last_updated)) / 60000);
      const isRecent = minutesAgo < 5;

      const circle = L.circle([loc.lat, loc.lng], {
        radius: 35,
        color: member.color,
        fillColor: member.color,
        fillOpacity: isRecent ? 0.4 : 0.2,
        weight: 3,
        className: isRecent ? 'tracking-indicator' : ''
      });

      circle.addTo(liveLayerRef.current);

      const liveIcon = L.divIcon({
        html: `<div style="background:${member.color};width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:1.25rem;border:4px solid white;box-shadow:0 4px 16px rgba(0,0,0,0.25);position:relative">${member.name.charAt(0)}${isRecent ? `<div style="position:absolute;top:-6px;right:-6px;width:16px;height:16px;background:#10b981;border:3px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(16,185,129,0.5)"></div>` : ''}</div>`,
        iconSize: [48, 48],
        iconAnchor: [24, 24]
      });

      const marker = L.marker([loc.lat, loc.lng], { icon: liveIcon });
      marker.addTo(liveLayerRef.current);
      marker.bindPopup(`
        <div style="padding:12px;text-align:center;font-family:-apple-system,sans-serif">
          <div style="font-weight:700;font-size:16px;color:${member.color};margin-bottom:4px">${member.name}</div>
          <div style="font-size:13px;color:#64748b">${minutesAgo} min ago</div>
        </div>
      `);
    });
  }, [liveLocations, teamMembers, currentUser, showLiveTracking, mapReady]);

  useEffect(() => {
    if (!mapReady || !userLocationLayerRef.current) return;
    
    userLocationLayerRef.current.clearLayers();

    if (currentLocation && currentUser) {
      const circle = L.circle([currentLocation.lat, currentLocation.lng], {
        radius: 50,
        color: currentUser.color,
        fillColor: currentUser.color,
        fillOpacity: 0.3,
        weight: 3,
        className: 'tracking-indicator'
      });

      circle.addTo(userLocationLayerRef.current);

      const gpsAge = getGPSAge(currentLocation);
      const isFresh = isGPSFresh(currentLocation);
      
      const youIcon = L.divIcon({
        html: `<div style="background:${currentUser.color};width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:1.5rem;border:5px solid white;box-shadow:0 6px 20px rgba(0,0,0,0.3);position:relative">${currentUser.name.charAt(0)}<div style="position:absolute;top:-8px;right:-8px;width:20px;height:20px;background:${isFresh ? '#10b981' : '#f59e0b'};border:4px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.2)"></div></div>`,
        iconSize: [56, 56],
        iconAnchor: [28, 28]
      });

      const marker = L.marker([currentLocation.lat, currentLocation.lng], { icon: youIcon });
      marker.addTo(userLocationLayerRef.current);
      marker.bindPopup(`
        <div style="padding:14px;text-align:center;font-family:-apple-system,sans-serif">
          <div style="font-weight:700;font-size:18px;color:${currentUser.color};margin-bottom:6px">üìç You Are Here</div>
          <div style="font-size:13px;color:#64748b">GPS: ${gpsAge}s old ${isFresh ? '‚úÖ' : '‚ö†Ô∏è Stale'}</div>
        </div>
      `);
    }
  }, [currentLocation, currentUser, mapReady]);

  if (loading) {
    return (
      <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',flexDirection:'column',gap:'1.5rem',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}}>
        <div style={{fontSize:'5rem',animation:'bounce 1s infinite'}}>üè†</div>
        <div>
          <h1 style={{color:'white',fontSize:'2.5rem',fontWeight:'bold',marginBottom:'0.5rem',textAlign:'center'}}>RepZone</h1>
          <p style={{color:'rgba(255,255,255,0.9)',fontSize:'1.125rem',textAlign:'center'}}>Loading your workspace...</p>
        </div>
        <div style={{width:'200px',height:'4px',background:'rgba(255,255,255,0.2)',borderRadius:'2px',overflow:'hidden'}}>
          <div style={{width:'100%',height:'100%',background:'white',animation:'progress 1.5s ease-in-out infinite'}}></div>
        </div>
      </div>
    );
  }

  const stats = {
    totalPins: pins.length,
    estimates: pins.filter(p => p.status === 'estimate').length,
    callbacks: pins.filter(p => p.status === 'callback').length,
    notinterested: pins.filter(p => p.status === 'notinterested').length,
    knocked: pins.filter(p => p.status === 'knocked').length,
    verified: pins.filter(p => p.verification_status === 'verified').length,
    suspicious: pins.filter(p => p.verification_status === 'suspicious').length,
    onlineUsers: liveLocations.filter(l => new Date(l.last_updated) > new Date(Date.now() - 5 * 60 * 1000)).length,
    withAddress: pins.filter(p => p.address).length,
    withoutAddress: pins.filter(p => !p.address).length
  };

  const leaderboard = getLeaderboard();
  const gpsAge = currentLocation ? getGPSAge(currentLocation) : null;
  const gpsIsFresh = currentLocation ? isGPSFresh(currentLocation) : false;

  const LeaderboardView = () => (
    <div style={{padding:'1rem'}}>
      <h2 style={{fontSize:'1.75rem',fontWeight:'bold',marginBottom:'1.25rem',color:'#1e293b'}}>üèÜ Leaderboard</h2>

      <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem',background:'#f1f5f9',padding:'0.375rem',borderRadius:'1rem'}}>
        {[['d2d','üö™ Door-to-Door'],['flyer','üì¨ Flyer']].map(([type, label]) => (
          <button
            key={type}
            onClick={() => setLeaderboardType(type)}
            className="modern-button"
            style={{
              flex:1,
              padding:'0.875rem',
              borderRadius:'0.75rem',
              border:'none',
              background:leaderboardType===type?'white':'transparent',
              color:leaderboardType===type?'#1e293b':'#64748b',
              fontWeight:'700',
              fontSize:'0.875rem',
              boxShadow:leaderboardType===type?'0 2px 8px rgba(0,0,0,0.08)':'none'
            }}
          >
            {label}
          </button>
        ))}
      </div>

      <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem',background:'#f1f5f9',padding:'0.375rem',borderRadius:'1rem'}}>
        {[['day','üìÖ Today'],['week','üìÜ Week'],['all','üóìÔ∏è All Time']].map(([period, label]) => (
          <button
            key={period}
            onClick={() => setLeaderboardPeriod(period)}
            className="modern-button"
            style={{
              flex:1,
              padding:'0.875rem',
              borderRadius:'0.75rem',
              border:'none',
              background:leaderboardPeriod===period?'white':'transparent',
              color:leaderboardPeriod===period?'#1e293b':'#64748b',
              fontWeight:'700',
              fontSize:'0.875rem',
              boxShadow:leaderboardPeriod===period?'0 2px 8px rgba(0,0,0,0.08)':'none'
            }}
          >
            {label}
          </button>
        ))}
      </div>

      <div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>
        {leaderboard.map((member, index) => (
          <div 
            key={member.id} 
            className="stat-card"
            style={{
              background:index===0?`linear-gradient(135deg, ${member.color}22 0%, ${member.color}11 100%)`:index===1?'#f8fafc':'white',
              border:index===0?`3px solid ${member.color}`:index===1?'2px solid #e2e8f0':'1px solid #e5e7eb',
              display:'flex',
              alignItems:'center',
              gap:'1rem',
              position:'relative',
              boxShadow:index===0?'0 8px 20px rgba(0,0,0,0.12)':index===1?'0 4px 12px rgba(0,0,0,0.06)':'0 2px 8px rgba(0,0,0,0.06)'
            }}
          >
            {index < 3 && (
              <div style={{
                position:'absolute',
                top:'-14px',
                left:'-14px',
                width:'44px',
                height:'44px',
                borderRadius:'50%',
                background:index===0?'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)':index===1?'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)':'linear-gradient(135deg, #fb923c 0%, #ea580c 100%)',
                display:'flex',
                alignItems:'center',
                justifyContent:'center',
                color:'white',
                fontWeight:'bold',
                fontSize:'1.25rem',
                boxShadow:'0 4px 12px rgba(0,0,0,0.25)'
              }}>
                {index===0?'ü•á':index===1?'ü•à':'ü•â'}
              </div>
            )}
            <div style={{fontSize:'2.25rem',fontWeight:'bold',color:index<3?member.color:'#94a3b8',width:'50px',textAlign:'center'}}>
              {index>=3?`#${index+1}`:''}
            </div>
            <div style={{width:'64px',height:'64px',borderRadius:'50%',background:member.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.75rem',flexShrink:0,boxShadow:'0 4px 12px rgba(0,0,0,0.2)',position:'relative'}}>
              {member.name.charAt(0)}
              {member.isOnline && (
                <div style={{position:'absolute',top:'-4px',right:'-4px',width:'20px',height:'20px',background:'#10b981',border:'4px solid white',borderRadius:'50%',boxShadow:'0 2px 8px rgba(16,185,129,0.5)'}}></div>
              )}
            </div>
            <div style={{flex:1}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.375rem'}}>
                <span style={{fontWeight:'bold',fontSize:'1.25rem',color:'#1e293b'}}>{member.name}</span>
                {member.isOnline && (
                  <span style={{fontSize:'0.6875rem',padding:'0.375rem 0.625rem',background:'#10b981',color:'white',borderRadius:'1rem',fontWeight:'700',boxShadow:'0 2px 6px rgba(16,185,129,0.3)'}}>‚óè ONLINE</span>
                )}
              </div>
              <div style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>
                {member.knockCount} leads {leaderboardPeriod === 'day' ? 'today' : leaderboardPeriod === 'week' ? 'this week' : 'total'}
              </div>
            </div>
            <div style={{fontSize:'3rem',fontWeight:'bold',color:member.color,textAlign:'right',textShadow:'0 2px 4px rgba(0,0,0,0.1)'}}>
              {member.knockCount}
            </div>
          </div>
        ))}
      </div>

      {leaderboard.length === 0 && (
        <div style={{textAlign:'center',padding:'4rem 1rem',color:'#64748b'}}>
          <div style={{fontSize:'4rem',marginBottom:'1rem'}}>üèÜ</div>
          <p style={{fontSize:'1.25rem',fontWeight:'700',marginBottom:'0.5rem',color:'#1e293b'}}>No data yet</p>
          <p style={{fontSize:'0.9375rem'}}>Start dropping leads to see rankings!</p>
        </div>
      )}
    </div>
  );
 const MobileDropdownContent = () => (
    <div style={{padding:'1rem',paddingTop:'5rem'}}>
      {currentUser && (
        <div style={{marginBottom:'1rem',padding:'1rem',background:`${currentUser.color}15`,borderRadius:'1rem',border:`2px solid ${currentUser.color}`,display:'flex',alignItems:'center',gap:'0.75rem'}}>
          <div style={{width:'48px',height:'48px',borderRadius:'50%',background:currentUser.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.25rem',boxShadow:'0 2px 8px rgba(0,0,0,0.15)'}}>
            {currentUser.name.charAt(0)}
          </div>
          <div style={{flex:1}}>
            <div style={{fontWeight:'700',fontSize:'0.9375rem'}}>{currentUser.name}</div>
            <div style={{fontSize:'0.6875rem',color:'#64748b',fontWeight:'600'}}>{currentUser.role}</div>
          </div>
          <button onClick={() => setCurrentUser(null)} className="modern-button" style={{padding:'0.5rem 0.875rem',fontSize:'0.75rem',background:'white',border:'1px solid #e2e8f0',borderRadius:'0.5rem',fontWeight:'700'}}>Switch</button>
        </div>
      )}

      <div style={{display:'flex',marginBottom:'1rem',background:'#f1f5f9',borderRadius:'0.75rem',padding:'0.375rem'}}>
        {[['controls','‚öôÔ∏è Controls'],['stats','üìä Stats'],['leaderboard','üèÜ Board']].map(([tab,label]) => (
          <button key={tab} onClick={() => setActiveTab(tab)} className="modern-button" style={{flex:1,padding:'0.75rem 0.5rem',borderRadius:'0.5rem',border:'none',background:activeTab===tab?'white':'transparent',color:activeTab===tab?'#1e293b':'#64748b',fontWeight:'700',fontSize:'0.8125rem',boxShadow:activeTab===tab?'0 2px 6px rgba(0,0,0,0.06)':'none'}}>{label}</button>
        ))}
      </div>

      {activeTab === 'controls' && (
        <div>
          {/* üîç ADDRESS SEARCH BAR */}
          {mode === "drop-pin" && (
            <div className="stat-card" style={{marginBottom:'1rem',background:'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',border:'2px solid #3b82f6'}}>
              <label style={{display:'block',fontSize:'0.875rem',fontWeight:'700',marginBottom:'0.75rem',color:'#1e3a8a'}}>üîç Search Address</label>
              <div style={{position:'relative'}}>
                <input 
                  value={addressSearch} 
                  onChange={e => setAddressSearch(e.target.value)} 
                  placeholder="Type address to find location..."
                  style={{width:'100%',padding:'0.875rem',paddingRight:'2.5rem',border:'2px solid #93c5fd',borderRadius:'0.75rem',fontSize:'0.875rem',fontWeight:'600'}}
                />
                {searching && (
                  <div style={{position:'absolute',right:'0.75rem',top:'50%',transform:'translateY(-50%)'}}>
                    <div className="spinner" style={{width:'20px',height:'20px',borderWidth:'2px'}}></div>
                  </div>
                )}
              </div>
              {searchResults.length > 0 && (
                <div style={{marginTop:'0.75rem',maxHeight:'200px',overflowY:'auto',background:'white',borderRadius:'0.75rem',border:'2px solid #93c5fd'}}>
                  {searchResults.map((result, idx) => (
                    <div 
                      key={idx} 
                      onClick={() => selectSearchResult(result)}
                      className="modern-button"
                      style={{padding:'0.875rem',borderBottom:idx < searchResults.length - 1 ? '1px solid #e0f2fe' : 'none',cursor:'pointer',transition:'background 0.2s'}}
                      onMouseEnter={e => e.currentTarget.style.background = '#f0f9ff'}
                      onMouseLeave={e => e.currentTarget.style.background = 'white'}
                    >
                      <div style={{fontSize:'0.875rem',fontWeight:'600',color:'#1e293b',marginBottom:'0.25rem'}}>
                        üìç {result.displayName.split(',')[0]}
                      </div>
                      <div style={{fontSize:'0.75rem',color:'#64748b'}}>
                        {result.displayName}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          <div className="stat-card" style={{marginBottom:'1rem',background:trackingEnabled?'#dcfce7':'#fee2e2',border:`2px solid ${trackingEnabled?'#10b981':'#ef4444'}`}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
              <b style={{fontSize:'0.875rem',fontWeight:'700'}}>üìç GPS Tracking</b>
              <button onClick={() => trackingEnabled ? stopLocationTracking() : requestLocationPermission(currentUser)} className="modern-button" style={{padding:'0.5rem 1rem',background:trackingEnabled?'#ef4444':'#10b981',color:'white',border:'none',borderRadius:'0.5rem',fontWeight:'700',fontSize:'0.75rem',boxShadow:`0 2px 8px ${trackingEnabled?'rgba(239,68,68,0.3)':'rgba(16,185,129,0.3)'}`}}>{trackingEnabled ? 'Stop' : 'Start'}</button>
            </div>
            <p style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600'}}>
              {trackingEnabled ? (
                gpsAge !== null ? `Active - ${gpsAge}s old ${gpsIsFresh ? '‚úÖ' : '‚ö†Ô∏è Stale'}` : 'Active'
              ) : 'Enable to verify'}
            </p>
          </div>

          {currentUser?.role === 'admin' && (
            <div className="stat-card" style={{marginBottom:'1rem',background:'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',border:'2px solid #3b82f6'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                <b style={{fontSize:'0.875rem',fontWeight:'700',color:'#1e3a8a'}}>üë• Team Management</b>
              </div>
              <p style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',marginBottom:'0.75rem'}}>Add new team members</p>
              <button onClick={() => setShowUserModal(true)} className="modern-button" style={{width:'100%',padding:'0.75rem',background:'#3b82f6',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.8125rem',boxShadow:'0 2px 8px rgba(59,130,246,0.3)'}}>‚ûï Add Team Member</button>
            </div>
          )}

          <div className="stat-card" style={{marginBottom:'1rem'}}>
            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'700',marginBottom:'0.75rem',color:'#1e293b'}}>üéØ Mode</label>
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'0.5rem'}}>
              {[['drop-pin','üìç','Pin'],['draw-zone','‚úèÔ∏è','Zone'],['select','üëÜ','Select']].map(([m,icon,label]) => (
                <button key={m} onClick={()=>setMode(m)} className="modern-button" style={{padding:'1rem 0.5rem',borderRadius:'0.75rem',border:mode===m?'none':'2px solid #e5e7eb',background:mode===m?'#3b82f6':'white',color:mode===m?'white':'#64748b',fontSize:'1.5rem',display:'flex',flexDirection:'column',alignItems:'center',gap:'0.25rem',boxShadow:mode===m?'0 4px 12px rgba(59,130,246,0.3)':'none'}}>
                  <div>{icon}</div>
                  <div style={{fontSize:'0.6875rem',fontWeight:'700'}}>{label}</div>
                </button>
              ))}
            </div>
          </div>

          {mode === "drop-pin" && (
            <div className="stat-card" style={{background:'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)',border:'2px solid #3b82f6',marginBottom:'1rem'}}>
              <label style={{display:'block',fontSize:'0.875rem',fontWeight:'700',marginBottom:'0.75rem',color:'#1e3a8a'}}>üí∞ Lead Type</label>
              <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.5rem',marginBottom:'0.75rem'}}>
                {[['estimate','üí∞','A','#10b981'],['callback','üìû','B','#f59e0b'],['notinterested','üìã','C','#64748b'],['flyer_dropped','üì¨','FD','#3b82f6']].map(([s,icon,display,color]) => (
                  <button key={s} onClick={()=>setStatus(s)} className="modern-button" style={{padding:'0.875rem 0.5rem',borderRadius:'0.75rem',border:status===s?'none':'2px solid #bfdbfe',background:status===s?color:'white',color:status===s?'white':'#64748b',fontSize:'1.5rem',display:'flex',flexDirection:'column',alignItems:'center',gap:'0.25rem',boxShadow:status===s?`0 4px 12px ${color}50`:'none'}}>
                    <div>{icon}</div>
                    <div style={{fontSize:'0.75rem',fontWeight:'700'}}>{display}</div>
                  </button>
                ))}
              </div>
              <input value={note} onChange={e=>setNote(e.target.value)} placeholder="Note (gate code, dog, etc.)" style={{width:'100%',padding:'0.875rem',border:'2px solid #93c5fd',borderRadius:'0.75rem',fontSize:'0.875rem',fontWeight:'600'}} />
            </div>
          )}
        </div>
      )}

      {activeTab === 'stats' && (
        <div className="stat-card">
          <h3 style={{fontSize:'1.125rem',fontWeight:'700',marginBottom:'1rem',color:'#1e293b'}}>üìä Statistics</h3>
          <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem'}}>
            {[
              ['üí∞',stats.estimates,'Estimates','#10b981'],
              ['üìû',stats.callbacks,'Callbacks','#f59e0b'],
              ['üìã',stats.notinterested,'Not Int.','#64748b'],
              ['‚úÖ',stats.verified,'Verified','#10b981'],
              ['üö´',stats.suspicious,'Suspicious','#ef4444'],
              ['üè†',stats.withAddress,'w/ Address','#3b82f6'],
              ['‚ùì',stats.withoutAddress,'No Address','#94a3b8'],
              ['üë•',stats.onlineUsers,'Online','#3b82f6']
            ].map(([icon,count,label,color]) => (
              <div key={label} style={{padding:'1rem',background:`${color}15`,borderRadius:'0.75rem',border:`2px solid ${color}`,textAlign:'center'}}>
                <div style={{fontSize:'2rem',marginBottom:'0.25rem'}}>{icon}</div>
                <div style={{fontSize:'1.75rem',fontWeight:'bold',color:color,marginBottom:'0.25rem'}}>{count}</div>
                <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600'}}>{label}</div>
              </div>
            ))}
          </div>
        </div>
      )}

      {activeTab === 'leaderboard' && <LeaderboardView />}
    </div>
  );

  return (
    <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'#f8fafc'}}>
      {toastMessage && <div className="toast">{toastMessage}</div>}

      {(saving || geocoding) && (
        <div style={{position:'fixed',top:'50%',left:'50%',transform:'translate(-50%,-50%)',background:'white',padding:'2rem 2.5rem',borderRadius:'1.5rem',boxShadow:'0 20px 40px rgba(0,0,0,0.2)',zIndex:10001,display:'flex',flexDirection:'column',gap:'1rem',alignItems:'center'}}>
          <div className="spinner" style={{width:'40px',height:'40px',borderWidth:'4px',borderTopColor:'#3b82f6'}}></div>
          <span style={{fontWeight:'700',fontSize:'1.125rem',color:'#1e293b'}}>{geocoding ? 'üè† Finding Address...' : 'üíæ Saving...'}</span>
        </div>
      )}

      {trackingEnabled && !isMobile && (
        <div style={{position:'fixed',top:'1rem',right:'1rem',background:gpsIsFresh?'#10b981':'#f59e0b',color:'white',padding:'0.875rem 1.5rem',borderRadius:'2rem',boxShadow:'0 6px 16px rgba(0,0,0,0.2)',zIndex:10001,display:'flex',gap:'0.875rem',alignItems:'center',fontSize:'0.9375rem',fontWeight:'700'}}>
          <div style={{width:'14px',height:'14px',background:'white',borderRadius:'50%',animation:'pulse 2s infinite'}}></div>
          <span>GPS {gpsAge !== null ? `${gpsAge}s` : 'Active'} {gpsIsFresh ? '‚úÖ' : '‚ö†Ô∏è'}</span>
        </div>
      )}

      {selectedZone && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10002,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1.5rem',padding:'2rem',maxWidth:'440px',width:'100%',boxShadow:'0 20px 40px rgba(0,0,0,0.3)',animation:'fadeIn 0.3s ease'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem'}}>
              <h3 style={{fontSize:'1.5rem',fontWeight:'bold',color:'#1e293b'}}>{selectedZone.name}</h3>
              <button onClick={() => setSelectedZone(null)} className="modern-button" style={{width:'40px',height:'40px',borderRadius:'50%',border:'none',background:'#f1f5f9',fontSize:'1.5rem',display:'flex',alignItems:'center',justifyContent:'center'}}>√ó</button>
            </div>
            {selectedZone.assigned_to ? (
              <>
                <div style={{padding:'1.25rem',background:'#f0fdf4',borderRadius:'1rem',border:'2px solid #10b981',marginBottom:'1rem'}}>
                  <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                    <div style={{width:'56px',height:'56px',borderRadius:'50%',background:teamMembers.find(u => u.id === selectedZone.assigned_to)?.color || '#64748b',display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.5rem',boxShadow:'0 4px 12px rgba(0,0,0,0.15)'}}>
                      {teamMembers.find(u => u.id === selectedZone.assigned_to)?.name.charAt(0) || '?'}
                    </div>
                    <div>
                      <div style={{fontSize:'0.8125rem',color:'#166534',fontWeight:'700'}}>ASSIGNED TO</div>
                      <div style={{fontWeight:'700',fontSize:'1.25rem',color:'#166534'}}>{teamMembers.find(u => u.id === selectedZone.assigned_to)?.name || 'Unknown'}</div>
                    </div>
                  </div>
                </div>
                {currentUser?.role === 'admin' && (
                  <button onClick={() => unassignZone(selectedZone.id)} className="modern-button" style={{width:'100%',padding:'1rem',background:'#f59e0b',color:'white',border:'none',borderRadius:'1rem',fontWeight:'700',marginBottom:'0.75rem',fontSize:'1rem',boxShadow:'0 4px 12px rgba(245,158,11,0.3)'}}>üîì Unassign Zone</button>
                )}
              </>
            ) : (
              <>
                {currentUser?.role === 'admin' ? (
                  <>
                    <p style={{color:'#64748b',marginBottom:'1rem',fontSize:'0.9375rem',fontWeight:'600'}}>Select a team member to assign this zone:</p>
                    <div style={{marginBottom:'1rem',maxHeight:'320px',overflowY:'auto'}}>
                      {teamMembers.map(member => (
                        <div key={member.id} onClick={() => assignZone(selectedZone.id, member.id)} className="stat-card modern-button" style={{marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'1rem',cursor:'pointer'}}>
                          <div style={{width:'48px',height:'48px',borderRadius:'50%',background:member.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.25rem',boxShadow:'0 2px 8px rgba(0,0,0,0.15)'}}>
                            {member.name.charAt(0)}
                          </div>
                          <div>
                            <div style={{fontWeight:'700',fontSize:'1.0625rem'}}>{member.name}</div>
                            <div style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>{member.role}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </>
                ) : (
                  <div style={{padding:'1.25rem',background:'#fef3c7',borderRadius:'1rem',border:'2px solid #f59e0b',marginBottom:'1rem'}}>
                    <p style={{color:'#92400e',fontSize:'0.9375rem',fontWeight:'600'}}>‚ö†Ô∏è This zone is unassigned. Only admins can assign zones.</p>
                  </div>
                )}
              </>
            )}
            {currentUser?.role === 'admin' && (
              <button onClick={() => deleteZone(selectedZone.id)} className="modern-button" style={{width:'100%',padding:'1rem',background:'#ef4444',color:'white',border:'none',borderRadius:'1rem',fontWeight:'700',marginBottom:'0.75rem',fontSize:'1rem',boxShadow:'0 4px 12px rgba(239,68,68,0.3)'}}>üóëÔ∏è Delete Zone</button>
            )}
            <button onClick={() => setSelectedZone(null)} className="modern-button" style={{width:'100%',padding:'1rem',background:'#e5e7eb',color:'#1e293b',border:'none',borderRadius:'1rem',fontWeight:'700',fontSize:'1rem'}}>Close</button>
          </div>
        </div>
      )}

      {!currentUser && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10000,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1.5rem',padding:'2rem',maxWidth:'440px',width:'100%',maxHeight:'80vh',overflowY:'auto',boxShadow:'0 20px 40px rgba(0,0,0,0.3)'}}>
            <h2 style={{fontSize:'1.75rem',fontWeight:'bold',marginBottom:'0.75rem',color:'#1e293b'}}>üëã Select Your Profile</h2>
            <p style={{color:'#64748b',marginBottom:'1.5rem',fontSize:'0.9375rem',fontWeight:'600'}}>Choose your name to start tracking</p>
            <div style={{marginBottom:'1rem'}}>
              {teamMembers.map(member => (
                <div key={member.id} className="stat-card" style={{marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'1rem',position:'relative'}}>
                  <div onClick={() => selectCurrentUser(member)} className="modern-button" style={{flex:1,display:'flex',alignItems:'center',gap:'1rem',cursor:'pointer'}}>
                    <div style={{width:'56px',height:'56px',borderRadius:'50%',background:member.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.5rem',flexShrink:0,boxShadow:'0 4px 12px rgba(0,0,0,0.15)'}}>
                      {member.name.charAt(0)}
                    </div>
                    <div>
                      <div style={{fontWeight:'700',fontSize:'1.125rem',color:'#1e293b'}}>{member.name}</div>
                      <div style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>{member.role}</div>
                    </div>
                  </div>
                  <div style={{position:'relative'}}>
                    <button onClick={() => setEditingUser(editingUser?.id === member.id ? null : member)} className="modern-button" style={{padding:'0.625rem',background:'#f1f5f9',border:'none',borderRadius:'0.75rem',fontSize:'1.5rem'}}>‚ãÆ</button>
                    {editingUser?.id === member.id && (
                      <div style={{position:'absolute',right:0,top:'100%',marginTop:'0.75rem',background:'white',border:'2px solid #e5e7eb',borderRadius:'1rem',padding:'0.75rem',minWidth:'180px',boxShadow:'0 10px 25px rgba(0,0,0,0.15)',zIndex:10,animation:'fadeIn 0.2s ease'}}>
                        <button onClick={() => updateUserRole(member.id, member.role === 'admin' ? 'rep' : 'admin')} className="modern-button" style={{width:'100%',padding:'0.875rem',background:member.role==='admin'?'#f59e0b':'#3b82f6',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',marginBottom:'0.625rem',fontSize:'0.9375rem',boxShadow:`0 2px 8px ${member.role==='admin'?'rgba(245,158,11,0.3)':'rgba(59,130,246,0.3)'}`}}>{member.role === 'admin' ? 'üë§ Make Rep' : '‚≠ê Make Admin'}</button>
                        <button onClick={() => deleteUser(member.id)} className="modern-button" style={{width:'100%',padding:'0.875rem',background:'#ef4444',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.9375rem',boxShadow:'0 2px 8px rgba(239,68,68,0.3)'}}>üóëÔ∏è Delete</button>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
            <button onClick={() => setShowUserModal(true)} className="modern-button" style={{width:'100%',padding:'1rem',background:'#3b82f6',color:'white',border:'none',borderRadius:'1rem',fontWeight:'700',fontSize:'1rem',boxShadow:'0 4px 12px rgba(59,130,246,0.3)'}}>‚ûï Add New Member</button>
          </div>
        </div>
      )}

      {showUserModal && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10002,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1.5rem',padding:'2rem',maxWidth:'440px',width:'100%',boxShadow:'0 20px 40px rgba(0,0,0,0.3)',animation:'fadeIn 0.3s ease'}}>
            <h3 style={{fontSize:'1.5rem',fontWeight:'bold',marginBottom:'1.5rem',color:'#1e293b'}}>‚ûï Add Team Member</h3>
            <input value={newUserName} onChange={e => setNewUserName(e.target.value)} placeholder="Full Name" style={{width:'100%',padding:'1rem',border:'2px solid #e5e7eb',borderRadius:'1rem',marginBottom:'1rem',fontSize:'1rem',fontWeight:'600'}} onKeyPress={e => e.key === 'Enter' && addTeamMember()}/>
            <select value={newUserRole} onChange={e => setNewUserRole(e.target.value)} style={{width:'100%',padding:'1rem',border:'2px solid #e5e7eb',borderRadius:'1rem',marginBottom:'1.5rem',fontSize:'1rem',fontWeight:'600'}}>
              <option value="rep">üë§ Rep</option>
              <option value="admin">‚≠ê Admin</option>
            </select>
            <div style={{display:'flex',gap:'0.75rem'}}>
              <button onClick={addTeamMember} className="modern-button" style={{flex:1,padding:'1rem',background:'#3b82f6',color:'white',border:'none',borderRadius:'1rem',fontWeight:'700',fontSize:'1rem',boxShadow:'0 4px 12px rgba(59,130,246,0.3)'}}>Add Member</button>
              <button onClick={() => {setShowUserModal(false); setNewUserName(""); setNewUserRole("rep");}} className="modern-button" style={{flex:1,padding:'1rem',background:'#e5e7eb',color:'#1e293b',border:'none',borderRadius:'1rem',fontWeight:'700',fontSize:'1rem'}}>Cancel</button>
            </div>
          </div>
        </div>
      )}

      {isMobile && (
        <>
          <button className={`hamburger-btn ${mobileMenuOpen ? 'open' : ''}`} onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
            <span></span>
            <span></span>
            <span></span>
          </button>
          <div className={`mobile-dropdown ${mobileMenuOpen ? 'open' : ''}`}>
            <MobileDropdownContent />
          </div>
        </>
      )}

      <div style={{display:'flex',height:'100%',gap:isMobile?0:'1rem',padding:isMobile?0:'1rem'}}>
        {!isMobile && (
          <div className="desktop-sidebar" style={{width:'420px',background:'white',borderRadius:'1rem',boxShadow:'0 4px 12px rgba(0,0,0,0.08)',flexDirection:'column',overflow:'hidden',border:'1px solid #e5e7eb'}}>
            <div style={{padding:'1.75rem',borderBottom:'1px solid #e5e7eb',background:'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'}}>
              <h1 style={{fontSize:'2rem',fontWeight:'bold',marginBottom:'0.5rem',color:'white',textShadow:'0 2px 4px rgba(0,0,0,0.1)'}}>üè† RepZone</h1>
              <p style={{color:'rgba(255,255,255,0.9)',fontSize:'0.875rem',fontWeight:'600'}}>Door Knocking Tracker</p>
            </div>
            
            {currentUser && (
              <div style={{padding:'1.25rem',borderBottom:'1px solid #e5e7eb'}}>
                <div className="stat-card" style={{background:`${currentUser.color}15`,border:`2px solid ${currentUser.color}`,display:'flex',alignItems:'center',gap:'1rem'}}>
                  <div style={{width:'56px',height:'56px',borderRadius:'50%',background:currentUser.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.5rem',flexShrink:0,boxShadow:'0 4px 12px rgba(0,0,0,0.15)'}}>
                    {currentUser.name.charAt(0)}
                  </div>
                  <div style={{flex:1}}>
                    <div style={{fontWeight:'700',fontSize:'1.0625rem',color:'#1e293b'}}>{currentUser.name}</div>
                    <div style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>{currentUser.role}</div>
                  </div>
                  <button onClick={() => setCurrentUser(null)} className="modern-button" style={{padding:'0.625rem 1rem',fontSize:'0.8125rem',background:'white',border:'1px solid #e5e7eb',borderRadius:'0.75rem',fontWeight:'700',boxShadow:'0 2px 4px rgba(0,0,0,0.06)'}}>Switch</button>
                </div>
              </div>
            )}

            <div style={{display:'flex',borderBottom:'2px solid #e5e7eb'}}>
              {[['map','üó∫Ô∏è Map'],['leaderboard','üèÜ Stats']].map(([tab,label]) => (
                <button key={tab} onClick={() => setActiveTab(tab === 'map' ? 'controls' : 'leaderboard')} className={`tab ${(tab === 'map' && activeTab === 'controls') || activeTab === tab ? 'active' : ''}`} style={{flex:1,textAlign:'center'}}>{label}</button>
              ))}
            </div>

            <div style={{flex:1,overflowY:'auto',padding:'1.25rem'}}>
              {activeTab === 'controls' && (
                <>
                  {/* üîç DESKTOP ADDRESS SEARCH */}
                  {mode === "drop-pin" && (
                    <div className="stat-card" style={{marginBottom:'1.25rem',background:'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',border:'2px solid #3b82f6'}}>
                      <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.875rem',color:'#1e3a8a'}}>üîç Search Address</label>
                      <div style={{position:'relative'}}>
                        <input 
                          value={addressSearch} 
                          onChange={e => setAddressSearch(e.target.value)} 
                          placeholder="Type address to find location..."
                          style={{width:'100%',padding:'0.875rem',paddingRight:'2.5rem',border:'2px solid #93c5fd',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}
                        />
                        {searching && (
                          <div style={{position:'absolute',right:'0.75rem',top:'50%',transform:'translateY(-50%)'}}>
                            <div className="spinner" style={{width:'20px',height:'20px',borderWidth:'2px'}}></div>
                          </div>
                        )}
                      </div>
                      {searchResults.length > 0 && (
                        <div style={{marginTop:'0.75rem',maxHeight:'250px',overflowY:'auto',background:'white',borderRadius:'0.75rem',border:'2px solid #93c5fd'}}>
                          {searchResults.map((result, idx) => (
                            <div 
                              key={idx} 
                              onClick={() => selectSearchResult(result)}
                              className="modern-button"
                              style={{padding:'1rem',borderBottom:idx < searchResults.length - 1 ? '1px solid #e0f2fe' : 'none',cursor:'pointer',transition:'background 0.2s'}}
                              onMouseEnter={e => e.currentTarget.style.background = '#f0f9ff'}
                              onMouseLeave={e => e.currentTarget.style.background = 'white'}
                            >
                              <div style={{fontSize:'0.9375rem',fontWeight:'600',color:'#1e293b',marginBottom:'0.375rem'}}>
                                üìç {result.displayName.split(',')[0]}
                              </div>
                              <div style={{fontSize:'0.8125rem',color:'#64748b',lineHeight:'1.4'}}>
                                {result.displayName}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}

                  <div className="stat-card" style={{marginBottom:'1.25rem',background:trackingEnabled?'#dcfce7':'#fee2e2',border:`2px solid ${trackingEnabled?'#10b981':'#ef4444'}`}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
                      <b style={{fontSize:'0.9375rem',fontWeight:'700'}}>üìç GPS Tracking</b>
                      <button onClick={() => trackingEnabled ? stopLocationTracking() : requestLocationPermission(currentUser)} className="modern-button" style={{padding:'0.625rem 1.25rem',background:trackingEnabled?'#ef4444':'#10b981',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.8125rem',boxShadow:`0 2px 8px ${trackingEnabled?'rgba(239,68,68,0.3)':'rgba(16,185,129,0.3)'}`}}>{trackingEnabled ? 'Stop' : 'Start'}</button>
                    </div>
                    <p style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>
                      {trackingEnabled ? (
                        gpsAge !== null ? `‚úÖ Active - GPS is ${gpsAge}s old ${gpsIsFresh ? '(Fresh ‚úÖ)' : '(Stale ‚ö†Ô∏è)'}` : '‚úÖ Location tracking active'
                      ) : '‚ö†Ô∏è Enable to verify pin locations'}
                    </p>
                  </div>

                  {currentUser?.role === 'admin' && (
                    <div className="stat-card" style={{marginBottom:'1.25rem',background:'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',border:'2px solid #3b82f6'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                        <b style={{fontSize:'0.9375rem',fontWeight:'700',color:'#1e3a8a'}}>üë• Team Management</b>
                      </div>
                      <p style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600',marginBottom:'0.75rem'}}>Add new team members to your organization</p>
                      <button onClick={() => setShowUserModal(true)} className="modern-button" style={{width:'100%',padding:'0.875rem',background:'#3b82f6',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.875rem',boxShadow:'0 2px 8px rgba(59,130,246,0.3)'}}>‚ûï Add Team Member</button>
                    </div>
                  )}

                  <div className="stat-card" style={{marginBottom:'1.25rem'}}>
                    <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.75rem',color:'#1e293b'}}>üéØ Mode</label>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'0.75rem'}}>
                      {[['drop-pin','üìç Pin'],['draw-zone','‚úèÔ∏è Zone'],['select','üëÜ Select']].map(([m,label]) => (
                        <button key={m} onClick={()=>setMode(m)} className="modern-button" style={{padding:'1rem 0.75rem',borderRadius:'0.75rem',border:mode===m?'none':'2px solid #e5e7eb',background:mode===m?'#3b82f6':'white',color:mode===m?'white':'#64748b',fontSize:'0.9375rem',fontWeight:'700',boxShadow:mode===m?'0 4px 12px rgba(59,130,246,0.3)':'none'}}>{label}</button>
                      ))}
                    </div>
                    {mode === "draw-zone" && currentUser?.role !== 'admin' && (
                      <p style={{fontSize:'0.8125rem',color:'#ef4444',marginTop:'0.75rem',fontWeight:'700'}}>‚ö†Ô∏è Only admins can create zones</p>
                    )}
                    {mode === "select" && (
                      <p style={{fontSize:'0.8125rem',color:'#64748b',marginTop:'0.75rem',fontWeight:'600'}}>üí° Click on a zone to assign or delete it</p>
                    )}
                    {mode === "drop-pin" && (
                      <p style={{fontSize:'0.8125rem',color:'#10b981',marginTop:'0.75rem',fontWeight:'700'}}>‚úÖ Click map - gets full address!</p>
                    )}
                  </div>

                  {mode === "drop-pin" && (
                    <div className="stat-card" style={{background:'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)',border:'2px solid #3b82f6',marginBottom:'1.25rem'}}>
                      <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.875rem',color:'#1e3a8a'}}>üí∞ Lead Type</label>
                      <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem',marginBottom:'1rem'}}>
                        {[['estimate','üí∞','A','#10b981'],['callback','üìû','B','#f59e0b'],['notinterested','üìã','C','#64748b'],['flyer_dropped','üì¨','FD','#3b82f6']].map(([s,icon,display,color]) => (
                          <button key={s} onClick={()=>setStatus(s)} className="modern-button" style={{padding:'1rem',borderRadius:'0.75rem',border:status===s?'none':'2px solid #bfdbfe',background:status===s?color:'white',color:status===s?'white':'#64748b',fontSize:'1.75rem',display:'flex',flexDirection:'column',alignItems:'center',gap:'0.375rem',boxShadow:status===s?`0 4px 12px ${color}50`:'none'}}>
                            <div>{icon}</div>
                            <div style={{fontSize:'0.8125rem',fontWeight:'700'}}>{display}</div>
                          </button>
                        ))}
                      </div>
                      <input value={note} onChange={e=>setNote(e.target.value)} placeholder="Note (gate code, dog, etc.)" style={{width:'100%',padding:'0.875rem',border:'2px solid #93c5fd',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}} />
                      {!trackingEnabled && (
                        <p style={{marginTop:'0.75rem',fontSize:'0.8125rem',color:'#ef4444',fontWeight:'700'}}>‚ö†Ô∏è Enable GPS tracking to verify pin locations</p>
                      )}
                      {trackingEnabled && !gpsIsFresh && (
                        <p style={{marginTop:'0.75rem',fontSize:'0.8125rem',color:'#f59e0b',fontWeight:'700'}}>‚ö†Ô∏è GPS data is stale - walk around to refresh</p>
                      )}
                    </div>
                  )}

                  <div className="stat-card">
                    <h3 style={{fontSize:'1.0625rem',fontWeight:'700',marginBottom:'1rem',color:'#1e293b'}}>üìä Quick Stats</h3>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem'}}>
                      {[
                        ['üí∞',stats.estimates,'Estimates','#10b981'],
                        ['üìû',stats.callbacks,'Callbacks','#f59e0b'],
                        ['‚úÖ',stats.verified,'Verified','#10b981'],
                        ['üö´',stats.suspicious,'Suspicious','#ef4444']
                      ].map(([icon,count,label,color]) => (
                        <div key={label} style={{padding:'1rem',background:`${color}15`,borderRadius:'0.75rem',border:`2px solid ${color}`,textAlign:'center'}}>
                          <div style={{fontSize:'1.75rem',marginBottom:'0.375rem'}}>{icon}</div>
                          <div style={{fontSize:'1.75rem',fontWeight:'bold',color:color,marginBottom:'0.25rem'}}>{count}</div>
                          <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'700'}}>{label}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                </>
              )}

              {activeTab === 'leaderboard' && <LeaderboardView />}
            </div>
          </div>
        )}

        <div style={{flex:1,borderRadius:isMobile?0:'1rem',overflow:'hidden',boxShadow:isMobile?'none':'0 4px 12px rgba(0,0,0,0.08)',position:'relative',border:isMobile?'none':'1px solid #e5e7eb'}}>
          <div ref={mapRef} style={{height:'100%',width:'100%'}}></div>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<RepZoneApp />);
</script>
</body>
</html>
