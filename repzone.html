<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>RepZone Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://sea.refinedpainting.co/js/form_embed.js" type="text/javascript"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif; }
  #map { height: 100% !important; width: 100% !important; }
  
  .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
  @keyframes progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
  
  .tracking-indicator { animation: pulse 2s infinite; }
  .tab { padding: 0.875rem 1.25rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; transition: all 0.3s; font-size: 0.9375rem; }
  .tab.active { border-bottom-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
  .tab:hover { background: #f1f5f9; }
  .toast { position: fixed; top: 5rem; right: 1rem; background: white; padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 10001; animation: slideIn 0.3s ease; max-width: 400px; border-left: 4px solid #3b82f6; }
  
  .stat-card {
    background: white;
    border-radius: 1rem;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s;
    border: 1px solid #e5e7eb;
  }
  
  .stat-card:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  
  .modern-button {
    transition: all 0.2s;
    font-weight: 600;
    cursor: pointer;
  }
  
  .modern-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .modern-button:active {
    transform: translateY(0);
  }
  
  .loading-shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 1000px 100%;
    animation: shimmer 2s infinite;
  }
  
  .hamburger-btn {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    width: 54px;
    height: 54px;
    background: white;
    border: none;
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 1002;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.3s;
  }
  
  .hamburger-btn:hover {
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  }
  
  .hamburger-btn span {
    width: 26px;
    height: 3px;
    background: #1e293b;
    border-radius: 2px;
    transition: all 0.3s;
  }
  
  .hamburger-btn.open span:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
  }
  
  .hamburger-btn.open span:nth-child(2) {
    opacity: 0;
  }
  
  .hamburger-btn.open span:nth-child(3) {
    transform: rotate(-45deg) translate(6px, -6px);
  }
  
  .mobile-dropdown {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: white;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
    z-index: 1001;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .mobile-dropdown.open {
    max-height: 85vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .desktop-sidebar {
    display: flex;
  }
  
  @media (max-width: 768px) {
    .hamburger-btn {
      display: flex;
    }
    
    .mobile-dropdown {
      display: block;
    }
    
    .desktop-sidebar {
      display: none !important;
    }
    
    .toast {
      left: 1rem;
      right: 1rem;
      top: 1rem;
    }
  }
  
  @media (min-width: 769px) {
    .hamburger-btn {
      display: none !important;
    }
    
    .mobile-dropdown {
      display: none !important;
    }
    
    .desktop-sidebar {
      display: flex !important;
    }
  }
  
  ::-webkit-scrollbar {
    width: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>
</head>
<body>
<div id="root"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  window.initGoogleMaps = function() {
    console.log('‚úÖ Google Maps loaded successfully');
    window.googleMapsReady = true;
    if (window.startRepZoneApp) {
      window.startRepZoneApp();
    }
  };
  
  window.gm_authFailure = function() {
    console.error('‚ùå Google Maps API authentication failed');
    alert('Google Maps API Error: Please check your API key configuration.\n\n1. Go to Google Cloud Console\n2. Enable the Maps JavaScript API\n3. Add your domain to API key restrictions\n4. Current domain: ' + window.location.hostname);
  };
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxqGzPnCxZNpH3Xopsk4VnwZOxVLjSQWc&libraries=places,geometry&callback=initGoogleMaps&loading=async" onerror="alert('Failed to load Google Maps. Check your internet connection and API key.')"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SUPABASE_URL = 'https://cytikhfyygkovnjtpsth.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dGlraGZ5eWdrb3ZuanRwc3RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTc3NzYsImV4cCI6MjA3NjI5Mzc3Nn0.ItJObIXo_Ks8TEigj5RkUA4vXbze_3FMMIzYyVHrthQ';

const COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];

const LEAD_TYPES = {
  estimate: { icon: 'üí∞', label: 'A - Estimate', color: '#10b981', display: 'A' },
  callback: { icon: 'üìû', label: 'B - Callback 1-2 Weeks', color: '#f59e0b', display: 'B' },
  notinterested: { icon: 'üìã', label: 'C - Not Interested (Has Info)', color: '#64748b', display: 'C' },
  flyer: { icon: 'üì¨', label: 'FD - Flyer Drop', color: '#3b82f6', display: 'FD' },
  knocked: { icon: '‚úÖ', label: 'Knocked', color: '#16a34a', display: '‚úÖ' },
  skipped: { icon: '‚è≠Ô∏è', label: 'Skipped', color: '#ef4444', display: '‚è≠Ô∏è' }
};

const GPS_MAX_AGE_MS = 30000;

const GHL_CONFIG = {
  apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6ImVuMmQ4Q2FxR0Q4YTNTRU1WRkhaIiwidmVyc2lvbiI6MSwiaWF0IjoxNzUyODYxNDIyMzU2LCJzdWIiOiJuMGFvVnBNQlJ1TjRKSGJEUWJXeiJ9.AZc26Y3MqBK8SUdc8PyufVwrUsrS7kac1mnAhFJDlHA',
  locationId: 'en2d8CaqGD8a3SEMVFHz',
  calendarUrls: {
    onsite: 'https://sea.refinedpainting.co/widget/bookings/onsiteestimates',
    general: 'https://sea.refinedpainting.co/widget/booking/fIYuXbwwo4XQh3nyLxj8'
  }
};

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180, œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180, ŒîŒª = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c * 3.28084;
}

function getVerificationStatus(distance) {
  if (distance <= 50) return { status: 'verified', color: '#10b981', icon: '‚úÖ', label: 'Verified' };
  if (distance <= 150) return { status: 'questionable', color: '#f59e0b', icon: '‚ö†Ô∏è', label: 'Questionable' };
  return { status: 'suspicious', color: '#ef4444', icon: 'üö´', label: 'Suspicious' };
}

function isGPSFresh(location) {
  if (!location || !location.timestamp) return false;
  return (Date.now() - location.timestamp) < GPS_MAX_AGE_MS;
}

function getGPSAge(location) {
  if (!location || !location.timestamp) return null;
  return Math.floor((Date.now() - location.timestamp) / 1000);
}

async function sendContactToGHL(contactData) {
  try {
    const response = await fetch('https://rest.gohighlevel.com/v1/contacts/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${GHL_CONFIG.apiKey}`,
        'Content-Type': 'application/json',
        'Version': '2021-07-28'
      },
      body: JSON.stringify({
        locationId: GHL_CONFIG.locationId,
        firstName: contactData.name?.split(' ')[0] || contactData.name,
        lastName: contactData.name?.split(' ').slice(1).join(' ') || '',
        name: contactData.name,
        email: contactData.email || '',
        phone: contactData.phone || '',
        address1: contactData.address || '',
        tags: ['Door-to-Door', contactData.leadType || 'Unknown', contactData.verified ? 'GPS-Verified' : 'Unverified'],
        source: 'RepZone App',
        customField: {
          rep_name: contactData.repName,
          lead_type: contactData.leadType,
          gps_distance: contactData.distance,
          pin_created_at: contactData.createdAt
        }
      })
    });
    if (!response.ok) throw new Error(`GHL API error: ${response.status}`);
    return await response.json();
  } catch (error) {
    console.error('‚ùå GHL error:', error);
    throw error;
  }
}

function openGHLCalendar(customerName, customerEmail, customerPhone, address) {
  window.showCalendarModal({ name: customerName || '', email: customerEmail || '', phone: customerPhone || '', address: address || '' });
}

function RepZoneApp() {
  const [pins, setPins] = useState([]);
  const [routes, setRoutes] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [liveLocations, setLiveLocations] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentLocation, setCurrentLocation] = useState(null);
  const [mode, setMode] = useState("drop-pin");
  const [status, setStatus] = useState("estimate");
  const [note, setNote] = useState("");
  const [activeTab, setActiveTab] = useState("map");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [mapReady, setMapReady] = useState(false);
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [trackingEnabled, setTrackingEnabled] = useState(false);
  const [toastMessage, setToastMessage] = useState(null);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [geocoding, setGeocoding] = useState(false);
  const [showCustomerForm, setShowCustomerForm] = useState(false);
  const [customerName, setCustomerName] = useState('');
  const [customerPhone, setCustomerPhone] = useState('');
  const [customerEmail, setCustomerEmail] = useState('');
  const [customerNote, setCustomerNote] = useState('');
  const [showCalendarModal, setShowCalendarModal] = useState(false);
  const [calendarData, setCalendarData] = useState(null);
  const [pendingPinLocation, setPendingPinLocation] = useState(null);
  const [fdMode, setFdMode] = useState(false);
  
  // NEW: Route & CRM states
  const [routeMode, setRouteMode] = useState(false);
  const [currentRoute, setCurrentRoute] = useState(null);
  const [routePoints, setRoutePoints] = useState([]);
  const [showRouteModal, setShowRouteModal] = useState(false);
  const [routeName, setRouteName] = useState('');
  const [showCRM, setShowCRM] = useState(false);
  const [crmFilter, setCrmFilter] = useState('all');
  const [crmSearch, setCrmSearch] = useState('');

  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const supabase = useRef(null);
  const locationWatchId = useRef(null);
  const locationUpdateInterval = useRef(null);
  const markersRef = useRef([]);
  const userMarkerRef = useRef(null);
  const searchBoxRef = useRef(null);
  const routePolylineRef = useRef(null);

  function showToast(message, duration = 4000) {
    setToastMessage(message);
    setTimeout(() => setToastMessage(null), duration);
  }

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    supabase.current = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    loadData();
    
    const saved = localStorage.getItem('current_user_id');
    if (saved) {
      try {
        const user = JSON.parse(saved);
        setCurrentUser(user);
        requestLocationPermission(user);
      } catch (e) {
        console.error('Error parsing saved user:', e);
      }
    }
  }, []);

  useEffect(() => {
    if (!supabase.current) return;
    loadLiveLocations();
    const interval = setInterval(loadLiveLocations, 10000);
    return () => clearInterval(interval);
  }, []);

  async function loadLiveLocations() {
    try {
      const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      const { data, error } = await supabase.current.from('live_locations').select('*').gte('last_updated', fiveMinutesAgo).eq('is_active', true);
      if (!error && data) setLiveLocations(data);
    } catch (e) {
      console.error('Error loading live locations:', e);
    }
  }

  function requestLocationPermission(user) {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      () => startLocationTracking(user),
      (error) => console.error('GPS permission error:', error)
    );
  }

  function startLocationTracking(user) {
    if (!user || locationWatchId.current) return;
    setTrackingEnabled(true);
    locationWatchId.current = navigator.geolocation.watchPosition(
      (position) => {
        setCurrentLocation({
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: Date.now()
        });
      },
      () => {},
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
    );
    locationUpdateInterval.current = setInterval(() => {
      if (currentLocation && user) updateLiveLocation(user.id, currentLocation);
    }, 30000);
  }

  function stopLocationTracking() {
    if (locationWatchId.current) {
      navigator.geolocation.clearWatch(locationWatchId.current);
      locationWatchId.current = null;
    }
    if (locationUpdateInterval.current) {
      clearInterval(locationUpdateInterval.current);
      locationUpdateInterval.current = null;
    }
    setTrackingEnabled(false);
    if (currentUser) updateLiveLocationInactive(currentUser.id);
  }

  async function updateLiveLocation(userId, location) {
    try {
      await supabase.current.from('live_locations').upsert({
        team_member_id: userId,
        lat: location.lat,
        lng: location.lng,
        accuracy: location.accuracy,
        last_updated: new Date().toISOString(),
        is_active: true
      }, { onConflict: 'team_member_id' });
      loadLiveLocations();
    } catch (e) {}
  }

  async function updateLiveLocationInactive(userId) {
    try {
      await supabase.current.from('live_locations').update({ is_active: false }).eq('team_member_id', userId);
    } catch (e) {}
  }

  useEffect(() => {
    if (currentLocation && currentUser && trackingEnabled) {
      updateLiveLocation(currentUser.id, currentLocation);
    }
  }, [currentLocation, currentUser, trackingEnabled]);

  useEffect(() => () => stopLocationTracking(), []);

  async function loadData() {
    try {
      const [pinsRes, teamRes, routesRes] = await Promise.all([
        supabase.current.from('pins').select('*'),
        supabase.current.from('team_members').select('*'),
        supabase.current.from('routes').select('*')
      ]);
      setPins(pinsRes.data || []);
      setTeamMembers(teamRes.data || []);
      setRoutes(routesRes.data || []);
    } catch (e) {
      console.error('Load error:', e);
    }
    setLoading(false);
  }

  useEffect(() => {
    if (!mapRef.current || mapInstanceRef.current || loading) return;
    
    const waitForGoogle = () => {
      if (window.google && window.google.maps) {
        initMap();
      } else {
        setTimeout(waitForGoogle, 100);
      }
    };
    
    window.startRepZoneApp = waitForGoogle;
    if (window.googleMapsReady) {
      waitForGoogle();
    }
  }, [loading]);

  function initMap() {
    if (!mapRef.current || mapInstanceRef.current || !window.google) return;

    const map = new google.maps.Map(mapRef.current, {
      center: { lat: 47.6062, lng: -122.3321 },
      zoom: isMobile ? 12 : 13,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
      zoomControl: true,
      styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
    });

    mapInstanceRef.current = map;

    if (currentLocation) {
      map.setCenter({ lat: currentLocation.lat, lng: currentLocation.lng });
      map.setZoom(16);
    } else if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          map.setCenter({ lat: position.coords.latitude, lng: position.coords.longitude });
          map.setZoom(16);
        },
        () => {}
      );
    }

    map.addListener('click', (e) => {
      if (!currentUser) return;
      
      if (!currentLocation) {
        showToast('‚ö†Ô∏è Enable GPS tracking first!');
        return;
      }

      if (!isGPSFresh(currentLocation)) {
        const age = getGPSAge(currentLocation);
        showToast(`‚ö†Ô∏è GPS data is ${age}s old! Move around to get fresh GPS signal.`, 6000);
        return;
      }

      if (fdMode) {
        dropPinAtLocation(e.latLng.lat(), e.latLng.lng(), '', '', '', '');
      } else {
        setPendingPinLocation({ lat: e.latLng.lat(), lng: e.latLng.lng() });
        setShowCustomerForm(true);
      }
    });

    if (searchBoxRef.current) {
      const searchBox = new google.maps.places.SearchBox(searchBoxRef.current);
      map.addListener('bounds_changed', () => searchBox.setBounds(map.getBounds()));
      searchBox.addListener('places_changed', () => {
        const places = searchBox.getPlaces();
        if (places.length === 0) return;
        const place = places[0];
        if (!place.geometry || !place.geometry.location) return;
        map.setCenter(place.geometry.location);
        map.setZoom(17);
      });
    }

    setTimeout(() => {
      map.setCenter(map.getCenter());
      setMapReady(true);
    }, 300);
  }

  // NEW: Route Functions
  function addRoutePoint(lat, lng) {
    const newPoint = { lat, lng, order: routePoints.length };
    setRoutePoints(prev => [...prev, newPoint]);
    drawRoute([...routePoints, newPoint]);
    showToast(`üìç Point ${routePoints.length + 1} added`);
  }

  function drawRoute(points) {
    if (!mapInstanceRef.current || points.length < 1) return;

    if (routePolylineRef.current) {
      routePolylineRef.current.setMap(null);
    }

    const routeColor = currentUser?.color || '#3b82f6';

    if (points.length >= 2) {
      const path = points.map(p => ({ lat: p.lat, lng: p.lng }));
      
      routePolylineRef.current = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: routeColor,
        strokeOpacity: 1.0,
        strokeWeight: 4,
        map: mapInstanceRef.current
      });
    }

    points.forEach((point, idx) => {
      new google.maps.Marker({
        position: { lat: point.lat, lng: point.lng },
        map: mapInstanceRef.current,
        label: {
          text: `${idx + 1}`,
          color: 'white',
          fontSize: '14px',
          fontWeight: 'bold'
        },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 20,
          fillColor: routeColor,
          fillOpacity: 1,
          strokeColor: 'white',
          strokeWeight: 3
        }
      });
    });
  }

  async function saveRoute() {
    if (!routeName || routePoints.length < 2) {
      showToast('‚ö†Ô∏è Enter route name and add at least 2 points');
      return;
    }

    try {
      const newRoute = {
        name: routeName,
        points: routePoints,
        team_member_id: currentUser?.id || null,
        created_at: new Date().toISOString()
      };

      const { error } = await supabase.current.from('routes').insert([newRoute]);

      if (error) throw error;

      showToast('‚úÖ Route saved!');
      setRouteMode(false);
      setRoutePoints([]);
      setRouteName('');
      setShowRouteModal(false);
      if (routePolylineRef.current) {
        routePolylineRef.current.setMap(null);
      }
      loadData();
    } catch (e) {
      showToast('‚ùå Error saving route: ' + e.message);
    }
  }

  function clearRoute() {
    setRoutePoints([]);
    setRouteName('');
    if (routePolylineRef.current) {
      routePolylineRef.current.setMap(null);
    }
    showToast('Route cleared');
  }

  async function deleteRoute(routeId) {
    if (!confirm('Delete this route?')) return;
    try {
      await supabase.current.from('routes').delete().eq('id', routeId);
      setRoutes(prev => prev.filter(r => r.id !== routeId));
      showToast('‚úÖ Route deleted!');
    } catch (e) {
      showToast('‚ùå Error deleting route');
    }
  }

  function viewRoute(route) {
    if (!mapInstanceRef.current || !route.points) return;
    
    drawRoute(route.points);
    
    const bounds = new google.maps.LatLngBounds();
    route.points.forEach(p => bounds.extend({ lat: p.lat, lng: p.lng }));
    mapInstanceRef.current.fitBounds(bounds);
    
    showToast(`üìç Viewing: ${route.name}`);
  }

  async function dropPinAtLocation(lat, lng, custName, custPhone, custEmail, custNote) {
    setSaving(true);
    setGeocoding(true);

    try {
      const geocoder = new google.maps.Geocoder();
      const result = await new Promise((resolve) => {
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
          if (status === 'OK' && results[0]) {
            resolve(results[0].formatted_address);
          } else {
            resolve(null);
          }
        });
      });

      const address = result;
      const shortAddress = result ? result.split(',')[0] : 'Location';

      if (address) {
        showToast(`üìç Found: ${shortAddress}`, 3000);
      } else {
        showToast('‚ö†Ô∏è No address found - saving location anyway', 3000);
      }

      const distance = calculateDistance(currentLocation.lat, currentLocation.lng, lat, lng);
      const verification = getVerificationStatus(distance);

      let finalNote = note || null;
      if (custName) {
        let noteParts = `${custName}${custEmail ? ' - ' + custEmail : ''}${custPhone ? ' - ' + custPhone : ''}`;
        if (custNote || note) {
          noteParts += ' | ' + [custNote, note].filter(Boolean).join(' | ');
        }
        finalNote = noteParts;
      }

      const newPin = {
        id: `pin-${Date.now()}`,
        lat,
        lng,
        status,
        address,
        rep_name: currentUser.name,
        team_member_id: currentUser.id,
        note: finalNote,
        actual_lat: currentLocation.lat,
        actual_lng: currentLocation.lng,
        distance_from_pin: Math.round(distance),
        verification_status: verification.status,
        route_id: currentRoute?.id || null,
        created_at: new Date().toISOString()
      };

      const { error } = await supabase.current.from('pins').insert([newPin]).select();

      if (error) {
        showToast('‚ùå Error saving pin: ' + error.message);
      } else {
        setPins(prev => [...prev, newPin]);
        setNote("");
        const leadTypeLabel = LEAD_TYPES[status]?.label || status;
        const custInfo = custName ? ` for ${custName}` : '';

        if (custName && (custEmail || custPhone)) {
          try {
            await sendContactToGHL({
              name: custName,
              email: custEmail,
              phone: custPhone,
              address,
              leadType: leadTypeLabel,
              repName: currentUser.name,
              verified: verification.status === 'verified',
              distance: Math.round(distance),
              createdAt: newPin.created_at
            });
            showToast('‚úÖ Contact added to GHL!', 3000);
          } catch (ghlError) {
            console.error('GHL sync failed:', ghlError);
            showToast('‚ö†Ô∏è Pin saved but GHL sync failed', 3000);
          }
        }

        if (verification.status === 'verified') {
          showToast(`‚úÖ ${leadTypeLabel}${custInfo} at ${shortAddress}! (${Math.round(distance)}ft)`, 5000);
        } else if (verification.status === 'suspicious') {
          showToast(`‚ö†Ô∏è ${leadTypeLabel}${custInfo} saved but ${Math.round(distance)}ft away - marked suspicious`, 5000);
        } else {
          showToast(`‚ö†Ô∏è ${leadTypeLabel}${custInfo} saved (${Math.round(distance)}ft - questionable)`, 5000);
        }

        addMarkerToMap(newPin);
      }
    } catch (error) {
      showToast('‚ùå Error: ' + error.message);
    }

    setSaving(false);
    setGeocoding(false);
  }

  function addMarkerToMap(pin) {
    if (!mapInstanceRef.current) return;

    const leadType = LEAD_TYPES[pin.status] || LEAD_TYPES.knocked;
    const user = teamMembers.find(u => u.id === pin.team_member_id);
    const verification = pin.verification_status ? getVerificationStatus(pin.distance_from_pin || 0) : null;

    const marker = new google.maps.Marker({
      position: { lat: pin.lat, lng: pin.lng },
      map: mapInstanceRef.current,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 12,
        fillColor: user?.color || '#64748b',
        fillOpacity: 1,
        strokeColor: verification ? verification.color : 'white',
        strokeWeight: 4
      },
      title: pin.id
    });

    let customerInfo = null;
    let displayNote = pin.note || '';
    if (pin.note && pin.note.includes(' - ') && pin.note.includes('@')) {
      const parts = pin.note.split(' | ');
      const custPart = parts[0];
      displayNote = parts[1] || '';
      const custDetails = custPart.split(' - ');
      if (custDetails.length >= 2) {
        customerInfo = {
          name: custDetails[0],
          email: custDetails[1],
          phone: custDetails[2] || null
        };
      }
    }

    const infoWindow = new google.maps.InfoWindow({
      content: `<div style="min-width:240px;padding:0;font-family:-apple-system,sans-serif;border-radius:12px;overflow:hidden"><div style="background:linear-gradient(135deg, ${leadType.color} 0%, ${leadType.color}dd 100%);padding:16px;color:white"><div style="font-size:24px;margin-bottom:4px">${leadType.icon}</div><div style="font-size:18px;font-weight:700">${leadType.label}${customerInfo ? ` - ${customerInfo.name}` : ''}</div></div><div style="padding:16px;background:white">${pin.address ? `<div style="padding:12px;background:#f8fafc;border-left:4px solid #64748b;margin-bottom:12px;border-radius:6px"><div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:6px">üìç ADDRESS</div><div style="font-weight:600;color:#1e293b;font-size:13px;line-height:1.5;margin-bottom:8px">${pin.address}</div>${customerInfo ? `<div style="border-top:1px solid #e2e8f0;padding-top:8px;margin-top:8px">${customerInfo.email ? `<div style="color:#3b82f6;font-size:13px;margin-bottom:4px;display:flex;align-items:center;gap:6px"><span>üìß</span><span>${customerInfo.email}</span></div>` : ''}${customerInfo.phone ? `<div style="color:#3b82f6;font-size:13px;display:flex;align-items:center;gap:6px"><span>üìû</span><span>${customerInfo.phone}</span></div>` : ''}</div>` : ''}</div>` : ''}<div style="padding:10px;background:${user?.color || '#64748b'}15;border-left:4px solid ${user?.color || '#64748b'};margin-bottom:12px;border-radius:6px"><div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:4px">üë§ REP</div><div style="font-weight:700;color:${user?.color || '#64748b'};font-size:14px">${pin.rep_name || 'Unknown'}</div></div>${displayNote ? `<div style="padding:10px;background:#f8fafc;border-left:4px solid #64748b;margin-bottom:12px;border-radius:6px"><div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:4px">üìù NOTE</div><div style="color:#1e293b;font-size:13px">${displayNote}</div></div>` : ''}${verification ? `<div style="padding:12px;background:${verification.color}15;border-left:4px solid ${verification.color};margin-bottom:12px;border-radius:6px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:6px"><span style="font-size:24px">${verification.icon}</span><div><div style="font-weight:700;color:${verification.color};font-size:15px">${verification.label}</div><div style="font-size:13px;color:#64748b;margin-top:2px">Distance: <b>${pin.distance_from_pin} feet</b></div></div></div></div>` : ''}<div style="font-size:12px;color:#94a3b8;margin-bottom:14px;text-align:center">${new Date(pin.created_at).toLocaleString()}</div>${customerInfo ? `<button onclick="window.openGHLCalendarGlobal('${customerInfo.name}','${customerInfo.email || ''}','${customerInfo.phone || ''}','${pin.address || ''}')" class="modern-button" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;margin-bottom:8px;box-shadow:0 2px 8px rgba(16,185,129,0.3)">üìÖ Book Appointment</button>` : ''}<button onclick="window.deletePinGlobal('${pin.id}')" class="modern-button" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;box-shadow:0 2px 8px rgba(239,68,68,0.3)">üóëÔ∏è Delete Pin</button></div></div>`,
      maxWidth: 280
    });

    marker.addListener('click', () => infoWindow.open(mapInstanceRef.current, marker));
    markersRef.current.push({ marker, pinId: pin.id });
  }

  useEffect(() => {
    if (!mapInstanceRef.current || pins.length === 0 || !mapReady) return;

    markersRef.current.forEach(({ marker }) => marker.setMap(null));
    markersRef.current = [];

    pins.forEach(pin => addMarkerToMap(pin));
  }, [pins, teamMembers, mapReady]);

  useEffect(() => {
    if (!mapInstanceRef.current || !currentLocation) return;

    if (userMarkerRef.current) userMarkerRef.current.setMap(null);

    const userIcon = {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 15,
      fillColor: currentUser?.color || '#3b82f6',
      fillOpacity: 1,
      strokeColor: '#ffffff',
      strokeWeight: 5
    };

    userMarkerRef.current = new google.maps.Marker({
      position: { lat: currentLocation.lat, lng: currentLocation.lng },
      map: mapInstanceRef.current,
      icon: userIcon,
      title: 'You are here'
    });

    new google.maps.Circle({
      map: mapInstanceRef.current,
      center: { lat: currentLocation.lat, lng: currentLocation.lng },
      radius: currentLocation.accuracy || 50,
      fillColor: currentUser?.color || '#3b82f6',
      fillOpacity: 0.2,
      strokeColor: currentUser?.color || '#3b82f6',
      strokeOpacity: 0.5,
      strokeWeight: 2
    });
  }, [currentLocation, currentUser, mapReady]);

  window.deletePinGlobal = async (pinId) => {
    if (!confirm('Delete this pin?')) return;
    try {
      await supabase.current.from('pins').delete().eq('id', pinId);
      setPins(prev => prev.filter(p => p.id !== pinId));
      showToast('‚úÖ Pin deleted!');
      const markerObj = markersRef.current.find(m => m.pinId === pinId);
      if (markerObj) {
        markerObj.marker.setMap(null);
        markersRef.current = markersRef.current.filter(m => m.pinId !== pinId);
      }
    } catch (e) {
      showToast('‚ùå Error deleting pin');
    }
  };

  window.openGHLCalendarGlobal = openGHLCalendar;
  window.showCalendarModal = (data) => {
    setCalendarData(data);
    setShowCalendarModal(true);
  };

  function selectCurrentUser(user) {
    setCurrentUser(user);
    localStorage.setItem('current_user_id', JSON.stringify(user));
    requestLocationPermission(user);
  }

  const stats = {
    totalPins: currentUser ? pins.filter(p => p.team_member_id === currentUser.id).length : 0,
    estimates: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'estimate').length : 0,
    callbacks: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'callback').length : 0,
    verified: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.verification_status === 'verified').length : 0,
    suspicious: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.verification_status === 'suspicious').length : 0
  };

  // NEW: CRM Functions
  const getFilteredLeads = () => {
    let filtered = pins;

    if (currentUser) {
      filtered = filtered.filter(p => p.team_member_id === currentUser.id);
    }

    if (crmFilter !== 'all') {
      filtered = filtered.filter(p => p.status === crmFilter);
    }

    if (crmSearch) {
      const search = crmSearch.toLowerCase();
      filtered = filtered.filter(p => 
        p.address?.toLowerCase().includes(search) ||
        p.note?.toLowerCase().includes(search) ||
        p.rep_name?.toLowerCase().includes(search)
      );
    }

    return filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  };

  const extractCustomerInfo = (pin) => {
    if (!pin.note) return null;
    if (pin.note.includes(' - ') && pin.note.includes('@')) {
      const parts = pin.note.split(' | ');
      const custPart = parts[0];
      const custDetails = custPart.split(' - ');
      if (custDetails.length >= 2) {
        return {
          name: custDetails[0],
          email: custDetails[1],
          phone: custDetails[2] || null
        };
      }
    }
    return null;
  };

  const gpsAge = currentLocation ? getGPSAge(currentLocation) : null;
  const gpsIsFresh = currentLocation ? isGPSFresh(currentLocation) : false;

  if (loading) {
    return (
      <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',flexDirection:'column',gap:'1.5rem',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}}>
        <div style={{fontSize:'5rem',animation:'bounce 1s infinite'}}>üè†</div>
        <div>
          <h1 style={{color:'white',fontSize:'2.5rem',fontWeight:'bold',marginBottom:'0.5rem',textAlign:'center'}}>RepZone Pro</h1>
          <p style={{color:'rgba(255,255,255,0.9)',fontSize:'1.125rem',textAlign:'center'}}>Loading your workspace...</p>
        </div>
        <div style={{width:'200px',height:'4px',background:'rgba(255,255,255,0.2)',borderRadius:'2px',overflow:'hidden'}}>
          <div style={{width:'100%',height:'100%',background:'white',animation:'progress 1.5s ease-in-out infinite'}}></div>
        </div>
      </div>
    );
  }

  const MobileDropdownContent = () => (
    <div style={{padding:'1rem',paddingTop:'5rem'}}>
      {currentUser && (
        <div style={{marginBottom:'1rem',padding:'1rem',background:`${currentUser.color}15`,borderRadius:'1rem',border:`2px solid ${currentUser.color}`,display:'flex',alignItems:'center',gap:'0.75rem'}}>
          <div style={{width:'48px',height:'48px',borderRadius:'50%',background:currentUser.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.25rem',boxShadow:'0 2px 8px rgba(0,0,0,0.15)'}}>
            {currentUser.name.charAt(0)}
          </div>
          <div style={{flex:1}}>
            <div style={{fontWeight:'700',fontSize:'0.9375rem'}}>{currentUser.name}</div>
            <div style={{fontSize:'0.6875rem',color:'#64748b',fontWeight:'600'}}>{currentUser.role}</div>
          </div>
          <button onClick={() => setCurrentUser(null)} className="modern-button" style={{padding:'0.5rem 0.875rem',fontSize:'0.75rem',background:'white',border:'1px solid #e2e8f0',borderRadius:'0.5rem',fontWeight:'700'}}>Switch</button>
        </div>
      )}

      <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'12px',marginBottom:'24px'}}>
        <div className="stat-card" style={{padding:'16px',textAlign:'center',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',color:'white'}}>
          <div style={{fontSize:'32px',fontWeight:'bold'}}>{stats.estimates}</div>
          <div style={{fontSize:'14px',marginTop:'4px'}}>Estimates</div>
        </div>
        <div className="stat-card" style={{padding:'16px',textAlign:'center',background:'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',color:'white'}}>
          <div style={{fontSize:'32px',fontWeight:'bold'}}>{stats.callbacks}</div>
          <div style={{fontSize:'14px',marginTop:'4px'}}>Callbacks</div>
        </div>
      </div>

      <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'8px',marginBottom:'16px'}}>
        <button onClick={() => setShowCRM(true)} className="modern-button" style={{padding:'12px',background:'#8b5cf6',color:'white',border:'none',borderRadius:'12px',fontWeight:'700',fontSize:'14px'}}>üìã CRM</button>
        <button onClick={() => {setRouteMode(!routeMode);if(routeMode){clearRoute();}}} className="modern-button" style={{padding:'12px',background:routeMode?'#ef4444':'#3b82f6',color:'white',border:'none',borderRadius:'12px',fontWeight:'700',fontSize:'14px'}}>{routeMode ? '‚úï Exit' : 'üó∫Ô∏è Route'}</button>
      </div>

      {routeMode && (
        <div className="stat-card" style={{marginBottom:'1rem',background:'#dbeafe',border:'2px solid #3b82f6'}}>
          <div style={{fontSize:'14px',fontWeight:'700',marginBottom:'8px',color:'#1e293b'}}>üó∫Ô∏è Route Mode</div>
          <p style={{fontSize:'12px',color:'#64748b',marginBottom:'12px'}}>Tap map to add points ({routePoints.length} added)</p>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'8px'}}>
            <button onClick={() => setShowRouteModal(true)} disabled={routePoints.length < 2} className="modern-button" style={{padding:'10px',background:routePoints.length < 2 ? '#94a3b8' : '#10b981',color:'white',border:'none',borderRadius:'8px',fontSize:'12px',fontWeight:'700'}}>üíæ Save</button>
            <button onClick={clearRoute} className="modern-button" style={{padding:'10px',background:'#ef4444',color:'white',border:'none',borderRadius:'8px',fontSize:'12px',fontWeight:'700'}}>üóëÔ∏è Clear</button>
          </div>
        </div>
      )}

      <div className="stat-card" style={{marginBottom:'1rem',background:trackingEnabled?'#dcfce7':'#fee2e2',border:`2px solid ${trackingEnabled?'#10b981':'#ef4444'}`}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
          <b style={{fontSize:'0.875rem',fontWeight:'700'}}>üìç GPS Tracking</b>
          <button onClick={() => trackingEnabled ? stopLocationTracking() : requestLocationPermission(currentUser)} className="modern-button" style={{padding:'0.5rem 1rem',background:trackingEnabled?'#ef4444':'#10b981',color:'white',border:'none',borderRadius:'0.5rem',fontWeight:'700',fontSize:'0.75rem',boxShadow:`0 2px 8px ${trackingEnabled?'rgba(239,68,68,0.3)':'rgba(16,185,129,0.3)'}`}}>{trackingEnabled ? 'Stop' : 'Start'}</button>
        </div>
        <p style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600'}}>
          {trackingEnabled ? (gpsAge !== null ? `Active - ${gpsAge}s old ${gpsIsFresh ? '‚úÖ' : '‚ö†Ô∏è Stale'}` : 'Active') : 'Enable to verify'}
        </p>
      </div>

      {!routeMode && (
        <>
          <div style={{marginBottom:'1rem'}}>
            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'700',marginBottom:'0.75rem',color:'#1e293b'}}>üîç Search Address</label>
            <input ref={searchBoxRef} type="text" placeholder="Search for a place..." style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.875rem',fontWeight:'600'}}/>
          </div>

          <div style={{marginBottom:'1rem'}}>
            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'700',marginBottom:'0.75rem',color:'#1e293b'}}>üéØ Lead Type</label>
            <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.5rem'}}>
              {[['estimate','üí∞','A','#10b981'],['callback','üìû','B','#f59e0b'],['notinterested','üìã','C','#64748b'],['flyer','üì¨','FD','#3b82f6']].map(([s,icon,display,color]) => (
                <button key={s} onClick={()=>{setStatus(s);setFdMode(s === 'flyer');}} className="modern-button" style={{padding:'0.875rem 0.5rem',borderRadius:'0.75rem',border:status===s?'none':'2px solid #bfdbfe',background:status===s?color:'white',color:status===s?'white':'#64748b',fontSize:'1.5rem',display:'flex',flexDirection:'column',alignItems:'center',gap:'0.25rem',boxShadow:status===s?`0 4px 12px ${color}50`:'none'}}>
                  <div>{icon}</div>
                  <div style={{fontSize:'0.75rem',fontWeight:'700'}}>{display}</div>
                </button>
              ))}
            </div>
            {status === 'flyer' && (<p style={{fontSize:'0.75rem',color:'#3b82f6',fontWeight:'700',marginTop:'0.75rem',textAlign:'center'}}>‚ö° FD Mode: Pin drops instantly</p>)}
            <input value={note} onChange={e=>setNote(e.target.value)} placeholder="Note (optional)" style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.875rem',fontWeight:'600',marginTop:'0.75rem'}}/>
          </div>
        </>
      )}

      <button onClick={()=>{setCurrentUser(null);localStorage.removeItem('current_user_id');}} className="btn" style={{width:'100%',padding:'16px',background:'#e5e7eb',border:'none',borderRadius:'12px',fontSize:'16px',fontWeight:'bold'}}>üîÑ Switch User</button>
    </div>
  );

  return (
    <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'#f8fafc'}}>
      {toastMessage && <div className="toast">{toastMessage}</div>}

      {showCustomerForm && pendingPinLocation && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10003,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1.5rem',padding:'2rem',maxWidth:'440px',width:'100%',boxShadow:'0 20px 40px rgba(0,0,0,0.3)',animation:'fadeIn 0.3s ease'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem'}}>
              <h3 style={{fontSize:'1.5rem',fontWeight:'bold',color:'#1e293b'}}>üìã Customer Info</h3>
              <button onClick={() => {setShowCustomerForm(false);setPendingPinLocation(null);setCustomerName('');setCustomerPhone('');setCustomerEmail('');}} className="modern-button" style={{width:'40px',height:'40px',borderRadius:'50%',border:'none',background:'#f1f5f9',fontSize:'1.5rem',display:'flex',alignItems:'center',justifyContent:'center'}}>√ó</button>
            </div>
            <div style={{marginBottom:'1rem'}}>
              <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.5rem',color:'#1e293b'}}>Customer Name</label>
              <input value={customerName} onChange={(e) => setCustomerName(e.target.value)} placeholder="Enter customer name..." autoFocus style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}/>
            </div>
            <div style={{marginBottom:'1rem'}}>
              <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.5rem',color:'#1e293b'}}>Email <span style={{color:'#64748b',fontWeight:'400'}}>(optional)</span></label>
              <input value={customerEmail} onChange={(e) => setCustomerEmail(e.target.value)} placeholder="customer@email.com" type="email" style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}/>
            </div>
            <div style={{marginBottom:'1.5rem'}}>
              <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.5rem',color:'#1e293b'}}>Phone <span style={{color:'#64748b',fontWeight:'400'}}>(optional)</span></label>
              <input value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} placeholder="(555) 123-4567" style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}/>
            </div>
            <div style={{marginBottom:'1.5rem'}}>
              <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.5rem',color:'#1e293b'}}>Note <span style={{color:'#64748b',fontWeight:'400'}}>(optional)</span></label>
              <textarea value={customerNote} onChange={(e) => setCustomerNote(e.target.value)} placeholder="Gate code, dog, etc..." rows={2} style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600',resize:'vertical',fontFamily:'-apple-system,sans-serif'}}/>
            </div>
            <button onClick={async () => {setShowCustomerForm(false);await dropPinAtLocation(pendingPinLocation.lat, pendingPinLocation.lng, customerName, customerPhone, customerEmail, customerNote);setPendingPinLocation(null);setCustomerName('');setCustomerPhone('');setCustomerEmail('');setCustomerNote('');}} className="modern-button" style={{width:'100%',padding:'1rem',background:'#3b82f6',color:'white',border:'none',borderRadius:'0.75rem',fontSize:'1rem',fontWeight:'700',boxShadow:'0 4px 12px rgba(59,130,246,0.3)'}}>üìç Drop Pin</button>
          </div>
        </div>
      )}

      {showRouteModal && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10003,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1.5rem',padding:'2rem',maxWidth:'440px',width:'100%',boxShadow:'0 20px 40px rgba(0,0,0,0.3)'}}>
            <h3 style={{fontSize:'1.5rem',fontWeight:'bold',marginBottom:'1.5rem',color:'#1e293b'}}>üíæ Save Route</h3>
            <div style={{marginBottom:'1.5rem'}}>
              <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.5rem',color:'#1e293b'}}>Route Name</label>
              <input value={routeName} onChange={(e) => setRouteName(e.target.value)} placeholder="e.g., Ballard North Route" autoFocus style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}/>
            </div>
            <p style={{fontSize:'0.875rem',color:'#64748b',marginBottom:'1.5rem'}}>Points: {routePoints.length}</p>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px'}}>
              <button onClick={() => setShowRouteModal(false)} className="modern-button" style={{padding:'12px',background:'#f1f5f9',border:'none',borderRadius:'12px',fontWeight:'700'}}>Cancel</button>
              <button onClick={saveRoute} className="modern-button" style={{padding:'12px',background:'#10b981',color:'white',border:'none',borderRadius:'12px',fontWeight:'700'}}>Save Route</button>
            </div>
          </div>
        </div>
      )}

      {showCRM && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'white',zIndex:10002,overflowY:'auto',padding:'1rem'}}>
          <div style={{maxWidth:'1200px',margin:'0 auto'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.5rem'}}>
              <h2 style={{fontSize:'1.75rem',fontWeight:'bold',color:'#1e293b'}}>üìã CRM - Lead Manager</h2>
              <button onClick={() => setShowCRM(false)} className="modern-button" style={{padding:'12px 20px',background:'#ef4444',color:'white',border:'none',borderRadius:'12px',fontWeight:'700'}}>‚úï Close</button>
            </div>

            <div style={{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 2fr',gap:'1rem',marginBottom:'1.5rem'}}>
              <input value={crmSearch} onChange={(e) => setCrmSearch(e.target.value)} placeholder="üîç Search leads..." style={{width:'100%',padding:'12px',border:'2px solid #e5e7eb',borderRadius:'12px',fontSize:'14px',fontWeight:'600'}}/>
              <div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>
                {[['all','All'],['estimate','üí∞ A'],['callback','üìû B'],['notinterested','üìã C'],['flyer','üì¨ FD']].map(([value,label]) => (
                  <button key={value} onClick={() => setCrmFilter(value)} className="modern-button" style={{padding:'10px 16px',background:crmFilter===value?'#3b82f6':'white',color:crmFilter===value?'white':'#64748b',border:'2px solid #e5e7eb',borderRadius:'10px',fontSize:'13px',fontWeight:'700'}}>{label}</button>
                ))}
              </div>
            </div>

            <div style={{fontSize:'14px',color:'#64748b',fontWeight:'700',marginBottom:'12px'}}>{getFilteredLeads().length} leads</div>

            <div style={{display:'grid',gap:'12px'}}>
              {getFilteredLeads().map(pin => {
                const leadType = LEAD_TYPES[pin.status] || LEAD_TYPES.knocked;
                const customerInfo = extractCustomerInfo(pin);
                const verification = pin.verification_status ? getVerificationStatus(pin.distance_from_pin || 0) : null;

                return (
                  <div key={pin.id} className="stat-card" style={{padding:'16px'}}>
                    <div style={{display:'flex',gap:'16px',alignItems:'flex-start'}}>
                      <div style={{fontSize:'36px',flexShrink:0}}>{leadType.icon}</div>
                      <div style={{flex:1}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'start',marginBottom:'8px'}}>
                          <div>
                            <div style={{fontSize:'16px',fontWeight:'700',color:leadType.color,marginBottom:'4px'}}>{leadType.label}</div>
                            {customerInfo && <div style={{fontSize:'15px',fontWeight:'700',color:'#1e293b',marginBottom:'4px'}}>{customerInfo.name}</div>}
                          </div>
                          {verification && (
                            <div style={{fontSize:'24px'}}>{verification.icon}</div>
                          )}
                        </div>

                        {pin.address && (
                          <div style={{fontSize:'13px',color:'#64748b',marginBottom:'8px',fontWeight:'600'}}>üìç {pin.address}</div>
                        )}

                        {customerInfo && (
                          <div style={{marginBottom:'8px'}}>
                            {customerInfo.email && <div style={{fontSize:'13px',color:'#3b82f6',marginBottom:'4px'}}>üìß {customerInfo.email}</div>}
                            {customerInfo.phone && <div style={{fontSize:'13px',color:'#3b82f6'}}>üìû {customerInfo.phone}</div>}
                          </div>
                        )}

                        <div style={{fontSize:'12px',color:'#94a3b8',marginBottom:'12px'}}>üë§ {pin.rep_name} ‚Ä¢ {new Date(pin.created_at).toLocaleDateString()}</div>

                        {customerInfo && (
                          <button onClick={() => openGHLCalendar(customerInfo.name, customerInfo.email, customerInfo.phone, pin.address)} className="modern-button" style={{width:'100%',padding:'10px',background:'#10b981',color:'white',border:'none',borderRadius:'10px',fontSize:'13px',fontWeight:'700',marginTop:'8px'}}>üìÖ Book Appointment</button>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {(saving || geocoding) && (
        <div style={{position:'fixed',top:'50%',left:'50%',transform:'translate(-50%,-50%)',background:'white',padding:'2rem 2.5rem',borderRadius:'1.5rem',boxShadow:'0 20px 40px rgba(0,0,0,0.2)',zIndex:10001,display:'flex',flexDirection:'column',gap:'1rem',alignItems:'center'}}>
          <div className="spinner" style={{width:'40px',height:'40px',borderWidth:'4px',borderTopColor:'#3b82f6'}}></div>
          <span style={{fontWeight:'700',fontSize:'1.125rem',color:'#1e293b'}}>{geocoding ? 'üè† Finding Address...' : 'üíæ Saving...'}</span>
        </div>
      )}

      {trackingEnabled && !isMobile && (
        <div style={{position:'fixed',top:'1rem',right:'1rem',background:gpsIsFresh?'#10b981':'#f59e0b',color:'white',padding:'0.875rem 1.5rem',borderRadius:'2rem',boxShadow:'0 6px 16px rgba(0,0,0,0.2)',zIndex:10001,display:'flex',gap:'0.875rem',alignItems:'center',fontSize:'0.9375rem',fontWeight:'700'}}>
          <div style={{width:'14px',height:'14px',background:'white',borderRadius:'50%',animation:'pulse 2s infinite'}}></div>
          <span>GPS {gpsAge !== null ? `${gpsAge}s` : 'Active'} {gpsIsFresh ? '‚úÖ' : '‚ö†Ô∏è'}</span>
        </div>
      )}

      {!currentUser && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10000,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1.5rem',padding:'2rem',maxWidth:'440px',width:'100%',maxHeight:'80vh',overflowY:'auto',boxShadow:'0 20px 40px rgba(0,0,0,0.3)'}}>
            <h2 style={{fontSize:'1.75rem',fontWeight:'bold',marginBottom:'0.75rem',color:'#1e293b'}}>üëã Select Your Profile</h2>
            <p style={{color:'#64748b',marginBottom:'1.5rem',fontSize:'0.9375rem',fontWeight:'600'}}>Choose your name to start tracking</p>
            <div style={{marginBottom:'1rem'}}>
              {teamMembers.map(member => (
                <div key={member.id} className="stat-card" style={{marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'1rem',cursor:'pointer'}} onClick={() => selectCurrentUser(member)}>
                  <div style={{width:'56px',height:'56px',borderRadius:'50%',background:member.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.5rem',flexShrink:0,boxShadow:'0 4px 12px rgba(0,0,0,0.15)'}}>
                    {member.name.charAt(0)}
                  </div>
                  <div>
                    <div style={{fontWeight:'700',fontSize:'1.125rem',color:'#1e293b'}}>{member.name}</div>
                    <div style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>{member.role}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {isMobile && (
        <>
          <button className={`hamburger-btn ${mobileMenuOpen ? 'open' : ''}`} onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
            <span></span>
            <span></span>
            <span></span>
          </button>
          <div className={`mobile-dropdown ${mobileMenuOpen ? 'open' : ''}`}>
            <MobileDropdownContent />
          </div>
        </>
      )}

      <div style={{display:'flex',height:'100%',gap:isMobile?0:'1rem',padding:isMobile?0:'1rem'}}>
        {!isMobile && (
          <div className="desktop-sidebar" style={{width:'420px',background:'white',borderRadius:'1rem',boxShadow:'0 4px 12px rgba(0,0,0,0.08)',flexDirection:'column',overflow:'hidden',border:'1px solid #e5e7eb'}}>
            <div style={{padding:'1.75rem',borderBottom:'1px solid #e5e7eb',background:'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'}}>
              <h1 style={{fontSize:'2rem',fontWeight:'bold',marginBottom:'0.5rem',color:'white',textShadow:'0 2px 4px rgba(0,0,0,0.1)'}}>üè† RepZone Pro</h1>
              <p style={{color:'rgba(255,255,255,0.9)',fontSize:'0.875rem',fontWeight:'600'}}>Door Knocking Tracker</p>
            </div>

            {currentUser && (
              <div style={{padding:'1.25rem',borderBottom:'1px solid #e5e7eb'}}>
                <div className="stat-card" style={{background:`${currentUser.color}15`,border:`2px solid ${currentUser.color}`,display:'flex',alignItems:'center',gap:'1rem'}}>
                  <div style={{width:'56px',height:'56px',borderRadius:'50%',background:currentUser.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.5rem',flexShrink:0,boxShadow:'0 4px 12px rgba(0,0,0,0.15)'}}>
                    {currentUser.name.charAt(0)}
                  </div>
                  <div style={{flex:1}}>
                    <div style={{fontWeight:'700',fontSize:'1.0625rem',color:'#1e293b'}}>{currentUser.name}</div>
                    <div style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>{currentUser.role}</div>
                  </div>
                  <button onClick={() => setCurrentUser(null)} className="modern-button" style={{padding:'0.625rem 1rem',fontSize:'0.8125rem',background:'white',border:'1px solid #e5e7eb',borderRadius:'0.75rem',fontWeight:'700',boxShadow:'0 2px 4px rgba(0,0,0,0.06)'}}>Switch</button>
                </div>
              </div>
            )}

            <div style={{flex:1,overflowY:'auto',padding:'1.25rem'}}>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginBottom:'20px'}}>
                <button onClick={() => setShowCRM(true)} className="modern-button" style={{padding:'14px',background:'#8b5cf6',color:'white',border:'none',borderRadius:'12px',fontWeight:'700',fontSize:'14px',boxShadow:'0 2px 8px rgba(139,92,246,0.3)'}}>üìã CRM</button>
                <button onClick={() => {setRouteMode(!routeMode);if(routeMode){clearRoute();}}} className="modern-button" style={{padding:'14px',background:routeMode?'#ef4444':'#3b82f6',color:'white',border:'none',borderRadius:'12px',fontWeight:'700',fontSize:'14px',boxShadow:routeMode?'0 2px 8px rgba(239,68,68,0.3)':'0 2px 8px rgba(59,130,246,0.3)'}}>{routeMode ? '‚úï Exit Route' : 'üó∫Ô∏è Create Route'}</button>
              </div>

              {routeMode && (
                <div className="stat-card" style={{marginBottom:'1.25rem',background:'#dbeafe',border:'2px solid #3b82f6'}}>
                  <div style={{fontSize:'16px',fontWeight:'700',marginBottom:'8px',color:'#1e293b'}}>üó∫Ô∏è Route Mode Active</div>
                  <p style={{fontSize:'13px',color:'#64748b',marginBottom:'16px'}}>Click on the map to add route points. You've added {routePoints.length} point{routePoints.length !== 1 ? 's' : ''}.</p>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'8px'}}>
                    <button onClick={() => setShowRouteModal(true)} disabled={routePoints.length < 2} className="modern-button" style={{padding:'12px',background:routePoints.length < 2 ? '#94a3b8' : '#10b981',color:'white',border:'none',borderRadius:'10px',fontSize:'14px',fontWeight:'700',cursor:routePoints.length < 2?'not-allowed':'pointer'}}>üíæ Save Route</button>
                    <button onClick={clearRoute} className="modern-button" style={{padding:'12px',background:'#ef4444',color:'white',border:'none',borderRadius:'10px',fontSize:'14px',fontWeight:'700'}}>üóëÔ∏è Clear</button>
                  </div>
                </div>
              )}

              {routes.length > 0 && !routeMode && (
                <div className="stat-card" style={{marginBottom:'1.25rem'}}>
                  <h3 style={{fontSize:'16px',fontWeight:'700',marginBottom:'12px',color:'#1e293b'}}>üó∫Ô∏è Saved Routes</h3>
                  {routes.map(route => (
                    <div key={route.id} style={{padding:'12px',background:'#f8fafc',borderRadius:'8px',marginBottom:'8px',border:'1px solid #e5e7eb'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                        <div>
                          <div style={{fontWeight:'700',fontSize:'14px',color:'#1e293b'}}>{route.name}</div>
                          <div style={{fontSize:'12px',color:'#64748b',marginTop:'2px'}}>{route.points?.length || 0} points</div>
                        </div>
                        <div style={{display:'flex',gap:'6px'}}>
                          <button onClick={() => viewRoute(route)} className="modern-button" style={{padding:'8px 12px',background:'#3b82f6',color:'white',border:'none',borderRadius:'8px',fontSize:'12px',fontWeight:'700'}}>View</button>
                          <button onClick={() => deleteRoute(route.id)} className="modern-button" style={{padding:'8px 12px',background:'#ef4444',color:'white',border:'none',borderRadius:'8px',fontSize:'12px',fontWeight:'700'}}>Delete</button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <div className="stat-card" style={{marginBottom:'1.25rem',background:trackingEnabled?'#dcfce7':'#fee2e2',border:`2px solid ${trackingEnabled?'#10b981':'#ef4444'}`}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
                  <b style={{fontSize:'0.9375rem',fontWeight:'700'}}>üìç GPS Tracking</b>
                  <button onClick={() => trackingEnabled ? stopLocationTracking() : requestLocationPermission(currentUser)} className="modern-button" style={{padding:'0.625rem 1.25rem',background:trackingEnabled?'#ef4444':'#10b981',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.8125rem',boxShadow:`0 2px 8px ${trackingEnabled?'rgba(239,68,68,0.3)':'rgba(16,185,129,0.3)'}`}}>{trackingEnabled ? 'Stop' : 'Start'}</button>
                </div>
                <p style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>
                  {trackingEnabled ? (gpsAge !== null ? `‚úÖ Active - GPS is ${gpsAge}s old ${gpsIsFresh ? '(Fresh ‚úÖ)' : '(Stale ‚ö†Ô∏è)'}` : '‚úÖ Location tracking active') : '‚ö†Ô∏è Enable to verify pin locations'}
                </p>
              </div>

              {!routeMode && (
                <>
                  <div className="stat-card" style={{marginBottom:'1.25rem'}}>
                    <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.875rem',color:'#1e293b'}}>üîç Search Address</label>
                    <input ref={searchBoxRef} type="text" placeholder="Search for a place..." style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}/>
                  </div>

                  <div className="stat-card" style={{marginBottom:'1.25rem'}}>
                    <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.875rem',color:'#1e293b'}}>üéØ Lead Type</label>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem',marginBottom:'1rem'}}>
                      {[['estimate','üí∞','A','#10b981'],['callback','üìû','B','#f59e0b'],['notinterested','üìã','C','#64748b'],['flyer','üì¨','FD','#3b82f6']].map(([s,icon,display,color]) => (
                        <button key={s} onClick={()=>{setStatus(s);setFdMode(s === 'flyer');}} className="modern-button" style={{padding:'1rem',borderRadius:'0.75rem',border:status===s?'none':'2px solid #bfdbfe',background:status===s?color:'white',color:status===s?'white':'#64748b',fontSize:'1.75rem',display:'flex',flexDirection:'column',alignItems:'center',gap:'0.375rem',boxShadow:status===s?`0 4px 12px ${color}50`:'none'}}>
                          <div>{icon}</div>
                          <div style={{fontSize:'0.8125rem',fontWeight:'700'}}>{display}</div>
                        </button>
                      ))}
                    </div>
                    {status === 'flyer' && (<p style={{fontSize:'0.75rem',color:'#3b82f6',fontWeight:'700',marginBottom:'1rem',textAlign:'center'}}>‚ö° FD Mode: Pin drops instantly without customer form</p>)}
                    <input value={note} onChange={e=>setNote(e.target.value)} placeholder="Note (gate code, dog, etc.)" style={{width:'100%',padding:'0.875rem',border:'2px solid #93c5fd',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}/>
                  </div>

                  <div className="stat-card">
                    <h3 style={{fontSize:'1.0625rem',fontWeight:'700',marginBottom:'1rem',color:'#1e293b'}}>üìä Quick Stats</h3>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem'}}>
                      {[['üí∞',stats.estimates,'Estimates','#10b981'],['üìû',stats.callbacks,'Callbacks','#f59e0b'],['‚úÖ',stats.verified,'Verified','#10b981'],['üö´',stats.suspicious,'Suspicious','#ef4444']].map(([icon,count,label,color]) => (
                        <div key={label} style={{padding:'1rem',background:`${color}15`,borderRadius:'0.75rem',border:`2px solid ${color}`,textAlign:'center'}}>
                          <div style={{fontSize:'1.75rem',marginBottom:'0.375rem'}}>{icon}</div>
                          <div style={{fontSize:'1.75rem',fontWeight:'bold',color:color,marginBottom:'0.25rem'}}>{count}</div>
                          <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'700'}}>{label}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>
        )}

        <div style={{flex:1,borderRadius:isMobile?0:'1rem',overflow:'hidden',boxShadow:isMobile?'none':'0 4px 12px rgba(0,0,0,0.08)',position:'relative',border:isMobile?'none':'1px solid #e5e7eb'}}>
          <div ref={mapRef} style={{height:'100%',width:'100%'}} id="map"></div>
        </div>
      </div>

      {showCalendarModal && calendarData && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10003,padding:'1rem',overflow:'auto'}}>
          <div style={{background:'white',borderRadius:'1.5rem',width:'100%',maxWidth:'900px',minHeight:'90vh',maxHeight:'95vh',display:'flex',flexDirection:'column',boxShadow:'0 20px 60px rgba(0,0,0,0.3)',margin:'auto'}}>
            <div style={{padding:'1.5rem',borderBottom:'2px solid #e5e7eb',display:'flex',justifyContent:'space-between',alignItems:'center',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',flexShrink:0}}>
              <div>
                <h2 style={{fontSize:'1.5rem',fontWeight:'bold',color:'white',marginBottom:'0.25rem'}}>üìÖ Book Appointment</h2>
                <p style={{fontSize:'0.875rem',color:'rgba(255,255,255,0.9)'}}>{calendarData.name}</p>
              </div>
              <button onClick={() => setShowCalendarModal(false)} className="modern-button" style={{padding:'0.75rem',background:'rgba(255,255,255,0.2)',border:'none',borderRadius:'0.75rem',color:'white',fontSize:'1.5rem',cursor:'pointer',width:'44px',height:'44px'}}>‚úï</button>
            </div>
            <div style={{flex:1,overflow:'auto',position:'relative',WebkitOverflowScrolling:'touch'}}>
              <iframe src="https://sea.refinedpainting.co/widget/booking/fIYuXbwwo4XQh3nyLxj8" style={{width:'100%',minHeight:'900px',border:'none',display:'block'}} title="GHL Calendar"/>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

window.startRepZoneApp = () => {
  ReactDOM.createRoot(document.getElementById('root')).render(<RepZoneApp />);
};

if (window.googleMapsReady) {
  window.startRepZoneApp();
}
</script>
</body>
</html>
