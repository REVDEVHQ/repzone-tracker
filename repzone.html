<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>RepZone Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif; }
  .leaflet-container { height: 100% !important; width: 100% !important; touch-action: pan-x pan-y; }
  
  .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }
  @keyframes progress {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  @keyframes slideIn { 
    from { transform: translateX(400px); opacity: 0; } 
    to { transform: translateX(0); opacity: 1; } 
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }
  
  .tracking-indicator { animation: pulse 2s infinite; }
  .tab { padding: 0.875rem 1.25rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; transition: all 0.3s; font-size: 0.9375rem; }
  .tab.active { border-bottom-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
  .tab:hover { background: #f1f5f9; }
  .toast { position: fixed; top: 5rem; right: 1rem; background: white; padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 10001; animation: slideIn 0.3s ease; max-width: 400px; border-left: 4px solid #3b82f6; }
  
  .stat-card {
    background: white;
    border-radius: 1rem;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s;
    border: 1px solid #e5e7eb;
  }
  
  .stat-card:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  
  .modern-button {
    transition: all 0.2s;
    font-weight: 600;
    cursor: pointer;
  }
  
  .modern-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .modern-button:active {
    transform: translateY(0);
  }
  
  .loading-shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 1000px 100%;
    animation: shimmer 2s infinite;
  }
  
  .hamburger-btn {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    width: 54px;
    height: 54px;
    background: white;
    border: none;
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 1002;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.3s;
  }
  
  .hamburger-btn:hover {
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  }
  
  .hamburger-btn span {
    width: 26px;
    height: 3px;
    background: #1e293b;
    border-radius: 2px;
    transition: all 0.3s;
  }
  
  .hamburger-btn.open span:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
  }
  
  .hamburger-btn.open span:nth-child(2) {
    opacity: 0;
  }
  
  .hamburger-btn.open span:nth-child(3) {
    transform: rotate(-45deg) translate(6px, -6px);
  }
  
  .mobile-dropdown {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: white;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
    z-index: 1001;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .mobile-dropdown.open {
    max-height: 85vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .desktop-sidebar {
    display: flex;
  }
  
  @media (max-width: 768px) {
    .hamburger-btn {
      display: flex;
    }
    
    .mobile-dropdown {
      display: block;
    }
    
    .desktop-sidebar {
      display: none !important;
    }
    
    .toast {
      left: 1rem;
      right: 1rem;
      top: 1rem;
    }
  }
  
  @media (min-width: 769px) {
    .hamburger-btn {
      display: none !important;
    }
    
    .mobile-dropdown {
      display: none !important;
    }
    
    .desktop-sidebar {
      display: flex !important;
    }
  }
  
  ::-webkit-scrollbar {
    width: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* NEW STYLES FOR ADDED FEATURES */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justifyContent: center;
    z-index: 10003;
    animation: fadeIn 0.2s ease;
  }

  .modal-content {
    background: white;
    border-radius: 1.5rem;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
  }

  .input-field {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .input-field:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .icon-selector {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.75rem;
    margin-top: 1rem;
  }

  .icon-option {
    padding: 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    font-size: 2rem;
  }

  .icon-option:hover {
    border-color: #3b82f6;
    background: #eff6ff;
  }

  .icon-option.selected {
    border-color: #3b82f6;
    background: #3b82f6;
    color: white;
  }

  .settings-btn {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    width: 54px;
    height: 54px;
    background: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 1000;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .settings-btn:hover {
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    transform: scale(1.05);
  }
</style>
</head>
<body>
<div id="root"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SUPABASE_URL = 'https://cytikhfyygkovnjtpsth.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dGlraGZ5eWdrb3ZuanRwc3RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTc3NzYsImV4cCI6MjA3NjI5Mzc3Nn0.ItJObIXo_Ks8TEigj5RkUA4vXbze_3FMMIzYyVHrthQ';

const COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];

const LEAD_TYPES = {
  estimate: { icon: 'üí∞', label: 'A - Estimate', color: '#10b981', display: 'A' },
  callback: { icon: 'üìû', label: 'B - Callback 1-2 Weeks', color: '#f59e0b', display: 'B' },
  notinterested: { icon: 'üìã', label: 'C - Not Interested (Has Info)', color: '#64748b', display: 'C' },
  flyer_dropped: { icon: 'üì¨', label: 'FD - Flyer Dropped', color: '#3b82f6', display: 'FD' },
  knocked: { icon: '‚úÖ', label: 'Knocked', color: '#16a34a', display: '‚úÖ' },
  flyer: { icon: 'üì¨', label: 'Flyer', color: '#2563eb', display: 'üì¨' },
  skipped: { icon: '‚è≠Ô∏è', label: 'Skipped', color: '#ef4444', display: '‚è≠Ô∏è' }
};

const GPS_MAX_AGE_MS = 30000;
const RDHQ_USER_ID = 'user-1760887469016';

// Available icons for customization
const AVAILABLE_ICONS = ['üìç', 'üè†', 'üè¢', '‚≠ê', 'üìã', '‚úÖ', 'üéØ', 'üîî'];

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c * 3.28084;
}

function getVerificationStatus(distance) {
  if (distance <= 50) return { status: 'verified', color: '#10b981', icon: '‚úÖ', label: 'Verified' };
  if (distance <= 150) return { status: 'questionable', color: '#f59e0b', icon: '‚ö†Ô∏è', label: 'Questionable' };
  return { status: 'suspicious', color: '#ef4444', icon: 'üö´', label: 'Suspicious' };
}

function isPointInPolygon(point, polygon) {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i][0], yi = polygon[i][1];
    const xj = polygon[j][0], yj = polygon[j][1];
    const intersect = ((yi > point[1]) !== (yj > point[1])) && (point[0] < (xj - xi) * (point[1] - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function isGPSFresh(location) {
  if (!location || !location.timestamp) return false;
  const age = Date.now() - location.timestamp;
  return age < GPS_MAX_AGE_MS;
}

function getGPSAge(location) {
  if (!location || !location.timestamp) return null;
  return Math.floor((Date.now() - location.timestamp) / 1000);
}

// üè† FULL ADDRESS GEOCODING - Returns address + snapped coordinates
async function reverseGeocode(lat, lng) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`,
      {
        headers: {
          'User-Agent': 'RepZone Door Knocking App'
        }
      }
    );
    
    if (!response.ok) return null;
    
    const data = await response.json();
    
    if (!data || !data.address) return null;
    
    const addr = data.address;
    const houseNumber = addr.house_number || '';
    const road = addr.road || addr.street || '';
    const city = addr.city || addr.town || addr.village || '';
    const state = addr.state || '';
    const postcode = addr.postcode || '';
    const county = addr.county || '';
    const suburb = addr.suburb || addr.neighbourhood || '';
    
    // Build full address string
    let fullAddress = '';
    if (houseNumber && road) {
      fullAddress = `${houseNumber} ${road}`;
      if (suburb) fullAddress += `, ${suburb}`;
      if (city) fullAddress += `, ${city}`;
      if (state) fullAddress += `, ${state}`;
      if (postcode) fullAddress += ` ${postcode}`;
    } else if (road) {
      fullAddress = road;
      if (suburb) fullAddress += `, ${suburb}`;
      if (city) fullAddress += `, ${city}`;
      if (state) fullAddress += `, ${state}`;
    } else if (suburb && city) {
      fullAddress = `${suburb}, ${city}`;
      if (state) fullAddress += `, ${state}`;
    } else if (city) {
      fullAddress = city;
      if (state) fullAddress += `, ${state}`;
    } else {
      fullAddress = 'Address Not Found';
    }
    
    // Build short address (for compact display)
    let shortAddress = '';
    if (houseNumber && road) {
      shortAddress = `${houseNumber} ${road}`;
    } else if (road) {
      shortAddress = road;
    } else if (suburb) {
      shortAddress = suburb;
    } else {
      shortAddress = city || 'Unknown';
    }
    
    return {
      fullAddress,
      shortAddress,
      houseNumber,
      street: road,
      suburb,
      city,
      county,
      state,
      postcode,
      lat: parseFloat(data.lat),
      lng: parseFloat(data.lon),
      displayName: data.display_name,
      addressType: data.addresstype || data.type
    };
  } catch (error) {
    console.error('Geocoding error:', error);
    return null;
  }
}

// üîç FORWARD GEOCODING - Search for address
async function forwardGeocode(query) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`,
      {
        headers: {
          'User-Agent': 'RepZone Door Knocking App'
        }
      }
    );
    
    if (!response.ok) return [];
    
    const data = await response.json();
    
    return data.map(result => ({
      displayName: result.display_name,
      lat: parseFloat(result.lat),
      lng: parseFloat(result.lon),
      type: result.type,
      importance: result.importance
    }));
  } catch (error) {
    console.error('Forward geocoding error:', error);
    return [];
  }
}

function RepZoneApp() {
  const [pins, setPins] = useState([]);
  const [zones, setZones] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [liveLocations, setLiveLocations] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentLocation, setCurrentLocation] = useState(null);
  const [mode, setMode] = useState("drop-pin");
  const [status, setStatus] = useState("estimate");
  const [activeZoneId, setActiveZoneId] = useState(null);
  const [selectedZone, setSelectedZone] = useState(null);
  const [note, setNote] = useState("");
  const [filter, setFilter] = useState({ status: "all", userId: "all" });
  const [activeTab, setActiveTab] = useState("map");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [mapReady, setMapReady] = useState(false);
  const [showUserModal, setShowUserModal] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [newUserName, setNewUserName] = useState("");
  const [newUserRole, setNewUserRole] = useState("rep");
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [leaderboardPeriod, setLeaderboardPeriod] = useState('week');
  const [leaderboardType, setLeaderboardType] = useState('d2d');
  const [trackingEnabled, setTrackingEnabled] = useState(false);
  const [showLiveTracking, setShowLiveTracking] = useState(true);
  const [toastMessage, setToastMessage] = useState(null);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [geocoding, setGeocoding] = useState(false);
  const [addressSearch, setAddressSearch] = useState("");
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  
  // NEW STATES FOR ADDED FEATURES
  const [showIconModal, setShowIconModal] = useState(false);
  const [selectedIcon, setSelectedIcon] = useState('üìç');
  const [showContactModal, setShowContactModal] = useState(false);
  const [contactData, setContactData] = useState({ name: '', phone: '', email: '', address: '', notes: '' });
  const [pendingPinData, setPendingPinData] = useState(null);
  const [showLocationSplash, setShowLocationSplash] = useState(false);
  
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const supabase = useRef(null);
  const locationWatchId = useRef(null);
  const locationUpdateInterval = useRef(null);
  const searchTimeoutRef = useRef(null);
  
  const zoneLayerRef = useRef(null);
  const pinLayerRef = useRef(null);
  const liveLayerRef = useRef(null);
  const userLocationLayerRef = useRef(null);

  async function setSupabaseUser(userId) {
    if (!userId || !supabase.current) return;
    try {
      await supabase.current.rpc('set_current_user', { user_id: userId });
    } catch (e) {
      console.error('Error setting user context:', e);
    }
  }

  function showToast(message, duration = 4000) {
    setToastMessage(message);
    setTimeout(() => setToastMessage(null), duration);
  }

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // AUTO-LOCATION ON STARTUP
  useEffect(() => {
    supabase.current = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Load saved icon preference
    const savedIcon = localStorage.getItem('selectedIcon');
    if (savedIcon) {
      setSelectedIcon(savedIcon);
    } else {
      // First time - show icon selection after location detected
      setTimeout(() => {
        setShowIconModal(true);
      }, 2000);
    }
    
    loadData();
    
    const saved = localStorage.getItem('current_user_id');
    if (saved) {
      try {
        const user = JSON.parse(saved);
        setCurrentUser(user);
        
        // AUTO-DETECT LOCATION ON STARTUP
        setShowLocationSplash(true);
        requestLocationPermissionWithSplash(user);
      } catch (e) {
        console.error('Error parsing saved user:', e);
      }
    }
  }, []);

  // NEW: Request location with splash screen
  async function requestLocationPermissionWithSplash(user) {
    if (!navigator.geolocation) {
      setShowLocationSplash(false);
      showToast('‚ö†Ô∏è Geolocation not supported on this device');
      return;
    }

    try {
      const position = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        });
      });

      // Set initial location
      setCurrentLocation({
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        accuracy: position.coords.accuracy,
        timestamp: Date.now()
      });

      // Center map on user location if map is ready
      if (mapInstanceRef.current) {
        mapInstanceRef.current.setView([position.coords.latitude, position.coords.longitude], 16);
      }

      // Start tracking
      startLocationTracking(user);
      
      setShowLocationSplash(false);
      showToast('‚úÖ Location detected! Ready to track.', 3000);
    } catch (error) {
      console.error('Location error:', error);
      setShowLocationSplash(false);
      showToast('‚ö†Ô∏è Could not detect location. Enable GPS for accurate tracking.', 5000);
    }
  }

  useEffect(() => {
    if (!supabase.current) return;
    loadLiveLocations();
    const interval = setInterval(loadLiveLocations, 10000);
    return () => clearInterval(interval);
  }, []);

  async function loadData() {
    try {
      const [pinsRes, zonesRes, teamRes] = await Promise.all([
        supabase.current.from('pins').select('*'),
        supabase.current.from('zones').select('*'),
        supabase.current.from('team_members').select('*')
      ]);
      
      if (pinsRes.data) setPins(pinsRes.data);
      if (zonesRes.data) setZones(zonesRes.data);
      if (teamRes.data) setTeamMembers(teamRes.data);
      
      setLoading(false);
    } catch (e) {
      console.error('Load error:', e);
      setLoading(false);
    }
  }

  async function loadLiveLocations() {
    try {
      const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      const { data, error } = await supabase.current
        .from('live_locations')
        .select('*')
        .gte('last_updated', fiveMinutesAgo)
        .eq('is_active', true);
      if (!error && data) setLiveLocations(data);
    } catch (e) {}
  }

  async function requestLocationPermission(user) {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      () => startLocationTracking(user),
      () => {}
    );
  }

  function startLocationTracking(user) {
    if (!user || locationWatchId.current) return;
    setTrackingEnabled(true);
    locationWatchId.current = navigator.geolocation.watchPosition(
      (position) => {
        setCurrentLocation({
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: Date.now()
        });
      },
      () => {},
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
    );

    if (locationUpdateInterval.current) clearInterval(locationUpdateInterval.current);
    locationUpdateInterval.current = setInterval(() => updateLiveLocation(user), 30000);
    updateLiveLocation(user);
  }

  function stopLocationTracking() {
    if (locationWatchId.current) {
      navigator.geolocation.clearWatch(locationWatchId.current);
      locationWatchId.current = null;
    }
    if (locationUpdateInterval.current) {
      clearInterval(locationUpdateInterval.current);
      locationUpdateInterval.current = null;
    }
    setTrackingEnabled(false);
    updateLiveLocation(currentUser, false);
  }

  async function updateLiveLocation(user, isActive = true) {
    if (!user || !currentLocation || !supabase.current) return;
    try {
      await setSupabaseUser(user.id);
      const locationData = {
        team_member_id: user.id,
        lat: currentLocation.lat,
        lng: currentLocation.lng,
        accuracy: currentLocation.accuracy,
        is_active: isActive,
        last_updated: new Date().toISOString()
      };
      await supabase.current.from('live_locations').upsert([locationData], { onConflict: 'team_member_id' });
    } catch (e) {
      console.error('Error updating live location:', e);
    }
  }

  async function savePin(pinData) {
    try {
      await setSupabaseUser(currentUser.id);
      const { data, error } = await supabase.current.from('pins').insert([pinData]).select();
      if (error) throw error;
      setPins(prev => [...prev, pinData]);
      return true;
    } catch (e) {
      console.error('Error saving pin:', e);
      return false;
    }
  }

  async function deletePin(pinId) {
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('pins').delete().eq('id', pinId);
      setPins(prev => prev.filter(p => p.id !== pinId));
      showToast('üóëÔ∏è Pin deleted');
    } catch (e) {
      showToast('‚ùå Error deleting pin: ' + e.message);
    }
  }

  async function saveZone(zoneData) {
    try {
      await setSupabaseUser(currentUser.id);
      const { data, error } = await supabase.current.from('zones').insert([zoneData]).select();
      if (error) throw error;
      setZones(prev => [...prev, zoneData]);
      return true;
    } catch (e) {
      console.error('Error saving zone:', e);
      return false;
    }
  }

  async function deleteZone(zoneId) {
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').delete().eq('id', zoneId);
      setZones(prev => prev.filter(z => z.id !== zoneId));
      setSelectedZone(null);
      showToast('üóëÔ∏è Zone deleted');
    } catch (e) {
      showToast('‚ùå Error deleting zone: ' + e.message);
    }
  }

  async function assignZone(zoneId, userId) {
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').update({ assigned_to: userId }).eq('id', zoneId);
      setZones(prev => prev.map(z => z.id === zoneId ? { ...z, assigned_to: userId } : z));
      showToast('‚úÖ Zone assigned!');
    } catch (e) {
      showToast('‚ùå Error assigning zone: ' + e.message);
    }
  }

  async function addTeamMember() {
    if (!newUserName.trim()) {
      showToast('‚ö†Ô∏è Please enter a name!');
      return;
    }
    
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can add team members!');
      return;
    }
    
    const newMember = {
      id: `user-${Date.now()}`,
      name: newUserName,
      color: COLORS[teamMembers.length % COLORS.length],
      role: newUserRole,
      created_at: new Date().toISOString()
    };
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').insert([newMember]);
      setTeamMembers(prev => [...prev, newMember]);
      setNewUserName("");
      setNewUserRole("rep");
      setShowUserModal(false);
      showToast(`‚úÖ ${newUserName} added as ${newUserRole}!`);
    } catch (e) {
      showToast('‚ùå Error adding team member: ' + e.message);
    }
  }

  function selectCurrentUser(user) {
    setCurrentUser(user);
    localStorage.setItem('current_user_id', JSON.stringify(user));
    
    // AUTO-DETECT LOCATION WHEN USER SELECTED
    setShowLocationSplash(true);
    requestLocationPermissionWithSplash(user);
  }

  function getLeaderboard() {
    const now = new Date();
    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
    startOfWeek.setHours(0, 0, 0, 0);
    const startOfDay = new Date();
    startOfDay.setHours(0, 0, 0, 0);

    // Define which statuses count for each leaderboard type
    const d2dStatuses = ['estimate', 'callback', 'notinterested', 'knocked'];
    const flyerStatuses = ['flyer', 'flyer_dropped'];
    const countStatuses = leaderboardType === 'd2d' ? d2dStatuses : flyerStatuses;

    return teamMembers.map(member => {
      const memberPins = pins.filter(p => p.team_member_id === member.id);
      const weekPins = memberPins.filter(p => new Date(p.created_at) >= startOfWeek);
      const dayPins = memberPins.filter(p => new Date(p.created_at) >= startOfDay);

      let count = 0;
      if (leaderboardPeriod === 'week') count = weekPins.filter(p => countStatuses.includes(p.status)).length;
      else if (leaderboardPeriod === 'day') count = dayPins.filter(p => countStatuses.includes(p.status)).length;
      else count = memberPins.filter(p => countStatuses.includes(p.status)).length;

      const liveLocation = liveLocations.find(l => l.team_member_id === member.id);
      const isOnline = liveLocation && new Date(liveLocation.last_updated) > new Date(Date.now() - 5 * 60 * 1000);

      return { ...member, knockCount: count, isOnline, liveLocation };
    }).sort((a, b) => b.knockCount - a.knockCount);
  }

  // üîç ADDRESS SEARCH FUNCTIONALITY
  useEffect(() => {
    if (searchTimeoutRef.current) {
      clearTimeout(searchTimeoutRef.current);
    }

    if (addressSearch.trim().length < 3) {
      setSearchResults([]);
      return;
    }

    setSearching(true);
    searchTimeoutRef.current = setTimeout(async () => {
      const results = await forwardGeocode(addressSearch);
      setSearchResults(results);
      setSearching(false);
    }, 500);

    return () => {
      if (searchTimeoutRef.current) {
        clearTimeout(searchTimeoutRef.current);
      }
    };
  }, [addressSearch]);

  function selectSearchResult(result) {
    if (mapInstanceRef.current) {
      mapInstanceRef.current.setView([result.lat, result.lng], 18);
      setAddressSearch("");
      setSearchResults([]);
    }
  }

  // NEW: Icon selection functions
  function saveIconSelection() {
    localStorage.setItem('selectedIcon', selectedIcon);
    setShowIconModal(false);
    showToast(`Icon set to ${selectedIcon}`, 2000);
  }

  // NEW: Contact modal functions
  function openContactModal(pinData, leadType) {
    setPendingPinData(pinData);
    setContactData({ name: '', phone: '', email: '', address: '', notes: '' });
    setShowContactModal(true);
  }

  function closeContactModal() {
    setShowContactModal(false);
    setPendingPinData(null);
    setContactData({ name: '', phone: '', email: '', address: '', notes: '' });
  }

  async function saveContactAndPin() {
    if (!contactData.name.trim() || !contactData.phone.trim()) {
      showToast('‚ùå Name and phone are required!', 3000);
      return;
    }

    if (!pendingPinData) return;

    setSaving(true);
    const leadTypeLabel = LEAD_TYPES[pendingPinData.status]?.label || pendingPinData.status;
    
    // Add contact info to pin data
    const finalPinData = {
      ...pendingPinData,
      contact_name: contactData.name,
      contact_phone: contactData.phone,
      contact_email: contactData.email || null,
      contact_address: contactData.address || null,
      contact_notes: contactData.notes || null
    };

    const success = await savePin(finalPinData);
    
    setSaving(false);
    closeContactModal();
    
    if (success) {
      const gpsAge = getGPSAge(currentLocation);
      const verification = getVerificationStatus(finalPinData.distance_from_pin);
      if (verification.status === 'verified') {
        showToast(`‚úÖ ${leadTypeLabel} for ${contactData.name} saved! (${Math.round(finalPinData.distance_from_pin)}ft, GPS: ${gpsAge}s)`, 5000);
      } else {
        showToast(`‚ö†Ô∏è ${leadTypeLabel} for ${contactData.name} saved - ${verification.label} (${Math.round(finalPinData.distance_from_pin)}ft)`, 5000);
      }
    } else {
      showToast('‚ùå Error saving pin', 3000);
    }
  }

  useEffect(() => {
    if (!mapRef.current || mapInstanceRef.current || loading) return;
    
    const map = L.map(mapRef.current, {
      center: [47.6062, -122.3321],
      zoom: isMobile ? 12 : 13,
      zoomControl: !isMobile,
      tap: true,
      tapTolerance: 15
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    if (isMobile) L.control.zoom({ position: 'topright' }).addTo(map);

    zoneLayerRef.current = L.layerGroup().addTo(map);
    pinLayerRef.current = L.layerGroup().addTo(map);
    liveLayerRef.current = L.layerGroup().addTo(map);
    userLocationLayerRef.current = L.layerGroup().addTo(map);

    mapInstanceRef.current = map;
    
    setTimeout(() => {
      map.invalidateSize();
      setMapReady(true);
    }, 300);
  }, [loading, isMobile]);

  useEffect(() => {
    const map = mapInstanceRef.current;
    if (!map || !mapReady) return;

    const handleClick = async (e) => {
      const { lat, lng } = e.latlng;
      
      if (mode === "drop-pin" && currentUser) {
        if (!currentLocation) {
          showToast('‚ö†Ô∏è Enable GPS tracking first!');
          return;
        }

        if (!isGPSFresh(currentLocation)) {
          const age = getGPSAge(currentLocation);
          showToast(`‚ö†Ô∏è GPS data is ${age}s old! Move around to get fresh GPS signal, then try again.`, 6000);
          return;
        }

        setSaving(true);
        setGeocoding(true);

        try {
          // üè† GET FULL ADDRESS + SNAP TO BUILDING
          const addressData = await reverseGeocode(lat, lng);
          
          let finalLat = lat;
          let finalLng = lng;
          let address = null;
          let shortAddress = null;
          
          if (addressData && addressData.fullAddress !== 'Address Not Found') {
            finalLat = addressData.lat;
            finalLng = addressData.lng;
            address = addressData.fullAddress;
            shortAddress = addressData.shortAddress;
            
            showToast(`üìç Found: ${shortAddress}`, 3000);
          } else {
            showToast('‚ö†Ô∏è No address found - saving location anyway', 3000);
          }

          const distance = calculateDistance(currentLocation.lat, currentLocation.lng, finalLat, finalLng);
          const verification = getVerificationStatus(distance);
          const clickedZone = zones.find(z => {
            if (!z.points || z.points.length < 3) return false;
            return isPointInPolygon([finalLat, finalLng], z.points);
          });

          const newPinData = {
            id: `pin-${Date.now()}`,
            lat: finalLat, 
            lng: finalLng, 
            status,
            address: address,
            rep_name: currentUser.name,
            team_member_id: currentUser.id,
            zone_id: clickedZone?.id || null,
            note: note || null,
            actual_lat: currentLocation.lat,
            actual_lng: currentLocation.lng,
            distance_from_pin: Math.round(distance),
            verification_status: verification.status,
            created_at: new Date().toISOString()
          };
          
          setGeocoding(false);
          
          // NEW: Check if lead type requires contact info (A/B/C/K)
          const needsContact = ['estimate', 'callback', 'notinterested', 'knocked'].includes(status);
          
          if (needsContact) {
            // Show contact modal for A/B/C/K leads
            setSaving(false);
            openContactModal(newPinData, status);
          } else {
            // FD (flyer_dropped) and others - save directly
            await setSupabaseUser(currentUser.id);
            const { data, error } = await supabase.current.from('pins').insert([newPinData]).select();
            
            setSaving(false);
            
            if (error) {
              showToast('‚ùå Error saving pin: ' + error.message);
            } else {
              setPins(prev => [...prev, newPinData]);
              setNote("");
              const leadTypeLabel = LEAD_TYPES[status]?.label || status;
              const gpsAge = getGPSAge(currentLocation);
              if (verification.status === 'verified') {
                showToast(`‚úÖ ${leadTypeLabel} at ${shortAddress || 'location'}! (${Math.round(distance)}ft, GPS: ${gpsAge}s)`, 5000);
              } else {
                showToast(`‚ö†Ô∏è ${leadTypeLabel} ${verification.label} (${Math.round(distance)}ft, GPS: ${gpsAge}s)`, 5000);
              }
            }
          }
        } catch (err) {
          console.error('Pin creation error:', err);
          setSaving(false);
          setGeocoding(false);
          showToast('‚ùå Error creating pin');
        }
      } else if (mode === "draw-zone" && currentUser) {
        if (currentUser.role !== 'admin') {
          showToast('‚ö†Ô∏è Only admins can create zones!');
          return;
        }

        if (!activeZoneId) {
          const newZone = {
            id: `zone-${Date.now()}`,
            name: `Zone ${zones.length + 1}`,
            color: COLORS[zones.length % COLORS.length],
            points: [[lat, lng]],
            assigned_to: null,
            created_at: new Date().toISOString()
          };
          setZones(prev => [...prev, newZone]);
          setActiveZoneId(newZone.id);
          showToast('üé® Drawing zone - click to add points');
        } else {
          const updatedZones = zones.map(z => {
            if (z.id === activeZoneId) {
              return { ...z, points: [...z.points, [lat, lng]] };
            }
            return z;
          });
          setZones(updatedZones);
        }
      } else if (mode === "select") {
        const clickedZone = zones.find(z => {
          if (!z.points || z.points.length < 3) return false;
          return isPointInPolygon([lat, lng], z.points);
        });
        
        if (clickedZone) {
          setSelectedZone(clickedZone);
        }
      }
    };

    map.on('click', handleClick);

    return () => {
      map.off('click', handleClick);
    };
  }, [mapReady, mode, currentUser, currentLocation, status, note, zones, activeZoneId]);

  async function completeZone() {
    if (!activeZoneId) return;
    
    const zone = zones.find(z => z.id === activeZoneId);
    if (!zone || zone.points.length < 3) {
      showToast('‚ö†Ô∏è A zone needs at least 3 points!');
      return;
    }

    const success = await saveZone(zone);
    if (success) {
      setActiveZoneId(null);
      showToast('‚úÖ Zone saved!');
    } else {
      showToast('‚ùå Error saving zone');
    }
  }

  function cancelZone() {
    if (!activeZoneId) return;
    setZones(prev => prev.filter(z => z.id !== activeZoneId));
    setActiveZoneId(null);
    showToast('üóëÔ∏è Zone cancelled');
  }

  // Render zones on map
  useEffect(() => {
    if (!zoneLayerRef.current) return;
    zoneLayerRef.current.clearLayers();

    zones.forEach(zone => {
      if (!zone.points || zone.points.length < 3) return;

      const polygon = L.polygon(zone.points, {
        color: zone.color,
        fillColor: zone.color,
        fillOpacity: 0.2,
        weight: 3
      }).addTo(zoneLayerRef.current);

      const assignedUser = zone.assigned_to ? teamMembers.find(u => u.id === zone.assigned_to) : null;
      const popupContent = `
        <div style="padding: 0.5rem;">
          <strong>${zone.name}</strong><br/>
          ${assignedUser ? `Assigned to: ${assignedUser.name}` : 'Unassigned'}
        </div>
      `;
      polygon.bindPopup(popupContent);
    });
  }, [zones, teamMembers]);

  // Render pins on map
  useEffect(() => {
    if (!pinLayerRef.current) return;
    pinLayerRef.current.clearLayers();

    const filteredPins = pins.filter(pin => {
      const statusMatch = filter.status === "all" || pin.status === filter.status;
      const userMatch = filter.userId === "all" || pin.team_member_id === filter.userId;
      return statusMatch && userMatch;
    });

    filteredPins.forEach(pin => {
      const leadType = LEAD_TYPES[pin.status];
      if (!leadType) return;

      // Use custom icon if available
      const iconHtml = `<div style="font-size: 24px;">${selectedIcon}</div>`;
      
      const icon = L.divIcon({
        html: iconHtml,
        className: '',
        iconSize: [24, 24],
        iconAnchor: [12, 24]
      });

      const marker = L.marker([pin.lat, pin.lng], { icon }).addTo(pinLayerRef.current);

      const verification = getVerificationStatus(pin.distance_from_pin || 0);
      
      // Include contact info in popup if available
      const popupContent = `
        <div style="padding: 0.5rem; min-width: 200px;">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <div style="font-size: 1.5rem;">${leadType.icon}</div>
            <strong style="color: ${leadType.color};">${leadType.label}</strong>
          </div>
          ${pin.contact_name ? `<div><strong>Name:</strong> ${pin.contact_name}</div>` : ''}
          ${pin.contact_phone ? `<div><strong>Phone:</strong> ${pin.contact_phone}</div>` : ''}
          ${pin.contact_email ? `<div><strong>Email:</strong> ${pin.contact_email}</div>` : ''}
          ${pin.contact_address ? `<div><strong>Address:</strong> ${pin.contact_address}</div>` : ''}
          ${pin.address ? `<div><strong>Location:</strong> ${pin.address}</div>` : ''}
          <div><strong>Rep:</strong> ${pin.rep_name}</div>
          ${pin.note ? `<div><strong>Note:</strong> ${pin.note}</div>` : ''}
          ${pin.contact_notes ? `<div><strong>Contact Notes:</strong> ${pin.contact_notes}</div>` : ''}
          <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 0.25rem; color: ${verification.color}; font-weight: 600;">
              ${verification.icon} ${verification.label} (${pin.distance_from_pin}ft)
            </div>
          </div>
          <button onclick="window.deletePin('${pin.id}')" style="margin-top: 0.5rem; width: 100%; padding: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">üóëÔ∏è Delete Pin</button>
        </div>
      `;

      marker.bindPopup(popupContent);
    });

    // Expose deletePin to window for popup button
    window.deletePin = (pinId) => {
      deletePin(pinId);
    };
  }, [pins, filter, selectedIcon, teamMembers]);

  // Render live locations
  useEffect(() => {
    if (!liveLayerRef.current || !showLiveTracking) return;
    liveLayerRef.current.clearLayers();

    liveLocations.forEach(loc => {
      const member = teamMembers.find(m => m.id === loc.team_member_id);
      if (!member) return;

      const icon = L.divIcon({
        html: `
          <div style="
            width: 40px;
            height: 40px;
            background: ${member.color};
            border: 4px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          ">
            ${member.name.charAt(0)}
          </div>
        `,
        className: 'tracking-indicator',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
      });

      const marker = L.marker([loc.lat, loc.lng], { icon }).addTo(liveLayerRef.current);
      
      marker.bindPopup(`
        <div style="padding: 0.5rem;">
          <strong>${member.name}</strong><br/>
          üü¢ Live Location<br/>
          Updated: ${new Date(loc.last_updated).toLocaleTimeString()}
        </div>
      `);
    });
  }, [liveLocations, teamMembers, showLiveTracking]);

  // Render user's current location
  useEffect(() => {
    if (!userLocationLayerRef.current || !currentLocation) return;
    userLocationLayerRef.current.clearLayers();

    const icon = L.divIcon({
      html: '<div style="font-size: 30px;" class="tracking-indicator">üìç</div>',
      className: '',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });

    L.marker([currentLocation.lat, currentLocation.lng], { icon })
      .addTo(userLocationLayerRef.current)
      .bindPopup('üìç You are here');

    const circle = L.circle([currentLocation.lat, currentLocation.lng], {
      radius: currentLocation.accuracy || 50,
      color: '#3b82f6',
      fillColor: '#3b82f6',
      fillOpacity: 0.1,
      weight: 2
    }).addTo(userLocationLayerRef.current);
  }, [currentLocation]);

  const gpsAge = getGPSAge(currentLocation);
  const gpsIsFresh = isGPSFresh(currentLocation);

  const stats = {
    total: pins.length,
    estimates: pins.filter(p => p.status === 'estimate').length,
    callbacks: pins.filter(p => p.status === 'callback').length,
    notinterested: pins.filter(p => p.status === 'notinterested').length,
    flyers: pins.filter(p => ['flyer', 'flyer_dropped'].includes(p.status)).length,
    verified: pins.filter(p => p.verification_status === 'verified').length,
    questionable: pins.filter(p => p.verification_status === 'questionable').length,
    suspicious: pins.filter(p => p.verification_status === 'suspicious').length,
    withAddress: pins.filter(p => p.address && p.address !== 'Address Not Found').length,
    withoutAddress: pins.filter(p => !p.address || p.address === 'Address Not Found').length,
    onlineUsers: liveLocations.filter(l => new Date(l.last_updated) > new Date(Date.now() - 5 * 60 * 1000)).length
  };

  function LeaderboardView() {
    const leaderboard = getLeaderboard();
    
    return (
      <div className="stat-card">
        <div style={{marginBottom:'1rem'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
            <h3 style={{fontSize:'1.125rem',fontWeight:'700',color:'#1e293b'}}>üèÜ Leaderboard</h3>
            <div style={{fontSize:'0.875rem',color:'#64748b',fontWeight:'600'}}>
              {leaderboardType === 'd2d' ? 'üö™ Door-to-Door' : 'üì¨ Flyers'}
            </div>
          </div>
          
          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem'}}>
            <button onClick={() => setLeaderboardType('d2d')} className="modern-button" style={{flex:1,padding:'0.625rem',borderRadius:'0.75rem',border:leaderboardType==='d2d'?'none':'2px solid #e5e7eb',background:leaderboardType==='d2d'?'#10b981':'white',color:leaderboardType==='d2d'?'white':'#64748b',fontWeight:'700',fontSize:'0.8125rem'}}>
              üö™ D2D
            </button>
            <button onClick={() => setLeaderboardType('flyer')} className="modern-button" style={{flex:1,padding:'0.625rem',borderRadius:'0.75rem',border:leaderboardType==='flyer'?'none':'2px solid #e5e7eb',background:leaderboardType==='flyer'?'#3b82f6':'white',color:leaderboardType==='flyer'?'white':'#64748b',fontWeight:'700',fontSize:'0.8125rem'}}>
              üì¨ Flyers
            </button>
          </div>

          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem'}}>
            {[['day','Today'],['week','This Week'],['all','All Time']].map(([p,label]) => (
              <button key={p} onClick={()=>setLeaderboardPeriod(p)} className="modern-button" style={{flex:1,padding:'0.625rem',borderRadius:'0.75rem',border:leaderboardPeriod===p?'none':'2px solid #e5e7eb',background:leaderboardPeriod===p?'#3b82f6':'white',color:leaderboardPeriod===p?'white':'#64748b',fontWeight:'700',fontSize:'0.75rem'}}>{label}</button>
            ))}
          </div>
        </div>

        <div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>
          {leaderboard.map((member, idx) => (
            <div key={member.id} style={{padding:'1rem',background:idx===0?'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)':'white',borderRadius:'0.75rem',border:idx===0?'2px solid #f59e0b':'2px solid #e5e7eb',display:'flex',alignItems:'center',gap:'1rem'}}>
              <div style={{fontSize:'1.5rem',fontWeight:'bold',color:idx===0?'#f59e0b':'#64748b',minWidth:'2rem',textAlign:'center'}}>
                {idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}`}
              </div>
              <div style={{width:'48px',height:'48px',borderRadius:'50%',background:member.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.25rem',boxShadow:'0 4px 12px rgba(0,0,0,0.15)',position:'relative'}}>
                {member.name.charAt(0)}
                {member.isOnline && (
                  <div style={{position:'absolute',top:'-2px',right:'-2px',width:'16px',height:'16px',background:'#10b981',border:'3px solid white',borderRadius:'50%'}}></div>
                )}
              </div>
              <div style={{flex:1}}>
                <div style={{fontWeight:'700',fontSize:'1rem',color:'#1e293b'}}>{member.name}</div>
                <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600'}}>
                  {member.role === 'admin' ? 'üëë Admin' : 'üë§ Rep'}
                  {member.isOnline && ' ‚Ä¢ üü¢ Online'}
                </div>
              </div>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:'1.75rem',fontWeight:'bold',color:idx===0?'#f59e0b':'#3b82f6'}}>{member.knockCount}</div>
                <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600'}}>
                  {leaderboardType === 'd2d' ? 'knocks' : 'flyers'}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  if (loading) {
    return (
      <div style={{height:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'#f8fafc'}}>
        <div style={{textAlign:'center'}}>
          <div className="spinner" style={{margin:'0 auto',width:'50px',height:'50px',borderWidth:'5px'}}></div>
          <p style={{marginTop:'1.5rem',fontWeight:'700',fontSize:'1.25rem',color:'#1e293b'}}>Loading RepZone...</p>
        </div>
      </div>
    );
  }

  if (!currentUser) {
    return (
      <div style={{height:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',padding:'1rem'}}>
        <div style={{background:'white',borderRadius:'2rem',padding:'2.5rem',maxWidth:'440px',width:'100%',boxShadow:'0 20px 60px rgba(0,0,0,0.3)',animation:'fadeIn 0.5s ease'}}>
          <div style={{textAlign:'center',marginBottom:'2rem'}}>
            <div style={{fontSize:'4rem',marginBottom:'1rem'}}>üó∫Ô∏è</div>
            <h1 style={{fontSize:'2rem',fontWeight:'bold',marginBottom:'0.75rem',color:'#1e293b'}}>RepZone Tracker</h1>
            <p style={{color:'#64748b',fontWeight:'600'}}>Select your profile to start tracking</p>
          </div>

          {teamMembers.length === 0 ? (
            <div style={{textAlign:'center',padding:'2rem'}}>
              <p style={{color:'#64748b',marginBottom:'1rem'}}>No team members found</p>
              <p style={{fontSize:'0.875rem',color:'#94a3b8'}}>Please add team members in the database</p>
            </div>
          ) : (
            <div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>
              {teamMembers.map(user => (
                <button key={user.id} onClick={() => selectCurrentUser(user)} className="modern-button" style={{padding:'1.25rem',background:user.color,color:'white',border:'none',borderRadius:'1rem',display:'flex',alignItems:'center',gap:'1rem',textAlign:'left',boxShadow:'0 4px 12px rgba(0,0,0,0.2)'}}>
                  <div style={{width:'56px',height:'56px',background:'rgba(255,255,255,0.3)',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:'bold',fontSize:'1.75rem'}}>
                    {user.name.charAt(0)}
                  </div>
                  <div style={{flex:1}}>
                    <div style={{fontSize:'1.25rem',fontWeight:'bold',marginBottom:'0.25rem'}}>{user.name}</div>
                    <div style={{fontSize:'0.875rem',opacity:0.9,fontWeight:'600'}}>{user.role === 'admin' ? 'üëë Admin' : 'üë§ Rep'}</div>
                  </div>
                  <div style={{fontSize:'1.5rem'}}>‚Üí</div>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  const SidebarContent = () => (
    <>
      {currentLocation && (
        <div className="stat-card" style={{marginBottom:'1.25rem',background:'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)',border:'2px solid #3b82f6'}}>
          <div style={{display:'flex',alignItems:'center',gap:'1rem',marginBottom:'1rem'}}>
            <div style={{width:'64px',height:'64px',borderRadius:'50%',background:currentUser.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'2rem',boxShadow:'0 4px 12px rgba(0,0,0,0.15)'}}>
              {currentUser.name.charAt(0)}
            </div>
            <div style={{flex:1}}>
              <div style={{fontWeight:'700',fontSize:'1.125rem',color:'#1e3a8a'}}>{currentUser.name}</div>
              <div style={{fontSize:'0.875rem',color:'#3b82f6',fontWeight:'600'}}>{currentUser.role === 'admin' ? 'üëë Admin' : 'üë§ Rep'}</div>
            </div>
          </div>

          {activeTab === 'map' && addressSearch.length === 0 && (
            <div style={{marginTop:'1rem'}}>
              <input value={addressSearch} onChange={e=>setAddressSearch(e.target.value)} placeholder="üîç Search address..." style={{width:'100%',padding:'0.875rem',border:'2px solid #93c5fd',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}} />
              {searching && <p style={{fontSize:'0.75rem',color:'#64748b',marginTop:'0.5rem',fontWeight:'600'}}>Searching...</p>}
              {searchResults.length > 0 && (
                <div style={{marginTop:'0.75rem',maxHeight:'200px',overflowY:'auto',border:'2px solid #93c5fd',borderRadius:'0.75rem',background:'white'}}>
                  {searchResults.map((result, idx) => (
                    <button key={idx} onClick={() => selectSearchResult(result)} className="modern-button" style={{width:'100%',padding:'0.875rem',textAlign:'left',borderBottom:idx < searchResults.length - 1 ? '1px solid #e0f2fe' : 'none',background:'white',border:'none',fontSize:'0.875rem',fontWeight:'600',color:'#1e293b'}}>
                      üìç {result.displayName}
                    </button>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {activeTab === 'map' && (
        <>
          <div className="stat-card" style={{marginBottom:'1.25rem',background:trackingEnabled?'#dcfce7':'#fee2e2',border:`2px solid ${trackingEnabled?'#10b981':'#ef4444'}`}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
              <b style={{fontSize:'0.9375rem',fontWeight:'700'}}>üìç GPS Tracking</b>
              <button onClick={() => trackingEnabled ? stopLocationTracking() : requestLocationPermission(currentUser)} className="modern-button" style={{padding:'0.625rem 1.25rem',background:trackingEnabled?'#ef4444':'#10b981',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.8125rem',boxShadow:`0 2px 8px ${trackingEnabled?'rgba(239,68,68,0.3)':'rgba(16,185,129,0.3)'}`}}>{trackingEnabled ? 'Stop' : 'Start'}</button>
            </div>
            <p style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>
              {trackingEnabled ? (
                gpsAge !== null ? `‚úÖ Active - GPS is ${gpsAge}s old ${gpsIsFresh ? '(Fresh ‚úÖ)' : '(Stale ‚ö†Ô∏è)'}` : '‚úÖ Location tracking active'
              ) : '‚ö†Ô∏è Enable to verify pin locations'}
            </p>
          </div>

          {currentUser?.role === 'admin' && (
            <div className="stat-card" style={{marginBottom:'1.25rem',background:'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',border:'2px solid #3b82f6'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                <b style={{fontSize:'0.9375rem',fontWeight:'700',color:'#1e3a8a'}}>üë• Team Management</b>
              </div>
              <p style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600',marginBottom:'0.75rem'}}>Add new team members to your organization</p>
              <button onClick={() => setShowUserModal(true)} className="modern-button" style={{width:'100%',padding:'0.875rem',background:'#3b82f6',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.875rem',boxShadow:'0 2px 8px rgba(59,130,246,0.3)'}}>‚ûï Add Team Member</button>
            </div>
          )}

          <div className="stat-card" style={{marginBottom:'1.25rem'}}>
            <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.75rem',color:'#1e293b'}}>üéØ Mode</label>
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'0.75rem'}}>
              {[['drop-pin','üìç Pin'],['draw-zone','‚úèÔ∏è Zone'],['select','üëÜ Select']].map(([m,label]) => (
                <button key={m} onClick={()=>setMode(m)} className="modern-button" style={{padding:'1rem 0.75rem',borderRadius:'0.75rem',border:mode===m?'none':'2px solid #e5e7eb',background:mode===m?'#3b82f6':'white',color:mode===m?'white':'#64748b',fontSize:'0.9375rem',fontWeight:'700',boxShadow:mode===m?'0 4px 12px rgba(59,130,246,0.3)':'none'}}>{label}</button>
              ))}
            </div>
            {mode === "draw-zone" && currentUser?.role !== 'admin' && (
              <p style={{fontSize:'0.8125rem',color:'#ef4444',marginTop:'0.75rem',fontWeight:'700'}}>‚ö†Ô∏è Only admins can create zones</p>
            )}
            {mode === "select" && (
              <p style={{fontSize:'0.8125rem',color:'#64748b',marginTop:'0.75rem',fontWeight:'600'}}>üí° Click on a zone to assign or delete it</p>
            )}
            {mode === "drop-pin" && (
              <p style={{fontSize:'0.8125rem',color:'#10b981',marginTop:'0.75rem',fontWeight:'700'}}>‚úÖ Click map - gets full address!</p>
            )}
          </div>

          {mode === "drop-pin" && (
            <div className="stat-card" style={{background:'linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%)',border:'2px solid #3b82f6',marginBottom:'1.25rem'}}>
              <label style={{display:'block',fontSize:'0.9375rem',fontWeight:'700',marginBottom:'0.875rem',color:'#1e3a8a'}}>üí∞ Lead Type</label>
              <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem',marginBottom:'1rem'}}>
                {[['estimate','üí∞','A','#10b981'],['callback','üìû','B','#f59e0b'],['notinterested','üìã','C','#64748b'],['flyer_dropped','üì¨','FD','#3b82f6']].map(([s,icon,display,color]) => (
                  <button key={s} onClick={()=>setStatus(s)} className="modern-button" style={{padding:'1rem',borderRadius:'0.75rem',border:status===s?'none':'2px solid #bfdbfe',background:status===s?color:'white',color:status===s?'white':'#64748b',fontSize:'1.75rem',display:'flex',flexDirection:'column',alignItems:'center',gap:'0.375rem',boxShadow:status===s?`0 4px 12px ${color}50`:'none'}}>
                    <div>{icon}</div>
                    <div style={{fontSize:'0.8125rem',fontWeight:'700'}}>{display}</div>
                  </button>
                ))}
              </div>
              <input value={note} onChange={e=>setNote(e.target.value)} placeholder="Note (gate code, dog, etc.)" style={{width:'100%',padding:'0.875rem',border:'2px solid #93c5fd',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}} />
              {!trackingEnabled && (
                <p style={{marginTop:'0.75rem',fontSize:'0.8125rem',color:'#ef4444',fontWeight:'700'}}>‚ö†Ô∏è Enable GPS tracking to verify pin locations</p>
              )}
              {trackingEnabled && !gpsIsFresh && (
                <p style={{marginTop:'0.75rem',fontSize:'0.8125rem',color:'#f59e0b',fontWeight:'700'}}>‚ö†Ô∏è GPS data is stale - walk around to refresh</p>
              )}
            </div>
          )}

          <div className="stat-card">
            <h3 style={{fontSize:'1.0625rem',fontWeight:'700',marginBottom:'1rem',color:'#1e293b'}}>üìä Quick Stats</h3>
            <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem'}}>
              {[
                ['üí∞',stats.estimates,'Estimates','#10b981'],
                ['üìû',stats.callbacks,'Callbacks','#f59e0b'],
                ['‚úÖ',stats.verified,'Verified','#10b981'],
                ['üö´',stats.suspicious,'Suspicious','#ef4444']
              ].map(([icon,count,label,color]) => (
                <div key={label} style={{padding:'1rem',background:`${color}15`,borderRadius:'0.75rem',border:`2px solid ${color}`,textAlign:'center'}}>
                  <div style={{fontSize:'1.75rem',marginBottom:'0.375rem'}}>{icon}</div>
                  <div style={{fontSize:'1.75rem',fontWeight:'bold',color:color,marginBottom:'0.25rem'}}>{count}</div>
                  <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'700'}}>{label}</div>
                </div>
              ))}
            </div>
          </div>
        </>
      )}

      {activeTab === 'leaderboard' && <LeaderboardView />}
    </>
  );

  return (
    <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'#f8fafc'}}>
      {toastMessage && <div className="toast">{toastMessage}</div>}

      {/* NEW: Location Detection Splash */}
      {showLocationSplash && (
        <div className="modal-overlay">
          <div className="modal-content text-center" style={{textAlign:'center'}}>
            <div className="spinner" style={{margin:'0 auto',marginBottom:'1rem'}}></div>
            <h2 style={{fontSize:'1.5rem',fontWeight:'bold',marginBottom:'0.5rem'}}>üìç Detecting Your Location</h2>
            <p style={{color:'#64748b',fontWeight:'600'}}>Setting up your workspace...</p>
          </div>
        </div>
      )}

      {/* NEW: Icon Selection Modal */}
      {showIconModal && (
        <div className="modal-overlay" onClick={() => setShowIconModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{fontSize:'1.5rem',fontWeight:'bold',marginBottom:'1rem'}}>Choose Your Marker Icon</h2>
            <p style={{color:'#64748b',marginBottom:'1rem'}}>Select an icon for your pins on the map</p>
            
            <div className="icon-selector">
              {AVAILABLE_ICONS.map(icon => (
                <div key={icon} className={`icon-option ${selectedIcon === icon ? 'selected' : ''}`} onClick={() => setSelectedIcon(icon)}>
                  {icon}
                </div>
              ))}
            </div>

            <button onClick={saveIconSelection} className="modern-button" style={{width:'100%',marginTop:'1.5rem',background:'#3b82f6',color:'white',padding:'1rem',borderRadius:'0.75rem',border:'none',fontSize:'1rem',fontWeight:'700'}}>
              Save Icon Selection
            </button>
          </div>
        </div>
      )}

      {/* NEW: Contact Information Modal */}
      {showContactModal && (
        <div className="modal-overlay" onClick={closeContactModal}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{fontSize:'1.5rem',fontWeight:'bold',marginBottom:'0.5rem'}}>Add Contact Information</h2>
            <p style={{color:'#64748b',marginBottom:'1.5rem',fontWeight:'600'}}>
              {LEAD_TYPES[pendingPinData?.status]?.label || 'Lead'}
            </p>
            
            <div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>
              <div>
                <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',marginBottom:'0.5rem',color:'#1e293b'}}>Full Name *</label>
                <input type="text" value={contactData.name} onChange={e => setContactData({...contactData, name: e.target.value})} className="input-field" placeholder="John Doe" required />
              </div>

              <div>
                <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',marginBottom:'0.5rem',color:'#1e293b'}}>Phone Number *</label>
                <input type="tel" value={contactData.phone} onChange={e => setContactData({...contactData, phone: e.target.value})} className="input-field" placeholder="(555) 123-4567" required />
              </div>

              <div>
                <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',marginBottom:'0.5rem',color:'#1e293b'}}>Email (Optional)</label>
                <input type="email" value={contactData.email} onChange={e => setContactData({...contactData, email: e.target.value})} className="input-field" placeholder="john@example.com" />
              </div>

              <div>
                <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',marginBottom:'0.5rem',color:'#1e293b'}}>Address (Optional)</label>
                <input type="text" value={contactData.address} onChange={e => setContactData({...contactData, address: e.target.value})} className="input-field" placeholder="123 Main St" />
              </div>

              <div>
                <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',marginBottom:'0.5rem',color:'#1e293b'}}>Notes (Optional)</label>
                <textarea value={contactData.notes} onChange={e => setContactData({...contactData, notes: e.target.value})} className="input-field" rows="3" placeholder="Additional details..."></textarea>
              </div>
            </div>

            <div style={{display:'flex',gap:'0.75rem',marginTop:'1.5rem'}}>
              <button onClick={closeContactModal} className="modern-button" style={{flex:1,background:'#e5e7eb',color:'#1e293b',padding:'0.875rem',borderRadius:'0.75rem',border:'none',fontWeight:'700'}}>
                Cancel
              </button>
              <button onClick={saveContactAndPin} className="modern-button" style={{flex:1,background:'#3b82f6',color:'white',padding:'0.875rem',borderRadius:'0.75rem',border:'none',fontWeight:'700'}}>
                Save & Add Pin
              </button>
            </div>
          </div>
        </div>
      )}

      {/* NEW: Settings Button */}
      <button className="settings-btn" onClick={() => setShowIconModal(true)}>‚öôÔ∏è</button>

      {(saving || geocoding) && (
        <div style={{position:'fixed',top:'50%',left:'50%',transform:'translate(-50%,-50%)',background:'white',padding:'2rem 2.5rem',borderRadius:'1.5rem',boxShadow:'0 20px 40px rgba(0,0,0,0.2)',zIndex:10001,display:'flex',flexDirection:'column',gap:'1rem',alignItems:'center'}}>
          <div className="spinner" style={{width:'40px',height:'40px',borderWidth:'4px',borderTopColor:'#3b82f6'}}></div>
          <span style={{fontWeight:'700',fontSize:'1.125rem',color:'#1e293b'}}>{geocoding ? 'üè† Finding Address...' : 'üíæ Saving...'}</span>
        </div>
      )}

      {trackingEnabled && !isMobile && (
        <div style={{position:'fixed',top:'1rem',right:'1rem',background:gpsIsFresh?'#10b981':'#f59e0b',color:'white',padding:'0.875rem 1.5rem',borderRadius:'2rem',boxShadow:'0 6px 16px rgba(0,0,0,0.2)',zIndex:10001,display:'flex',gap:'0.875rem',alignItems:'center',fontSize:'0.9375rem',fontWeight:'700'}}>
          <div style={{width:'14px',height:'14px',background:'white',borderRadius:'50%',animation:'pulse 2s infinite'}}></div>
          <span>GPS {gpsAge !== null ? `${gpsAge}s` : 'Active'} {gpsIsFresh ? '‚úÖ' : '‚ö†Ô∏è'}</span>
        </div>
      )}

      {selectedZone && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10002,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1.5rem',padding:'2rem',maxWidth:'440px',width:'100%',boxShadow:'0 20px 40px rgba(0,0,0,0.3)',animation:'fadeIn 0.3s ease'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem'}}>
              <h3 style={{fontSize:'1.5rem',fontWeight:'bold',color:'#1e293b'}}>{selectedZone.name}</h3>
              <button onClick={() => setSelectedZone(null)} className="modern-button" style={{width:'40px',height:'40px',borderRadius:'50%',border:'none',background:'#f1f5f9',fontSize:'1.5rem',display:'flex',alignItems:'center',justifyContent:'center'}}>√ó</button>
            </div>
            {selectedZone.assigned_to ? (
              <>
                <div style={{padding:'1.25rem',background:'#f0fdf4',borderRadius:'1rem',border:'2px solid #10b981',marginBottom:'1rem'}}>
                  <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                    <div style={{width:'56px',height:'56px',borderRadius:'50%',background:teamMembers.find(u => u.id === selectedZone.assigned_to)?.color || '#64748b',display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.5rem',boxShadow:'0 4px 12px rgba(0,0,0,0.15)'}}>
                      {teamMembers.find(u => u.id === selectedZone.assigned_to)?.name.charAt(0) || '?'}
                    </div>
                    <div>
                      <div style={{fontSize:'0.8125rem',color:'#166534',fontWeight:'700'}}>ASSIGNED TO</div>
                      <div style={{fontWeight:'700',fontSize:'1.25rem',color:'#166534'}}>{teamMembers.find(u => u.id === selectedZone.assigned_to)?.name || 'Unknown'}</div>
                    </div>
                  </div>
                </div>
                {currentUser?.role === 'admin' && (
                  <button onClick={() => assignZone(selectedZone.id, null)} className="modern-button" style={{width:'100%',padding:'1rem',background:'#f59e0b',color:'white',border:'none',borderRadius:'0.75rem',marginBottom:'0.75rem',fontWeight:'700',fontSize:'0.9375rem'}}>
                    üîÑ Unassign Zone
                  </button>
                )}
              </>
            ) : (
              currentUser?.role === 'admin' && (
                <div style={{marginBottom:'1rem'}}>
                  <label style={{display:'block',fontSize:'0.875rem',fontWeight:'700',marginBottom:'0.75rem',color:'#1e293b'}}>Assign to:</label>
                  <select onChange={(e) => e.target.value && assignZone(selectedZone.id, e.target.value)} style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}>
                    <option value="">Select team member...</option>
                    {teamMembers.map(member => (
                      <option key={member.id} value={member.id}>{member.name}</option>
                    ))}
                  </select>
                </div>
              )
            )}
            {currentUser?.role === 'admin' && (
              <button onClick={() => deleteZone(selectedZone.id)} className="modern-button" style={{width:'100%',padding:'1rem',background:'#ef4444',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.9375rem'}}>
                üóëÔ∏è Delete Zone
              </button>
            )}
          </div>
        </div>
      )}

      {showUserModal && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10002,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1.5rem',padding:'2rem',maxWidth:'440px',width:'100%',boxShadow:'0 20px 40px rgba(0,0,0,0.3)',animation:'fadeIn 0.3s ease'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem'}}>
              <h3 style={{fontSize:'1.5rem',fontWeight:'bold',color:'#1e293b'}}>Add Team Member</h3>
              <button onClick={() => setShowUserModal(false)} className="modern-button" style={{width:'40px',height:'40px',borderRadius:'50%',border:'none',background:'#f1f5f9',fontSize:'1.5rem',display:'flex',alignItems:'center',justifyContent:'center'}}>√ó</button>
            </div>
            <div style={{marginBottom:'1rem'}}>
              <label style={{display:'block',fontSize:'0.875rem',fontWeight:'700',marginBottom:'0.5rem',color:'#1e293b'}}>Name</label>
              <input value={newUserName} onChange={e=>setNewUserName(e.target.value)} placeholder="Enter name" style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}} />
            </div>
            <div style={{marginBottom:'1.5rem'}}>
              <label style={{display:'block',fontSize:'0.875rem',fontWeight:'700',marginBottom:'0.5rem',color:'#1e293b'}}>Role</label>
              <select value={newUserRole} onChange={e=>setNewUserRole(e.target.value)} style={{width:'100%',padding:'0.875rem',border:'2px solid #e5e7eb',borderRadius:'0.75rem',fontSize:'0.9375rem',fontWeight:'600'}}>
                <option value="rep">Rep</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <button onClick={addTeamMember} className="modern-button" style={{width:'100%',padding:'1rem',background:'#3b82f6',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'700',fontSize:'0.9375rem',boxShadow:'0 4px 12px rgba(59,130,246,0.3)'}}>
              ‚ûï Add Member
            </button>
          </div>
        </div>
      )}

      {mode === 'draw-zone' && activeZoneId && (
        <div style={{position:'fixed',bottom:'1rem',left:'50%',transform:'translateX(-50%)',display:'flex',gap:'0.75rem',zIndex:1000}}>
          <button onClick={completeZone} className="modern-button" style={{padding:'1rem 2rem',background:'#10b981',color:'white',border:'none',borderRadius:'1rem',fontWeight:'700',fontSize:'1rem',boxShadow:'0 4px 12px rgba(16,185,129,0.3)'}}>
            ‚úÖ Complete Zone
          </button>
          <button onClick={cancelZone} className="modern-button" style={{padding:'1rem 2rem',background:'#ef4444',color:'white',border:'none',borderRadius:'1rem',fontWeight:'700',fontSize:'1rem',boxShadow:'0 4px 12px rgba(239,68,68,0.3)'}}>
            ‚ùå Cancel
          </button>
        </div>
      )}

      <button className="hamburger-btn" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div className={`mobile-dropdown ${mobileMenuOpen ? 'open' : ''}`}>
        <div style={{padding:'1.5rem'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.5rem'}}>
            <h2 style={{fontSize:'1.25rem',fontWeight:'bold',color:'#1e293b'}}>Menu</h2>
            <button onClick={() => setMobileMenuOpen(false)} className="modern-button" style={{width:'40px',height:'40px',borderRadius:'50%',border:'none',background:'#f1f5f9',fontSize:'1.5rem',display:'flex',alignItems:'center',justifyContent:'center'}}>√ó</button>
          </div>

          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem',borderBottom:'2px solid #e5e7eb'}}>
            {[['map','üó∫Ô∏è Map'],['leaderboard','üèÜ Leaderboard']].map(([tab,label]) => (
              <button key={tab} onClick={() => {setActiveTab(tab); setMobileMenuOpen(false);}} className="tab" style={{flex:1,borderBottomColor:activeTab===tab?'#3b82f6':'transparent',color:activeTab===tab?'#3b82f6':'#64748b'}}>{label}</button>
            ))}
          </div>

          <SidebarContent />
        </div>
      </div>

      <div style={{display:'flex',height:'100%',overflow:'hidden'}}>
        <div className="desktop-sidebar" style={{width:'400px',background:'white',overflowY:'auto',padding:'1.5rem',boxShadow:'4px 0 12px rgba(0,0,0,0.08)',borderRight:'1px solid #e5e7eb',flexShrink:0}}>
          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem',borderBottom:'2px solid #e5e7eb'}}>
            {[['map','üó∫Ô∏è Map'],['leaderboard','üèÜ Leaderboard']].map(([tab,label]) => (
              <button key={tab} onClick={() => setActiveTab(tab)} className="tab" style={{flex:1,borderBottomColor:activeTab===tab?'#3b82f6':'transparent',color:activeTab===tab?'#3b82f6':'#64748b'}}>{label}</button>
            ))}
          </div>

          <SidebarContent />
        </div>

        <div style={{flex:1,borderRadius:isMobile?0:'1rem',overflow:'hidden',boxShadow:isMobile?'none':'0 4px 12px rgba(0,0,0,0.08)',position:'relative',border:isMobile?'none':'1px solid #e5e7eb'}}>
          <div ref={mapRef} style={{height:'100%',width:'100%'}}></div>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<RepZoneApp />);
</script>
</body>
</html>
