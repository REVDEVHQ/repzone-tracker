<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>RepZone Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  html, body { 
    height: 100%; 
    width: 100%; 
    overflow: hidden; 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    position: fixed;
    -webkit-overflow-scrolling: touch;
  }
  .leaflet-container { 
    height: 100% !important; 
    width: 100% !important;
    touch-action: pan-x pan-y;
  }
  .leaflet-tile-pane { 
    -webkit-transform: translate3d(0,0,0);
  }
  .spinner { 
    border: 3px solid #f3f3f3; 
    border-top: 3px solid #3498db; 
    border-radius: 50%; 
    width: 30px; 
    height: 30px; 
    animation: spin 1s linear infinite; 
  }
  @keyframes spin { 
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); } 
  }
  @keyframes pulse { 
    0%, 100% { opacity: 1; } 
    50% { opacity: 0.5; } 
  }
  .tracking-indicator { animation: pulse 2s infinite; }
  .tab { 
    padding: 0.75rem 1rem; 
    cursor: pointer; 
    border-bottom: 2px solid transparent; 
    font-weight: 500; 
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .tab.active { border-bottom-color: #2563eb; color: #2563eb; }
  .tab:active { background: #f1f5f9; }
  .toast { 
    position: fixed; 
    top: 5rem; 
    left: 1rem;
    right: 1rem;
    background: white; 
    padding: 1rem 1.5rem; 
    border-radius: 0.75rem; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    z-index: 10001; 
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn { 
    from { transform: translateY(-100px); opacity: 0; } 
    to { transform: translateY(0); opacity: 1; } 
  }
  button {
    -webkit-appearance: none;
    -webkit-tap-highlight-color: transparent;
  }
  input, select {
    -webkit-appearance: none;
    border-radius: 0;
  }
  .mobile-sidebar {
    width: 100%;
    max-width: 400px;
  }
  @media (max-width: 768px) {
    .mobile-sidebar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: auto;
      max-height: 70vh;
      z-index: 1000;
      border-radius: 1rem 1rem 0 0;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
    }
    .map-container {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
    }
  }
</style>
</head>
<body>
<div id="root"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SUPABASE_URL = 'https://cytikhfyygkovnjtpsth.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dGlraGZ5eWdrb3ZuanRwc3RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTc3NzYsImV4cCI6MjA3NjI5Mzc3Nn0.ItJObIXo_Ks8TEigj5RkUA4vXbze_3FMMIzYyVHrthQ';

const COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];

const LEAD_TYPES = {
  estimate: { icon: 'üí∞', label: 'A - Estimate', color: '#10b981', display: 'A' },
  callback: { icon: 'üìû', label: 'B - Callback', color: '#f59e0b', display: 'B' },
  notinterested: { icon: 'üìã', label: 'C - Not Interested', color: '#64748b', display: 'C' },
  knocked: { icon: '‚úÖ', label: 'Knocked', color: '#16a34a', display: '‚úÖ' },
  flyer: { icon: 'üì¨', label: 'Flyer', color: '#2563eb', display: 'üì¨' },
  skipped: { icon: '‚è≠Ô∏è', label: 'Skipped', color: '#ef4444', display: '‚è≠Ô∏è' }
};

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c * 3.28084;
}

function getVerificationStatus(distance) {
  if (distance <= 50) return { status: 'verified', color: '#10b981', icon: '‚úÖ', label: 'Verified' };
  if (distance <= 150) return { status: 'questionable', color: '#f59e0b', icon: '‚ö†Ô∏è', label: 'Questionable' };
  return { status: 'suspicious', color: '#ef4444', icon: 'üö´', label: 'Suspicious' };
}

function isPointInPolygon(point, polygon) {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i][0], yi = polygon[i][1];
    const xj = polygon[j][0], yj = polygon[j][1];
    const intersect = ((yi > point[1]) !== (yj > point[1])) && (point[0] < (xj - xi) * (point[1] - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function RepZoneApp() {
  const [pins, setPins] = useState([]);
  const [zones, setZones] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [liveLocations, setLiveLocations] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentLocation, setCurrentLocation] = useState(null);
  const [mode, setMode] = useState("drop-pin");
  const [status, setStatus] = useState("estimate");
  const [activeZoneId, setActiveZoneId] = useState(null);
  const [selectedZone, setSelectedZone] = useState(null);
  const [note, setNote] = useState("");
  const [filter, setFilter] = useState({ status: "all", userId: "all" });
  const [activeTab, setActiveTab] = useState("map");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [mapReady, setMapReady] = useState(false);
  const [showUserModal, setShowUserModal] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [newUserName, setNewUserName] = useState("");
  const [newUserRole, setNewUserRole] = useState("rep");
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [leaderboardPeriod, setLeaderboardPeriod] = useState('week');
  const [trackingEnabled, setTrackingEnabled] = useState(false);
  const [showLiveTracking, setShowLiveTracking] = useState(true);
  const [toastMessage, setToastMessage] = useState(null);
  const [sidebarExpanded, setSidebarExpanded] = useState(true);
  
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const supabase = useRef(null);
  const locationWatchId = useRef(null);

  function showToast(message, duration = 3000) {
    console.log('Toast:', message);
    setToastMessage(message);
    setTimeout(() => setToastMessage(null), duration);
  }

  useEffect(() => {
    console.log('App initializing...');
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    console.log('Setting up Supabase...');
    supabase.current = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    loadData();
    const saved = localStorage.getItem('current_user_id');
    if (saved) {
      try {
        const user = JSON.parse(saved);
        console.log('Restored user:', user);
        setCurrentUser(user);
        requestLocationPermission(user);
      } catch (e) {
        console.error('Error parsing saved user:', e);
      }
    }
  }, []);

  useEffect(() => {
    if (!supabase.current) return;
    loadLiveLocations();
    const interval = setInterval(loadLiveLocations, 10000);
    return () => clearInterval(interval);
  }, []);

  async function loadLiveLocations() {
    try {
      const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      const { data, error } = await supabase.current
        .from('live_locations')
        .select('*')
        .gte('last_updated', fiveMinutesAgo)
        .eq('is_active', true);
      if (!error && data) setLiveLocations(data);
    } catch (e) {
      console.error('Error loading live locations:', e);
    }
  }

  async function requestLocationPermission(user) {
    console.log('Requesting location permission...');
    if (!navigator.geolocation) {
      showToast('‚ö†Ô∏è GPS not supported');
      return;
    }
    
    // iOS requires user interaction for geolocation
    navigator.geolocation.getCurrentPosition(
      (position) => {
        console.log('Initial position:', position.coords);
        startLocationTracking(user);
      },
      (error) => {
        console.error('Location error:', error);
        showToast('‚ö†Ô∏è Location permission denied. Enable in Settings > Safari > Location');
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  function startLocationTracking(user) {
    if (!user || locationWatchId.current) return;
    console.log('Starting location tracking...');
    setTrackingEnabled(true);
    
    locationWatchId.current = navigator.geolocation.watchPosition(
      (position) => {
        console.log('Position update:', position.coords);
        const newLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy
        };
        setCurrentLocation(newLocation);
        updateLiveLocation(user.id, newLocation);
      },
      (error) => {
        console.error('Tracking error:', error);
      },
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
    );
  }

  function stopLocationTracking() {
    if (locationWatchId.current) {
      navigator.geolocation.clearWatch(locationWatchId.current);
      locationWatchId.current = null;
    }
    setTrackingEnabled(false);
  }

  async function updateLiveLocation(userId, location) {
    try {
      await supabase.current.from('live_locations').upsert({
        team_member_id: userId,
        lat: location.lat,
        lng: location.lng,
        accuracy: location.accuracy,
        last_updated: new Date().toISOString(),
        is_active: true
      }, { onConflict: 'team_member_id' });
    } catch (e) {
      console.error('Error updating location:', e);
    }
  }

  useEffect(() => () => stopLocationTracking(), []);

  async function loadData() {
    console.log('Loading data...');
    try {
      const [pinsRes, zonesRes, teamRes] = await Promise.all([
        supabase.current.from('pins').select('*'),
        supabase.current.from('zones').select('*'),
        supabase.current.from('team_members').select('*')
      ]);
      console.log('Data loaded:', { pins: pinsRes.data?.length, zones: zonesRes.data?.length, team: teamRes.data?.length });
      setPins(pinsRes.data || []);
      setZones(zonesRes.data || []);
      setTeamMembers(teamRes.data || []);
    } catch (e) {
      console.error('Load error:', e);
    }
    setLoading(false);
  }

  async function deletePin(pinId) {
    if (!confirm('Delete?')) return;
    await supabase.current.from('pins').delete().eq('id', pinId);
    setPins(prev => prev.filter(p => p.id !== pinId));
    showToast('‚úÖ Deleted');
  }

  async function updatePinStatus(pinId, newStatus) {
    await supabase.current.from('pins').update({ status: newStatus }).eq('id', pinId);
    setPins(prev => prev.map(p => p.id === pinId ? {...p, status: newStatus} : p));
    showToast('‚úÖ Updated');
  }

  async function deleteUser(userId) {
    if (!confirm('Delete?')) return;
    await supabase.current.from('team_members').delete().eq('id', userId);
    setTeamMembers(prev => prev.filter(u => u.id !== userId));
    if (currentUser?.id === userId) setCurrentUser(null);
  }

  async function updateUserRole(userId, newRole) {
    await supabase.current.from('team_members').update({ role: newRole }).eq('id', userId);
    setTeamMembers(prev => prev.map(u => u.id === userId ? {...u, role: newRole} : u));
    if (currentUser?.id === userId) {
      const updatedUser = {...currentUser, role: newRole};
      setCurrentUser(updatedUser);
      localStorage.setItem('current_user_id', JSON.stringify(updatedUser));
    }
    setEditingUser(null);
  }

  async function assignZone(zoneId, userId) {
    const member = teamMembers.find(m => m.id === userId);
    await supabase.current.from('zones').update({ 
      assigned_to: userId,
      color: member?.color || COLORS[0]
    }).eq('id', zoneId);
    setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: userId, color: member?.color} : z));
    setSelectedZone(null);
    showToast('‚úÖ Assigned');
  }

  async function unassignZone(zoneId) {
    await supabase.current.from('zones').update({ assigned_to: null }).eq('id', zoneId);
    setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: null} : z));
    setSelectedZone(null);
    showToast('‚úÖ Unassigned');
  }

  async function deleteZone(zoneId) {
    if (!confirm('Delete zone?')) return;
    await supabase.current.from('zones').delete().eq('id', zoneId);
    setZones(prev => prev.filter(z => z.id !== zoneId));
    setSelectedZone(null);
    showToast('‚úÖ Deleted');
  }

  useEffect(() => {
    window.deletePinGlobal = deletePin;
    window.updatePinStatusGlobal = updatePinStatus;
    return () => {
      delete window.deletePinGlobal;
      delete window.updatePinStatusGlobal;
    };
  }, []);

  async function addTeamMember() {
    if (!newUserName.trim()) return;
    const newMember = {
      id: `user-${Date.now()}`,
      name: newUserName,
      color: COLORS[teamMembers.length % COLORS.length],
      role: newUserRole,
      created_at: new Date().toISOString()
    };
    await supabase.current.from('team_members').insert([newMember]);
    setTeamMembers(prev => [...prev, newMember]);
    setNewUserName("");
    setNewUserRole("rep");
    setShowUserModal(false);
  }

  function selectCurrentUser(user) {
    console.log('User selected:', user);
    setCurrentUser(user);
    localStorage.setItem('current_user_id', JSON.stringify(user));
    requestLocationPermission(user);
  }

  function getLeaderboard() {
    const now = new Date();
    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
    startOfWeek.setHours(0, 0, 0, 0);
    const startOfDay = new Date();
    startOfDay.setHours(0, 0, 0, 0);

    return teamMembers.map(member => {
      const memberPins = pins.filter(p => p.team_member_id === member.id);
      const weekPins = memberPins.filter(p => new Date(p.created_at) >= startOfWeek);
      const dayPins = memberPins.filter(p => new Date(p.created_at) >= startOfDay);
      
      let count = 0;
      if (leaderboardPeriod === 'week') count = weekPins.filter(p => ['estimate', 'knocked'].includes(p.status)).length;
      else if (leaderboardPeriod === 'day') count = dayPins.filter(p => ['estimate', 'knocked'].includes(p.status)).length;
      else count = memberPins.filter(p => ['estimate', 'knocked'].includes(p.status)).length;

      const liveLocation = liveLocations.find(l => l.team_member_id === member.id);
      const isOnline = liveLocation && new Date(liveLocation.last_updated) > new Date(Date.now() - 5 * 60 * 1000);

      return { ...member, knockCount: count, isOnline, liveLocation };
    }).sort((a, b) => b.knockCount - a.knockCount);
  }

  // Initialize map
  useEffect(() => {
    if (!mapRef.current || mapInstanceRef.current || loading) return;
    
    console.log('Initializing map...');
    const map = L.map(mapRef.current, {
      center: [47.6062, -122.3321],
      zoom: 13,
      zoomControl: true,
      tap: true,
      tapTolerance: 15
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 19
    }).addTo(map);

    L.control.zoom({ position: 'topright' }).addTo(map);

    mapInstanceRef.current = map;
    
    setTimeout(() => {
      map.invalidateSize();
      setMapReady(true);
      console.log('Map ready');
    }, 500);
  }, [loading]);

  // Map click handlers
  useEffect(() => {
    const map = mapInstanceRef.current;
    if (!map || !mapReady) return;

    const handleMapClick = async (e) => {
      const { lat, lng } = e.latlng;
      console.log('Map clicked:', { lat, lng, mode });
      
      if (mode === "drop-pin" && currentUser) {
        if (!currentLocation) {
          showToast('‚ö†Ô∏è Enable GPS first!');
          return;
        }

        setSaving(true);

        try {
          const distance = calculateDistance(currentLocation.lat, currentLocation.lng, lat, lng);
          const verification = getVerificationStatus(distance);
          const clickedZone = zones.find(z => z.points?.length >= 3 && isPointInPolygon([lat, lng], z.points));

          const newPin = {
            id: `pin-${Date.now()}`,
            lat, lng, status,
            rep_name: currentUser.name,
            team_member_id: currentUser.id,
            zone_id: clickedZone?.id || null,
            note: note || null,
            actual_lat: currentLocation.lat,
            actual_lng: currentLocation.lng,
            distance_from_pin: Math.round(distance),
            verification_status: verification.status,
            created_at: new Date().toISOString()
          };
          
          console.log('Saving pin:', newPin);
          const { error } = await supabase.current.from('pins').insert([newPin]);
          
          if (error) {
            console.error('Save error:', error);
            showToast('‚ùå Error: ' + error.message);
          } else {
            console.log('Pin saved successfully');
            setPins(prev => [...prev, newPin]);
            setNote("");
            showToast(`‚úÖ ${LEAD_TYPES[status].label} saved!`);
          }
        } catch (error) {
          console.error('Unexpected error:', error);
          showToast('‚ùå Error: ' + error.message);
        }
        
        setSaving(false);
      } else if (mode === "draw-zone") {
        if (currentUser?.role !== 'admin') {
          showToast('‚ö†Ô∏è Admins only!');
          return;
        }

        const id = activeZoneId || `zone-${Date.now()}`;
        const existing = zones.find(z => z.id === id);
        const newPoints = existing ? [...existing.points, [lat, lng]] : [[lat, lng]];
        
        if (existing) {
          await supabase.current.from('zones').update({ points: newPoints }).eq('id', id);
          setZones(prev => prev.map(z => z.id === id ? {...z, points: newPoints} : z));
        } else {
          const newZone = {
            id, 
            name: `Zone ${zones.length + 1}`,
            color: COLORS[zones.length % COLORS.length],
            points: newPoints,
            created_by: currentUser?.name || 'Admin',
            assigned_to: null,
            created_at: new Date().toISOString()
          };
          await supabase.current.from('zones').insert([newZone]);
          setZones(prev => [...prev, newZone]);
        }
        setActiveZoneId(id);
      }
    };

    map.on('click', handleMapClick);
    map.on('dblclick', () => {
      if (mode === "draw-zone" && activeZoneId) {
        setActiveZoneId(null);
        setMode("select");
      }
    });

    return () => {
      map.off('click', handleMapClick);
      map.off('dblclick');
    };
  }, [mode, status, note, activeZoneId, zones, mapReady, currentUser, currentLocation]);

  // Render map layers
  useEffect(() => {
    const map = mapInstanceRef.current;
    if (!map || !mapReady) return;

    map.eachLayer(layer => {
      if (layer instanceof L.Polygon || layer instanceof L.Marker || layer instanceof L.Circle) {
        map.removeLayer(layer);
      }
    });

    // Draw zones - NON-INTERACTIVE in drop-pin mode
    zones.forEach(zone => {
      if (zone.points?.length >= 3) {
        const assigned = teamMembers.find(u => u.id === zone.assigned_to);
        const polygon = L.polygon(zone.points, {
          color: assigned?.color || zone.color,
          fillColor: assigned?.color || zone.color,
          fillOpacity: 0.2,
          weight: 3,
          interactive: mode !== "drop-pin",
          bubblingMouseEvents: true
        }).addTo(map);

        if (mode === "select") {
          polygon.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            setSelectedZone(zone);
          });
        }

        polygon.bindPopup(`<div style="padding:8px"><b>${zone.name}</b><br>${assigned ? `üë§ ${assigned.name}` : '‚ö†Ô∏è Unassigned'}</div>`);
      }
    });

    // Draw live locations
    if (showLiveTracking) {
      liveLocations.forEach(loc => {
        const member = teamMembers.find(m => m.id === loc.team_member_id);
        if (!member || loc.team_member_id === currentUser?.id) return;

        L.circle([loc.lat, loc.lng], { radius: 30, color: member.color, fillColor: member.color, fillOpacity: 0.3, weight: 3 }).addTo(map);
        const icon = L.divIcon({ html: `<div style="background:${member.color};width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3)">${member.name.charAt(0)}</div>`, iconSize: [36, 36], iconAnchor: [18, 18] });
        L.marker([loc.lat, loc.lng], { icon }).addTo(map);
      });
    }

    // Draw current location
    if (currentLocation && currentUser) {
      L.circle([currentLocation.lat, currentLocation.lng], { radius: 50, color: currentUser.color, fillColor: currentUser.color, fillOpacity: 0.3, weight: 2, className: 'tracking-indicator' }).addTo(map);
      const youIcon = L.divIcon({ html: `<div style="background:${currentUser.color};width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:1.125rem;border:4px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.4)">${currentUser.name.charAt(0)}</div>`, iconSize: [44, 44], iconAnchor: [22, 22] });
      L.marker([currentLocation.lat, currentLocation.lng], { icon: youIcon }).addTo(map);
    }

    // Draw pins
    const filtered = pins.filter(p => {
      if (filter.status !== "all" && p.status !== filter.status) return false;
      if (filter.userId !== "all" && p.team_member_id !== filter.userId) return false;
      return true;
    });

    filtered.forEach(pin => {
      const user = teamMembers.find(u => u.id === pin.team_member_id);
      const leadType = LEAD_TYPES[pin.status] || LEAD_TYPES.knocked;
      const verification = pin.verification_status ? getVerificationStatus(pin.distance_from_pin || 0) : null;
      
      const icon = L.divIcon({
        html: `<div style="background:${user?.color || '#64748b'};width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid ${verification ? verification.color : 'white'};box-shadow:0 2px 8px rgba(0,0,0,0.3)">${leadType.display}</div>`,
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      });
      
      const marker = L.marker([pin.lat, pin.lng], { icon }).addTo(map);
      
      marker.bindPopup(`
        <div style="min-width:200px;padding:10px">
          <div style="margin-bottom:8px">${leadType.icon} <b>${leadType.label}</b></div>
          <div style="margin-bottom:8px">üë§ ${pin.rep_name || 'Unknown'}</div>
          ${pin.note ? `<div style="margin-bottom:8px">üìù ${pin.note}</div>` : ''}
          ${verification ? `<div style="margin-bottom:8px">${verification.icon} ${pin.distance_from_pin}ft</div>` : ''}
          <small>${new Date(pin.created_at).toLocaleString()}</small><br>
          <div style="display:flex;gap:4px;margin:8px 0;flex-wrap:wrap">
            ${Object.entries(LEAD_TYPES).map(([key, type]) => `<button onclick="window.updatePinStatusGlobal('${pin.id}','${key}')" style="flex:1;padding:6px;background:${type.color};color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px">${type.display}</button>`).join('')}
          </div>
          <button onclick="window.deletePinGlobal('${pin.id}')" style="width:100%;padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600">üóëÔ∏è</button>
        </div>
      `);
    });
  }, [pins, zones, filter, mapReady, teamMembers, liveLocations, currentLocation, currentUser, showLiveTracking, mode]);

  if (loading) {
    return (
      <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',flexDirection:'column',gap:'1rem',background:'#f8fafc'}}>
        <div className="spinner"></div>
        <p style={{color:'#64748b',fontWeight:'500'}}>Loading...</p>
      </div>
    );
  }

  const stats = {
    totalPins: pins.length,
    estimates: pins.filter(p => p.status === 'estimate').length,
    verified: pins.filter(p => p.verification_status === 'verified').length,
    suspicious: pins.filter(p => p.verification_status === 'suspicious').length,
    onlineUsers: liveLocations.filter(l => new Date(l.last_updated) > new Date(Date.now() - 5 * 60 * 1000)).length
  };

  const leaderboard = getLeaderboard();

  return (
    <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'#f8fafc',display:'flex',flexDirection:isMobile?'column':'row'}}>
      {toastMessage && <div className="toast">{toastMessage}</div>}
      
      {saving && (
        <div style={{position:'fixed',top:'50%',left:'50%',transform:'translate(-50%,-50%)',background:'white',padding:'1rem 2rem',borderRadius:'1rem',boxShadow:'0 4px 12px rgba(0,0,0,0.2)',zIndex:10001,display:'flex',gap:'1rem',alignItems:'center'}}>
          <div className="spinner" style={{width:'24px',height:'24px'}}></div>
          <span style={{fontWeight:'600'}}>Saving...</span>
        </div>
      )}
      
      {trackingEnabled && (
        <div style={{position:'fixed',top:'1rem',right:'1rem',background:'#10b981',color:'white',padding:'0.5rem 1rem',borderRadius:'1.5rem',boxShadow:'0 2px 8px rgba(0,0,0,0.15)',zIndex:10001,display:'flex',gap:'0.5rem',alignItems:'center',fontSize:'0.75rem',fontWeight:'600'}}>
          <div style={{width:'10px',height:'10px',background:'white',borderRadius:'50%',animation:'pulse 2s infinite'}}></div>
          <span>GPS</span>
        </div>
      )}

      {/* Zone Selection Modal */}
      {selectedZone && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10002,padding:'1rem'}} onClick={() => setSelectedZone(null)}>
          <div style={{background:'white',borderRadius:'1rem',padding:'1.5rem',maxWidth:'400px',width:'100%'}} onClick={e => e.stopPropagation()}>
            <h3 style={{fontSize:'1.25rem',fontWeight:'bold',marginBottom:'1rem'}}>{selectedZone.name}</h3>
            {selectedZone.assigned_to ? (
              <>
                <div style={{padding:'1rem',background:'#f0fdf4',borderRadius:'0.75rem',border:'2px solid #10b981',marginBottom:'1rem'}}>
                  <b>Assigned: {teamMembers.find(u => u.id === selectedZone.assigned_to)?.name}</b>
                </div>
                {currentUser?.role === 'admin' && (
                  <button onClick={() => unassignZone(selectedZone.id)} style={{width:'100%',padding:'0.75rem',background:'#f59e0b',color:'white',border:'none',borderRadius:'0.5rem',fontWeight:'600',cursor:'pointer',marginBottom:'0.5rem'}}>Unassign</button>
                )}
              </>
            ) : (
              <>
                {currentUser?.role === 'admin' ? (
                  <>
                    <p style={{color:'#64748b',marginBottom:'1rem',fontSize:'0.875rem'}}>Assign to:</p>
                    <div style={{marginBottom:'1rem',maxHeight:'200px',overflowY:'auto'}}>
                      {teamMembers.map(member => (
                        <div key={member.id} onClick={() => assignZone(selectedZone.id, member.id)} style={{padding:'0.75rem',marginBottom:'0.5rem',border:'2px solid #e2e8f0',borderRadius:'0.5rem',cursor:'pointer',display:'flex',alignItems:'center',gap:'0.75rem'}}>
                          <div style={{width:' 36px',height:'36px',borderRadius:'50%',background:member.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold'}}>{member.name.charAt(0)}</div>
                          <div>{member.name}</div>
                        </div>
                      ))}
                    </div>
                  </>
                ) : (
                  <p style={{color:'#64748b',marginBottom:'1rem'}}>‚ö†Ô∏è Admins only</p>
                )}
              </>
            )}
            {currentUser?.role === 'admin' && (
              <button onClick={() => deleteZone(selectedZone.id)} style={{width:'100%',padding:'0.75rem',background:'#ef4444',color:'white',border:'none',borderRadius:'0.5rem',fontWeight:'600',cursor:'pointer',marginBottom:'0.5rem'}}>üóëÔ∏è Delete</button>
            )}
            <button onClick={() => setSelectedZone(null)} style={{width:'100%',padding:'0.75rem',background:'#e2e8f0',border:'none',borderRadius:'0.5rem',fontWeight:'600',cursor:'pointer'}}>Close</button>
          </div>
        </div>
      )}

      {/* User Selection Modal */}
      {!currentUser && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10000,padding:'1rem'}}>
          <div style={{background:'white',borderRadius:'1rem',padding:'1.5rem',maxWidth:'400px',width:'100%',maxHeight:'80vh',overflowY:'auto'}}>
            <h2 style={{fontSize:'1.5rem',fontWeight:'bold',marginBottom:'1rem'}}>Select Profile</h2>
            <div style={{marginBottom:'1rem'}}>
              {teamMembers.map(member => (
                <div key={member.id} style={{padding:'1rem',marginBottom:'0.5rem',border:'2px solid #e2e8f0',borderRadius:'0.75rem',display:'flex',alignItems:'center',gap:'1rem'}}>
                  <div onClick={() => selectCurrentUser(member)} style={{flex:1,display:'flex',alignItems:'center',gap:'1rem',cursor:'pointer'}}>
                    <div style={{width:'44px',height:'44px',borderRadius:'50%',background:member.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.125rem'}}>{member.name.charAt(0)}</div>
                    <div>
                      <div style={{fontWeight:'600'}}>{member.name}</div>
                      <div style={{fontSize:'0.75rem',color:'#64748b'}}>{member.role}</div>
                    </div>
                  </div>
                  <button onClick={() => setEditingUser(editingUser?.id === member.id ? null : member)} style={{padding:'0.5rem',background:'#f1f5f9',border:'none',borderRadius:'0.5rem',cursor:'pointer'}}>‚ãÆ</button>
                  {editingUser?.id === member.id && (
                    <div style={{position:'absolute',right:'1rem',background:'white',border:'2px solid #e2e8f0',borderRadius:'0.75rem',padding:'0.5rem',minWidth:'140px',boxShadow:'0 4px 12px rgba(0,0,0,0.15)',zIndex:10}}>
                      <button onClick={() => updateUserRole(member.id, member.role === 'admin' ? 'rep' : 'admin')} style={{width:'100%',padding:'0.75rem',background:member.role==='admin'?'#f59e0b':'#2563eb',color:'white',border:'none',borderRadius:'0.5rem',fontWeight:'600',cursor:'pointer',marginBottom:'0.5rem',fontSize:'0.875rem'}}>{member.role === 'admin' ? 'Rep' : 'Admin'}</button>
                      <button onClick={() => deleteUser(member.id)} style={{width:'100%',padding:'0.75rem',background:'#ef4444',color:'white',border:'none',borderRadius:'0.5rem',fontWeight:'600',cursor:'pointer',fontSize:'0.875rem'}}>Delete</button>
                    </div>
                  )}
                </div>
              ))}
            </div>
            <button onClick={() => setShowUserModal(true)} style={{width:'100%',padding:'0.75rem',background:'#2563eb',color:'white',border:'none',borderRadius:'0.75rem',fontWeight:'600',cursor:'pointer'}}>‚ûï Add</button>
          </div>
        </div>
      )}

      {/* Add Member Modal */}
      {showUserModal && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10002,padding:'1rem'}} onClick={() => setShowUserModal(false)}>
          <div style={{background:'white',borderRadius:'1rem',padding:'1.5rem',maxWidth:'400px',width:'100%'}} onClick={e => e.stopPropagation()}>
            <h3 style={{fontSize:'1.25rem',fontWeight:'bold',marginBottom:'1rem'}}>Add Member</h3>
            <input value={newUserName} onChange={e => setNewUserName(e.target.value)} placeholder="Name" style={{width:'100%',padding:'0.75rem',border:'1px solid #cbd5e1',borderRadius:'0.5rem',marginBottom:'1rem',fontSize:'1rem'}} />
            <select value={newUserRole} onChange={e => setNewUserRole(e.target.value)} style={{width:'100%',padding:'0.75rem',border:'1px solid #cbd5e1',borderRadius:'0.5rem',marginBottom:'1rem',fontSize:'1rem'}}>
              <option value="rep">Rep</option>
              <option value="admin">Admin</option>
            </select>
            <div style={{display:'flex',gap:'0.5rem'}}>
              <button onClick={addTeamMember} style={{flex:1,padding:'0.75rem',background:'#2563eb',color:'white',border:'none',borderRadius:'0.5rem',fontWeight:'600',cursor:'pointer'}}>Add</button>
              <button onClick={() => {setShowUserModal(false); setNewUserName(""); setNewUserRole("rep");}} style={{flex:1,padding:'0.75rem',background:'#e2e8f0',border:'none',borderRadius:'0.5rem',fontWeight:'600',cursor:'pointer'}}>Cancel</button>
            </div>
          </div>
        </div>
      )}

      {/* Map */}
      <div className="map-container" style={{flex:1,position:'relative'}}>
        <div ref={mapRef} style={{height:'100%',width:'100%'}}></div>
      </div>

      {/* Sidebar/Bottom Panel */}
      {isMobile && sidebarExpanded && (
        <div className="mobile-sidebar" style={{background:'white',overflowY:'auto',WebkitOverflowScrolling:'touch'}}>
          <div style={{padding:'1rem',borderBottom:'1px solid #e2e8f0',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <h1 style={{fontSize:'1.25rem',fontWeight:'bold'}}>RepZone</h1>
            <button onClick={() => setSidebarExpanded(false)} style={{padding:'0.5rem',background:'#f1f5f9',border:'none',borderRadius:'0.5rem',cursor:'pointer'}}>‚úï</button>
          </div>
          
          {/* Controls */}
          <div style={{padding:'1rem'}}>
            <div style={{marginBottom:'1rem'}}>
              <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',marginBottom:'0.5rem'}}>Mode</label>
              <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'0.5rem'}}>
                {[['drop-pin','üìç'],['draw-zone','‚úèÔ∏è'],['select','üëÜ']].map(([m,icon]) => (
                  <button key={m} onClick={()=>setMode(m)} style={{padding:'0.75rem',borderRadius:'0.5rem',border:'none',background:mode===m?'#2563eb':'#f1f5f9',color:mode===m?'white':'#475569',fontSize:'1.25rem',cursor:'pointer'}}>{icon}</button>
                ))}
              </div>
            </div>

            {mode === "drop-pin" && (
              <div style={{padding:'1rem',background:'#dbeafe',borderRadius:'0.75rem',marginBottom:'1rem'}}>
                <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',marginBottom:'0.75rem'}}>Lead Type</label>
                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'0.5rem',marginBottom:'0.75rem'}}>
                  {[['estimate','üí∞','A','#10b981'],['callback','üìû','B','#f59e0b'],['notinterested','üìã','C','#64748b']].map(([s,icon,display,color]) => (
                    <button key={s} onClick={()=>setStatus(s)} style={{padding:'0.75rem',borderRadius:'0.5rem',border:status===s?'none':'2px solid #bfdbfe',background:status===s?color:'white',color:status===s?'white':'#475569',fontSize:'1.125rem',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',gap:'0.25rem'}}>
                      <div>{icon}</div>
                      <div style={{fontSize:'0.625rem',fontWeight:'600'}}>{display}</div>
                    </button>
                  ))}
                </div>
                <input value={note} onChange={e=>setNote(e.target.value)} placeholder="Note" style={{width:'100%',padding:'0.75rem',border:'2px solid #93c5fd',borderRadius:'0.5rem',fontSize:'0.875rem'}} />
              </div>
            )}

            <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem'}}>
              <button onClick={() => trackingEnabled ? stopLocationTracking() : requestLocationPermission(currentUser)} style={{flex:1,padding:'0.75rem',background:trackingEnabled?'#ef4444':'#10b981',color:'white',border:'none',borderRadius:'0.5rem',fontWeight:'600',cursor:'pointer',fontSize:'0.875rem'}}>{trackingEnabled ? '‚è∏ Stop GPS' : '‚ñ∂ Start GPS'}</button>
            </div>

            <div style={{padding:'1rem',background:'#f8fafc',borderRadius:'0.75rem'}}>
              <h3 style={{fontSize:'0.875rem',fontWeight:'600',marginBottom:'0.5rem'}}>Stats</h3>
              <div style={{fontSize:'0.75rem',color:'#64748b'}}>
                üí∞ {stats.estimates} | ‚úÖ {stats.verified} | üö´ {stats.suspicious} | üë• {stats.onlineUsers}
              </div>
            </div>
          </div>
        </div>
      )}

      {isMobile && !sidebarExpanded && (
        <button onClick={() => setSidebarExpanded(true)} style={{position:'fixed',bottom:'1rem',right:'1rem',width:'56px',height:'56px',borderRadius:'50%',background:'#2563eb',color:'white',border:'none',boxShadow:'0 4px 12px rgba(0,0,0,0.2)',cursor:'pointer',fontSize:'1.5rem',zIndex:1000}}>‚ò∞</button>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<RepZoneApp />);
</script>
</body>
</html>
