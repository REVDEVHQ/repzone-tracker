<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>RepZone Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
        }

        .leaflet-container {
            height: 100% !important;
            width: 100% !important;
            touch-action: pan-x pan-y;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tracking-indicator {
            animation: pulse 2s infinite;
        }

        .tab {
            padding: 0.875rem 1.25rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9375rem;
        }

        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        .tab:hover {
            background: #f1f5f9;
        }

        .toast {
            position: fixed;
            top: 5rem;
            right: 1rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 10001;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            border-left: 4px solid #3b82f6;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .icon-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .icon-option {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 2rem;
        }

        .icon-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .icon-option.selected {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        .modern-button {
            transition: all 0.2s;
            font-weight: 600;
            cursor: pointer;
        }

        .modern-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .modern-button:active {
            transform: translateY(0);
        }

        .hamburger-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            width: 54px;
            height: 54px;
            background: white;
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 1002;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .hamburger-btn span {
            width: 26px;
            height: 3px;
            background: #1e293b;
            border-radius: 2px;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .hamburger-btn {
                display: flex;
            }

            .desktop-sidebar {
                display: none !important;
            }

            .toast {
                left: 1rem;
                right: 1rem;
                top: 1rem;
            }
        }

        @media (min-width: 769px) {
            .hamburger-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Location Detection Splash Screen -->
    <div id="locationSplash" class="modal-overlay" style="display: none;">
        <div class="modal-content text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">üìç Detecting Your Location</h2>
            <p class="text-gray-600">Setting up your workspace...</p>
        </div>
    </div>

    <!-- Icon Selection Modal -->
    <div id="iconModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Choose Your Marker Icon</h2>
            <p class="text-gray-600 mb-4">Select an icon for your pins on the map</p>
            
            <div class="icon-selector" id="iconSelector">
                <div class="icon-option" data-icon="üìç">üìç</div>
                <div class="icon-option" data-icon="üè†">üè†</div>
                <div class="icon-option" data-icon="üè¢">üè¢</div>
                <div class="icon-option" data-icon="‚≠ê">‚≠ê</div>
                <div class="icon-option" data-icon="üìã">üìã</div>
                <div class="icon-option" data-icon="‚úÖ">‚úÖ</div>
                <div class="icon-option" data-icon="üéØ">üéØ</div>
                <div class="icon-option" data-icon="üîî">üîî</div>
            </div>

            <button onclick="saveIconSelection()" class="modern-button w-full mt-6 bg-blue-500 text-white py-3 rounded-lg">
                Save Icon Selection
            </button>
        </div>
    </div>

    <!-- Contact Info Modal -->
    <div id="contactModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4" id="contactModalTitle">Add Contact Information</h2>
            <p class="text-gray-600 mb-4">Please provide details for this lead</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Full Name *</label>
                    <input type="text" id="contactName" class="input-field" placeholder="John Doe" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Phone Number *</label>
                    <input type="tel" id="contactPhone" class="input-field" placeholder="(555) 123-4567" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Email (Optional)</label>
                    <input type="email" id="contactEmail" class="input-field" placeholder="john@example.com">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Address</label>
                    <input type="text" id="contactAddress" class="input-field" placeholder="123 Main St">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Notes</label>
                    <textarea id="contactNotes" class="input-field" rows="3" placeholder="Additional details..."></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeContactModal()" class="modern-button flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg">
                    Cancel
                </button>
                <button onclick="saveContact()" class="modern-button flex-1 bg-blue-500 text-white py-3 rounded-lg">
                    Save & Add Pin
                </button>
            </div>
        </div>
    </div>

    <!-- Route Assignment Modal -->
    <div id="routeModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Assign Route</h2>
            <p class="text-gray-600 mb-4">Assign this route to a team member</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Select Team Member *</label>
                    <select id="routeTeamMember" class="input-field">
                        <option value="">Choose a team member...</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Route Name *</label>
                    <input type="text" id="routeName" class="input-field" placeholder="Downtown Route A" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Notification Method</label>
                    <div class="flex gap-2">
                        <label class="flex-1">
                            <input type="checkbox" id="notifyEmail" checked> Email
                        </label>
                        <label class="flex-1">
                            <input type="checkbox" id="notifySMS" checked> Text/SMS
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Custom Message (Optional)</label>
                    <textarea id="routeMessage" class="input-field" rows="3" placeholder="You've been assigned to Downtown Route A..."></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeRouteModal()" class="modern-button flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg">
                    Cancel
                </button>
                <button onclick="assignRoute()" class="modern-button flex-1 bg-green-500 text-white py-3 rounded-lg">
                    Assign & Notify
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Button (for icon change) -->
    <button id="settingsBtn" onclick="showIconModal()" class="fixed bottom-20 right-4 bg-white p-4 rounded-full shadow-lg z-1000" style="z-index: 1000;">
        ‚öôÔ∏è
    </button>

    <!-- Route Assignment Button -->
    <button id="routeBtn" onclick="showRouteModal()" class="fixed bottom-36 right-4 bg-blue-500 text-white px-4 py-3 rounded-full shadow-lg z-1000 font-semibold" style="z-index: 1000;">
        üìç Assign Route
    </button>

    <!-- Map Container -->
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global state
        let map;
        let currentLocation = null;
        let selectedIcon = 'üìç';
        let pendingPinData = null;
        const RDHQ_USER_ID = 'user-1760887469016';

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            // Show location detection splash
            document.getElementById('locationSplash').style.display = 'flex';

            // Load saved icon preference
            const savedIcon = localStorage.getItem('selectedIcon');
            if (savedIcon) {
                selectedIcon = savedIcon;
            } else {
                // First time - show icon selection
                setTimeout(() => {
                    document.getElementById('locationSplash').style.display = 'none';
                    showIconModal();
                }, 1500);
            }

            // Auto-detect location
            try {
                const position = await getCurrentPosition();
                currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Initialize map
                initializeMap(currentLocation.lat, currentLocation.lng);

                // Hide splash screen
                setTimeout(() => {
                    document.getElementById('locationSplash').style.display = 'none';
                    showToast('‚úÖ Location detected! Ready to track.', 'success');
                }, 1000);

            } catch (error) {
                console.error('Location error:', error);
                // Fallback to default location
                initializeMap(40.7128, -74.0060); // NYC default
                document.getElementById('locationSplash').style.display = 'none';
                showToast('‚ö†Ô∏è Using default location. Enable GPS for accurate tracking.', 'warning');
            }

            // Load team members for route assignment
            loadTeamMembers();
        });

        // Get current position with promise
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    resolve,
                    reject,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Initialize map
        function initializeMap(lat, lng) {
            map = L.map('map', {
                zoomControl: true,
                attributionControl: false
            }).setView([lat, lng], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);

            // Add current location marker
            const locationIcon = L.divIcon({
                html: `<div style="font-size: 30px;">üìç</div>`,
                className: 'tracking-indicator',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

            L.marker([lat, lng], { icon: locationIcon })
                .addTo(map)
                .bindPopup('üìç You are here');

            // Handle map clicks for adding pins
            map.on('click', handleMapClick);
        }

        // Handle map click to add pin
        function handleMapClick(e) {
            const leadType = prompt('Enter lead type:\nA - Estimate\nB - Callback\nC - Not Interested\nFD - Flyer Dropped\nK - Knocked');
            
            if (!leadType) return;

            const type = leadType.toUpperCase();
            pendingPinData = {
                lat: e.latlng.lat,
                lng: e.latlng.lng,
                type: type
            };

            // FD (Flyer Dropped) doesn't need contact info
            if (type === 'FD') {
                createPin({
                    ...pendingPinData,
                    name: 'Flyer Dropped',
                    phone: 'N/A',
                    notes: 'Flyer left at location'
                });
                pendingPinData = null;
            } else {
                // Show contact modal for other types
                showContactModal(type);
            }
        }

        // Show icon selection modal
        function showIconModal() {
            document.getElementById('iconModal').style.display = 'flex';
            
            // Highlight currently selected icon
            document.querySelectorAll('.icon-option').forEach(option => {
                if (option.dataset.icon === selectedIcon) {
                    option.classList.add('selected');
                }
                
                option.onclick = () => {
                    document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                };
            });
        }

        // Save icon selection
        function saveIconSelection() {
            const selected = document.querySelector('.icon-option.selected');
            if (selected) {
                selectedIcon = selected.dataset.icon;
                localStorage.setItem('selectedIcon', selectedIcon);
                showToast(`Icon set to ${selectedIcon}`, 'success');
            }
            document.getElementById('iconModal').style.display = 'none';
        }

        // Show contact modal
        function showContactModal(leadType) {
            const typeNames = {
                'A': 'A Lead - Estimate',
                'B': 'B Lead - Callback',
                'C': 'C Lead - Not Interested',
                'K': 'Knocked'
            };

            document.getElementById('contactModalTitle').textContent = `Add Contact Info - ${typeNames[leadType] || leadType}`;
            document.getElementById('contactModal').style.display = 'flex';

            // Clear previous data
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactEmail').value = '';
            document.getElementById('contactAddress').value = '';
            document.getElementById('contactNotes').value = '';
        }

        // Close contact modal
        function closeContactModal() {
            document.getElementById('contactModal').style.display = 'none';
            pendingPinData = null;
        }

        // Save contact and create pin
        function saveContact() {
            const name = document.getElementById('contactName').value.trim();
            const phone = document.getElementById('contactPhone').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const address = document.getElementById('contactAddress').value.trim();
            const notes = document.getElementById('contactNotes').value.trim();

            if (!name || !phone) {
                showToast('‚ùå Name and phone are required!', 'error');
                return;
            }

            createPin({
                ...pendingPinData,
                name,
                phone,
                email,
                address,
                notes
            });

            closeContactModal();
            pendingPinData = null;
        }

        // Create pin on map
        function createPin(data) {
            const icon = L.divIcon({
                html: `<div style="font-size: 24px;">${selectedIcon}</div>`,
                className: '',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });

            const marker = L.marker([data.lat, data.lng], { icon })
                .addTo(map)
                .bindPopup(`
                    <div class="p-2">
                        <strong>${data.type} Lead</strong><br>
                        <strong>Name:</strong> ${data.name}<br>
                        <strong>Phone:</strong> ${data.phone}<br>
                        ${data.email ? `<strong>Email:</strong> ${data.email}<br>` : ''}
                        ${data.address ? `<strong>Address:</strong> ${data.address}<br>` : ''}
                        ${data.notes ? `<strong>Notes:</strong> ${data.notes}` : ''}
                    </div>
                `);

            // Here you would save to database
            console.log('Pin created:', data);
            showToast(`‚úÖ ${data.type} lead added for ${data.name}`, 'success');
        }

        // Show route assignment modal
        function showRouteModal() {
            document.getElementById('routeModal').style.display = 'flex';
        }

        // Close route modal
        function closeRouteModal() {
            document.getElementById('routeModal').style.display = 'none';
        }

        // Load team members
        async function loadTeamMembers() {
            const select = document.getElementById('routeTeamMember');
            
            // Mock data - replace with actual database call
            const teamMembers = [
                { id: '1', name: 'Nathan', email: 'nathan@example.com', phone: '555-0101' },
                { id: '2', name: 'Hector', email: 'hector@example.com', phone: '555-0102' },
                { id: '3', name: 'Sarah', email: 'sarah@example.com', phone: '555-0103' }
            ];

            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.email})`;
                option.dataset.email = member.email;
                option.dataset.phone = member.phone;
                select.appendChild(option);
            });
        }

        // Assign route and send notifications
        async function assignRoute() {
            const memberSelect = document.getElementById('routeTeamMember');
            const routeName = document.getElementById('routeName').value.trim();
            const customMessage = document.getElementById('routeMessage').value.trim();
            const notifyEmail = document.getElementById('notifyEmail').checked;
            const notifySMS = document.getElementById('notifySMS').checked;

            if (!memberSelect.value || !routeName) {
                showToast('‚ùå Please select a team member and enter route name', 'error');
                return;
            }

            const selectedOption = memberSelect.options[memberSelect.selectedIndex];
            const memberData = {
                id: memberSelect.value,
                name: selectedOption.textContent.split(' (')[0],
                email: selectedOption.dataset.email,
                phone: selectedOption.dataset.phone
            };

            // Prepare notification message
            const message = customMessage || 
                `Hi ${memberData.name}, you've been assigned to "${routeName}". Please check the RepZone app for details.`;

            // Send notifications
            const notifications = [];
            
            if (notifyEmail) {
                notifications.push(sendEmailNotification(memberData.email, routeName, message));
            }
            
            if (notifySMS) {
                notifications.push(sendSMSNotification(memberData.phone, routeName, message));
            }

            try {
                await Promise.all(notifications);
                
                // Here you would save route assignment to database
                console.log('Route assigned:', {
                    routeName,
                    assignedTo: memberData.id,
                    assignedBy: RDHQ_USER_ID,
                    timestamp: new Date().toISOString()
                });

                showToast(`‚úÖ Route "${routeName}" assigned to ${memberData.name}. Notifications sent!`, 'success');
                closeRouteModal();

                // Clear form
                document.getElementById('routeName').value = '';
                document.getElementById('routeMessage').value = '';
                memberSelect.value = '';

            } catch (error) {
                console.error('Notification error:', error);
                showToast('‚ö†Ô∏è Route assigned but notification failed. Please inform team member manually.', 'warning');
            }
        }

        // Send email notification (mock - integrate with your backend)
        async function sendEmailNotification(email, routeName, message) {
            console.log('Sending email to:', email);
            console.log('Subject:', `Route Assignment: ${routeName}`);
            console.log('Message:', message);

            // Replace with actual email service integration
            // Example: Use SendGrid, AWS SES, or your backend API
            
            return fetch('/api/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: email,
                    subject: `Route Assignment: ${routeName}`,
                    message: message
                })
            });
        }

        // Send SMS notification (mock - integrate with your backend)
        async function sendSMSNotification(phone, routeName, message) {
            console.log('Sending SMS to:', phone);
            console.log('Message:', message);

            // Replace with actual SMS service integration
            // Example: Use Twilio, AWS SNS, or your backend API
            
            return fetch('/api/send-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: phone,
                    message: `[RepZone] ${message}`
                })
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = colors[type] || colors.info;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>
