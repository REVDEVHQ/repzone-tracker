<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>RepZone Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://sea.refinedpainting.co/js/form_embed.js" type="text/javascript"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; width: 100%; overflow: hidden; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  #map { height: 100% !important; width: 100% !important; }
  
  .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }
  @keyframes progress {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  @keyframes slideIn { 
    from { transform: translateX(400px); opacity: 0; } 
    to { transform: translateX(0); opacity: 1; } 
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }
  @keyframes slideUp { 
    from { transform: translateY(100%); opacity: 0; } 
    to { transform: translateY(0); opacity: 1; } 
  }
  
  .tracking-indicator { animation: pulse 2s infinite; }
  
  .sidebar {
    width: 420px;
    height: 100vh;
    background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
    position: fixed;
    left: 0;
    top: 0;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 1000;
    box-shadow: 4px 0 24px rgba(0,0,0,0.3);
    transition: transform 0.3s ease;
  }
  
  .sidebar::-webkit-scrollbar { width: 8px; }
  .sidebar::-webkit-scrollbar-track { background: #1e293b; }
  .sidebar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
  
  .sidebar-content {
    padding: 1.5rem;
  }
  
  .tab-nav {
    display: flex;
    gap: 0.5rem;
    background: rgba(15, 23, 42, 0.5);
    padding: 0.5rem;
    border-radius: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .tab {
    flex: 1;
    padding: 0.75rem;
    text-align: center;
    border-radius: 0.75rem;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.875rem;
    color: #94a3b8;
    transition: all 0.2s;
  }
  
  .tab.active {
    background: #3b82f6;
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }
  
  .tab:hover:not(.active) {
    background: rgba(59, 130, 246, 0.1);
    color: #cbd5e1;
  }
  
  .card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1rem;
    transition: all 0.2s;
  }
  
  .card:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateY(-2px);
  }
  
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  
  .stat-card {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 0.875rem;
    padding: 1rem;
    text-align: center;
    transition: all 0.2s;
  }
  
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(59, 130, 246, 0.2);
  }
  
  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    line-height: 1;
    margin-bottom: 0.25rem;
  }
  
  .stat-label {
    font-size: 0.75rem;
    color: #94a3b8;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .lead-type-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-top: 1rem;
  }
  
  .lead-type-btn {
    padding: 1.5rem 1rem;
    border-radius: 0.875rem;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-weight: 600;
  }
  
  .lead-type-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }
  
  .lead-type-btn.active {
    border-color: white;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.2);
  }
  
  .lead-type-btn .emoji {
    font-size: 2rem;
    display: block;
    margin-bottom: 0.5rem;
  }
  
  .lead-type-btn .label {
    font-size: 0.875rem;
    font-weight: 700;
  }
  
  .btn {
    padding: 0.875rem 1.5rem;
    border-radius: 0.75rem;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9375rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }
  
  .btn-primary:hover {
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
    transform: translateY(-1px);
  }
  
  .btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
  }
  
  .input {
    width: 100%;
    padding: 0.875rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(0, 0, 0, 0.2);
    color: white;
    font-size: 0.9375rem;
    transition: all 0.2s;
  }
  
  .input::placeholder {
    color: #64748b;
  }
  
  .input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .toast {
    position: fixed;
    top: 1.5rem;
    right: 1.5rem;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 10001;
    animation: slideIn 0.3s ease;
    max-width: 400px;
    border-left: 4px solid #3b82f6;
  }
  
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.2s;
    padding: 1rem;
  }
  
  .modal-content {
    background: white;
    border-radius: 1.5rem;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s;
  }
  
  .user-selection-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .user-selection-item:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-1px);
  }
  
  .user-selection-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
    color: white;
    flex-shrink: 0;
  }
  
  .user-badge {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    background: white;
    border: 2px solid #10b981;
    border-radius: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
    color: white;
  }
  
  .hamburger-btn {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    width: 54px;
    height: 54px;
    background: white;
    border: none;
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 1002;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
  }
  
  .hamburger-btn span {
    width: 26px;
    height: 3px;
    background: #1e293b;
    border-radius: 2px;
    transition: all 0.3s;
  }
  
  .hamburger-btn.open span:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
  }
  
  .hamburger-btn.open span:nth-child(2) {
    opacity: 0;
  }
  
  .hamburger-btn.open span:nth-child(3) {
    transform: rotate(-45deg) translate(8px, -8px);
  }
  
  .zone-item {
    padding: 0.875rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .zone-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(4px);
  }
  
  .zone-item.active {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.2);
  }
  
  .leaderboard-item {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 0.875rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s;
  }
  
  .leaderboard-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(4px);
  }
  
  .rank-badge {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
  }
  
  .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
  .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); }
  .rank-3 { background: linear-gradient(135deg, #fb923c, #f97316); }
  
  .zone-debug-banner {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: #fef3c7;
    border: 2px solid #f59e0b;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 600;
    color: #92400e;
    max-width: 90%;
    text-align: center;
  }
  
  .zone-debug-banner button {
    margin-left: 1rem;
    background: #f59e0b;
    color: white;
    border: none;
    padding: 0.25rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-weight: 600;
  }
  
  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
      transform: translateX(-100%);
    }
    
    .sidebar.open {
      transform: translateX(0);
    }
    
    .hamburger-btn {
      display: flex;
    }
    
    #map {
      width: 100% !important;
      margin-left: 0 !important;
    }
  }
  
  @media (min-width: 769px) {
    #map {
      margin-left: 420px;
      width: calc(100% - 420px) !important;
    }
  }
</style>
</head>
<body>
<button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMobileMenu()">
  <span></span>
  <span></span>
  <span></span>
</button>

<div id="root"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxqGzPnCxZNpH3Xopsk4VnwZOxVLjSQWc&libraries=places&callback=initGoogleMaps" async defer></script>

<script>
window.gm_authFailure = function() {
  console.error('Google Maps authentication failed');
};

window.initGoogleMaps = function() {
  console.log('Google Maps loaded successfully');
  window.googleMapsReady = true;
  if (window.startRepZoneApp) {
    window.startRepZoneApp();
  }
};

window.toggleMobileMenu = function() {
  const sidebar = document.querySelector('.sidebar');
  const hamburger = document.getElementById('hamburgerBtn');
  if (sidebar && hamburger) {
    sidebar.classList.toggle('open');
    hamburger.classList.toggle('open');
  }
};
</script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SUPABASE_URL = 'https://cytikhfyygkovnjtpsth.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dGlraGZ5eWdrb3ZuanRwc3RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTc3NzYsImV4cCI6MjA3NjI5Mzc3Nn0.ItJObIXo_Ks8TEigj5RkUA4vXbze_3FMMIzYyVHrthQ';

const COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];

const LEAD_TYPES = {
  estimate: { icon: 'üí∞', label: 'A - Estimate', color: '#10b981', display: 'A' },
  callback: { icon: 'üìû', label: 'B - Callback 1-2 Weeks', color: '#f59e0b', display: 'B' },
  notinterested: { icon: 'üìã', label: 'C - Not Interested (Has Info)', color: '#64748b', display: 'C' },
  flyer: { icon: 'üì¨', label: 'FD - Flyer Drop', color: '#3b82f6', display: 'FD' },
  knocked: { icon: '‚úÖ', label: 'Knocked', color: '#16a34a', display: '‚úÖ' },
  skipped: { icon: '‚è≠Ô∏è', label: 'Skipped', color: '#ef4444', display: '‚è≠Ô∏è' }
};

const GPS_MAX_AGE_MS = 30000;
const ZONE_BACKUP_KEY = 'repzone_assigned_zones_backup';
const ZONE_HISTORY_KEY = 'repzone_zone_history';
const GHL_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6ImVuMmQ4Q2FxR0Q4YTNTRUNNSEY4eiIsImNvbXBhbnlfaWQiOiJPY3JQM2ljTW5tcTlXSkxLRkhvTSIsInZlcnNpb24iOjEsImlhdCI6MTczNDg0NjI5NDUzOCwic3ViIjoiSGZ5Y045M1RsN3VHckFQZ2l2MjQifQ.m7c5fHpJldhJLwp14cA0XOmRNgEbnGJy5ufQxCiujRA';
const GHL_LOCATION_ID = 'en2d8CaqGD8a3SEMVFHz';
const GHL_CALENDAR_URL = 'https://sea.refinedpainting.co/widget/booking/fIYuXbwwo4XQh3nyLxj8';
const ADMIN_USER_IDS = ['user-1760858671762', 'user-1760855853315'];

// Keep all your existing helper functions
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c * 3.28084;
}

function getVerificationStatus(distance) {
  if (distance <= 50) return { status: 'verified', color: '#10b981', icon: '‚úÖ', label: 'Verified' };
  if (distance <= 150) return { status: 'questionable', color: '#f59e0b', icon: '‚ö†Ô∏è', label: 'Questionable' };
  return { status: 'suspicious', color: '#ef4444', icon: 'üö´', label: 'Suspicious' };
}

function isPointInPolygon(point, polygon) {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i].lat, yi = polygon[i].lng;
    const xj = polygon[j].lat, yj = polygon[j].lng;
    const intersect = ((yi > point.lng) !== (yj > point.lng)) && (point.lat < (xj - xi) * (point.lng - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function isGPSFresh(location) {
  if (!location || !location.timestamp) return false;
  const age = Date.now() - location.timestamp;
  return age < GPS_MAX_AGE_MS;
}

function getGPSAge(location) {
  if (!location || !location.timestamp) return null;
  return Math.floor((Date.now() - location.timestamp) / 1000);
}

const backupZones = (zones) => {
  try {
    const backupData = { zones, timestamp: new Date().toISOString(), count: zones.length };
    localStorage.setItem(ZONE_BACKUP_KEY, JSON.stringify(backupData));
    const history = JSON.parse(localStorage.getItem(ZONE_HISTORY_KEY) || '[]');
    history.unshift(backupData);
    localStorage.setItem(ZONE_HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
  } catch (e) { console.error('‚ùå Backup failed:', e); }
};

const restoreZonesFromBackup = () => {
  try {
    const backup = localStorage.getItem(ZONE_BACKUP_KEY);
    if (backup) {
      const data = JSON.parse(backup);
      return data.zones;
    }
  } catch (e) { console.error('‚ùå Restore failed:', e); }
  return null;
};

const detectZoneDeletion = (oldCount, newCount) => {
  if (oldCount === 0) return { deleted: false };
  const percentChange = ((oldCount - newCount) / oldCount) * 100;
  if (newCount === 0 && oldCount > 0) {
    return { deleted: true, severity: 'critical', message: `‚ö†Ô∏è ALL ${oldCount} zones disappeared!` };
  } else if (percentChange > 50) {
    return { deleted: true, severity: 'warning', message: `‚ö†Ô∏è Zones dropped: ${oldCount} ‚Üí ${newCount}` };
  }
  return { deleted: false };
};

// Google Maps Geocoding
async function reverseGeocode(lat, lng) {
  return new Promise((resolve) => {
    if (!window.google) {
      resolve(null);
      return;
    }
    
    const geocoder = new window.google.maps.Geocoder();
    geocoder.geocode({ location: { lat, lng } }, (results, status) => {
      if (status === 'OK' && results[0]) {
        const result = results[0];
        const addr = {};
        
        result.address_components.forEach(component => {
          if (component.types.includes('street_number')) addr.house_number = component.long_name;
          if (component.types.includes('route')) addr.road = component.long_name;
          if (component.types.includes('locality')) addr.city = component.long_name;
          if (component.types.includes('administrative_area_level_1')) addr.state = component.short_name;
          if (component.types.includes('postal_code')) addr.postcode = component.long_name;
          if (component.types.includes('neighborhood')) addr.suburb = component.long_name;
        });
        
        let fullAddress = result.formatted_address;
        let shortAddress = '';
        if (addr.house_number && addr.road) {
          shortAddress = `${addr.house_number} ${addr.road}`;
        } else if (addr.road) {
          shortAddress = addr.road;
        } else if (addr.suburb) {
          shortAddress = addr.suburb;
        } else {
          shortAddress = addr.city || 'Unknown';
        }
        
        resolve({
          fullAddress,
          shortAddress,
          houseNumber: addr.house_number,
          street: addr.road,
          suburb: addr.suburb,
          city: addr.city,
          state: addr.state,
          postcode: addr.postcode,
          lat: result.geometry.location.lat(),
          lng: result.geometry.location.lng(),
          displayName: result.formatted_address
        });
      } else {
        resolve(null);
      }
    });
  });
}

async function forwardGeocode(query) {
  return new Promise((resolve) => {
    if (!window.google) {
      resolve([]);
      return;
    }
    
    const geocoder = new window.google.maps.Geocoder();
    geocoder.geocode({ address: query }, (results, status) => {
      if (status === 'OK' && results) {
        resolve(results.slice(0, 5).map(result => ({
          displayName: result.formatted_address,
          lat: result.geometry.location.lat(),
          lng: result.geometry.location.lng(),
          type: result.types[0]
        })));
      } else {
        resolve([]);
      }
    });
  });
}

async function sendContactToGHL(contactData) {
  try {
    const response = await fetch('https://services.leadconnectorhq.com/contacts/', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${GHL_API_KEY}`,
        'Content-Type': 'application/json',
        'Version': '2021-07-28'
      },
      body: JSON.stringify({
        locationId: GHL_LOCATION_ID,
        firstName: contactData.name?.split(' ')[0] || contactData.name,
        lastName: contactData.name?.split(' ').slice(1).join(' ') || '',
        name: contactData.name,
        email: contactData.email || '',
        phone: contactData.phone || '',
        address1: contactData.address || '',
        tags: [
          'Door-to-Door',
          contactData.leadType || 'Unknown',
          contactData.verified ? 'GPS-Verified' : 'Unverified'
        ],
        source: 'RepZone App',
        customField: {
          rep_name: contactData.repName,
          lead_type: contactData.leadType,
          gps_distance: contactData.distance,
          pin_created_at: contactData.createdAt
        }
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('GHL Error:', errorText);
      throw new Error(`GHL API error: ${response.status}`);
    }

    const data = await response.json();
    console.log('‚úÖ Contact created in GHL:', data);
    return data;
  } catch (error) {
    console.error('‚ùå Failed to send to GHL:', error);
    throw error;
  }
}

function openGHLCalendar(customerName, customerEmail, customerPhone, address) {
  window.showCalendarModal({
    name: customerName || '',
    email: customerEmail || '',
    phone: customerPhone || '',
    address: address || ''
  });
}

function RepZoneApp() {
  // Keep ALL your existing state declarations
  const [pins, setPins] = useState([]);
  const [zones, setZones] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [liveLocations, setLiveLocations] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentLocation, setCurrentLocation] = useState(null);
  const [mode, setMode] = useState("drop-pin");
  const [status, setStatus] = useState("estimate");
  const [activeZoneId, setActiveZoneId] = useState(null);
  const [selectedZone, setSelectedZone] = useState(null);
  const [note, setNote] = useState("");
  const [filter, setFilter] = useState({ status: "all", userId: "all" });
  const [activeTab, setActiveTab] = useState("controls");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [mapReady, setMapReady] = useState(false);
  const [showUserModal, setShowUserModal] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [newUserName, setNewUserName] = useState("");
  const [newUserRole, setNewUserRole] = useState("rep");
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [leaderboardPeriod, setLeaderboardPeriod] = useState('week');
  const [leaderboardType, setLeaderboardType] = useState('d2d');
  const [trackingEnabled, setTrackingEnabled] = useState(false);
  const [showLiveTracking, setShowLiveTracking] = useState(true);
  const [toastMessage, setToastMessage] = useState(null);
  const [geocoding, setGeocoding] = useState(false);
  const [addressSearch, setAddressSearch] = useState("");
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  const [showCustomerForm, setShowCustomerForm] = useState(false);
  const [customerName, setCustomerName] = useState('');
  const [customerPhone, setCustomerPhone] = useState('');
  const [customerEmail, setCustomerEmail] = useState('');
  const [customerNote, setCustomerNote] = useState('');
  const [showCalendarModal, setShowCalendarModal] = useState(false);
  const [calendarData, setCalendarData] = useState(null);
  const [pendingPinLocation, setPendingPinLocation] = useState(null);
  const [fdMode, setFdMode] = useState(false);
  const [assignedZones, setAssignedZones] = useState([]);
  const [showZoneDebug, setShowZoneDebug] = useState(false);
  const [zoneDebugInfo, setZoneDebugInfo] = useState('');
  const [previousZoneCount, setPreviousZoneCount] = useState(0);
  const [drawingZone, setDrawingZone] = useState(false);
  const [zonePoints, setZonePoints] = useState([]);

  // Keep ALL your existing refs
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const supabase = useRef(null);
  const locationWatchId = useRef(null);
  const locationUpdateInterval = useRef(null);
  const searchTimeoutRef = useRef(null);
  const markersRef = useRef([]);
  const userMarkerRef = useRef(null);
  const zonePolygonsRef = useRef([]);
  const drawingPolygonRef = useRef(null);

  // Keep ALL existing functions (setSupabaseUser, handleModeChange, showToast, etc.)
  async function setSupabaseUser(userId) {
    if (!userId || !supabase.current) return;
    try {
      await supabase.current.rpc('set_current_user', { user_id: userId });
    } catch (e) {
      console.error('Error setting user context:', e);
    }
  }

  function handleModeChange(newMode) {
    if (mode === "draw-zone" && newMode !== "draw-zone") {
      setActiveZoneId(null);
    }
    setMode(newMode);
  }

  function showToast(message, duration = 4000) {
    setToastMessage(message);
    setTimeout(() => setToastMessage(null), duration);
  }

  // Initialize Google Maps instead of Leaflet
  useEffect(() => {
    if (!mapRef.current || mapInstanceRef.current || loading || !window.googleMapsReady) return;
    
    const map = new window.google.maps.Map(mapRef.current, {
      center: { lat: 47.6062, lng: -122.3321 },
      zoom: isMobile ? 12 : 13,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
      styles: [
        { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }
      ]
    });

    // Auto-center on user's location when available
    if (currentLocation) {
      map.setCenter({ lat: currentLocation.lat, lng: currentLocation.lng });
      map.setZoom(16);
    } else if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          map.setCenter({ lat: position.coords.latitude, lng: position.coords.longitude });
          map.setZoom(16);
        },
        () => console.log('Using default location')
      );
    }

    mapInstanceRef.current = map;
    
    // Add click listener
    map.addListener('click', (e) => {
      if (drawingZone) {
        addZonePoint(e.latLng.lat(), e.latLng.lng());
      } else if (mode === 'drop-pin') {
        handleMapClick(e.latLng.lat(), e.latLng.lng());
      }
    });
    
    setMapReady(true);
  }, [loading, isMobile, window.googleMapsReady]);

  // Update markers with Google Maps
  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current) return;
    
    // Clear existing markers
    markersRef.current.forEach(m => m.setMap(null));
    markersRef.current = [];
    
    const filtered = pins.filter(p => {
      if (filter.status !== "all" && p.status !== filter.status) return false;
      if (filter.userId !== "all" && p.team_member_id !== filter.userId) return false;
      return true;
    });

    filtered.forEach(pin => {
      const user = teamMembers.find(u => u.id === pin.team_member_id);
      const leadType = LEAD_TYPES[pin.status] || LEAD_TYPES.knocked;
      const verification = pin.verification_status ? getVerificationStatus(pin.distance_from_pin || 0) : null;
      
      let strokeColor = 'white';
      if (verification) {
        strokeColor = verification.color;
      }
      
      const marker = new window.google.maps.Marker({
        position: { lat: pin.lat, lng: pin.lng },
        map: mapInstanceRef.current,
        icon: {
          path: window.google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: leadType.color,
          fillOpacity: 1,
          strokeColor,
          strokeWeight: 4
        },
        title: `${leadType.label} - ${user?.name || 'Unknown'}`
      });
      
      // Extract customer info
      let customerInfo = null;
      let displayNote = pin.note || '';
      if (pin.note && pin.note.includes(' - ') && pin.note.includes('@')) {
        const parts = pin.note.split(' | ');
        const custPart = parts[0];
        displayNote = parts[1] || '';
        const custDetails = custPart.split(' - ');
        if (custDetails.length >= 2) {
          customerInfo = {
            name: custDetails[0],
            email: custDetails[1],
            phone: custDetails[2] || null
          };
        }
      }
      
      const infoWindow = new window.google.maps.InfoWindow({
        content: `
          <div style="min-width:240px;padding:0;font-family:-apple-system,sans-serif;border-radius:12px;overflow:hidden">
            <div style="background:${leadType.color};padding:16px;color:white">
              <div style="font-size:24px;margin-bottom:4px">${leadType.icon}</div>
              <div style="font-size:18px;font-weight:700">${leadType.label}${customerInfo ? ` - ${customerInfo.name}` : ''}</div>
            </div>
            
            <div style="padding:16px;background:white">
              ${pin.address ? `
                <div style="padding:12px;background:#f8fafc;border-left:4px solid #64748b;margin-bottom:12px;border-radius:6px">
                  <div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:6px">üìç ADDRESS</div>
                  <div style="font-weight:600;color:#1e293b;font-size:13px;line-height:1.5">${pin.address}</div>
                  ${customerInfo ? `
                    <div style="border-top:1px solid #e2e8f0;padding-top:8px;margin-top:8px">
                      ${customerInfo.email ? `<div style="color:#3b82f6;font-size:13px;margin-bottom:4px">üìß ${customerInfo.email}</div>` : ''}
                      ${customerInfo.phone ? `<div style="color:#3b82f6;font-size:13px">üìû ${customerInfo.phone}</div>` : ''}
                    </div>
                  ` : ''}
                </div>
              ` : ''}
              
              <div style="padding:10px;background:${user?.color || '#64748b'}15;border-left:4px solid ${user?.color || '#64748b'};margin-bottom:12px;border-radius:6px">
                <div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:4px">üë§ REP</div>
                <div style="font-weight:700;color:${user?.color || '#64748b'};font-size:14px">${pin.rep_name || 'Unknown'}</div>
              </div>
              
              ${displayNote ? `
                <div style="padding:10px;background:#f8fafc;border-left:4px solid #64748b;margin-bottom:12px;border-radius:6px">
                  <div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:4px">üìù NOTE</div>
                  <div style="color:#1e293b;font-size:13px">${displayNote}</div>
                </div>
              ` : ''}
              
              ${verification ? `
                <div style="padding:12px;background:${verification.color}15;border-left:4px solid ${verification.color};margin-bottom:12px;border-radius:6px">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
                    <span style="font-size:24px">${verification.icon}</span>
                    <div>
                      <div style="font-weight:700;color:${verification.color};font-size:15px">${verification.label}</div>
                      <div style="font-size:13px;color:#64748b;margin-top:2px">Distance: <b>${pin.distance_from_pin} feet</b></div>
                    </div>
                  </div>
                </div>
              ` : ''}
              
              <div style="font-size:12px;color:#94a3b8;margin-bottom:14px;text-align:center">
                ${new Date(pin.created_at).toLocaleString()}
              </div>
              
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px">
                ${Object.entries(LEAD_TYPES).slice(0,3).map(([key, type]) => `
                  <button onclick="window.updatePinStatusGlobal('${pin.id}','${key}')" style="padding:10px 6px;background:${type.color};color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer">${type.display}</button>
                `).join('')}
              </div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px">
                ${Object.entries(LEAD_TYPES).slice(3).map(([key, type]) => `
                  <button onclick="window.updatePinStatusGlobal('${pin.id}','${key}')" style="padding:10px 6px;background:${type.color};color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer">${type.display}</button>
                `).join('')}
              </div>
              
              ${customerInfo ? `
                <button onclick="window.openGHLCalendarGlobal('${customerInfo.name}','${customerInfo.email || ''}','${customerInfo.phone || ''}','${pin.address || ''}')" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;margin-bottom:8px;cursor:pointer">üìÖ Book Appointment</button>
              ` : ''}
              
              <button onclick="window.deletePinGlobal('${pin.id}')" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer">üóëÔ∏è Delete Pin</button>
            </div>
          </div>
        `
      });
      
      marker.addListener('click', () => infoWindow.open(mapInstanceRef.current, marker));
      markersRef.current.push(marker);
    });
  }, [pins, filter, teamMembers, mapReady]);

  // Update zones with Google Maps
  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current) return;
    
    zonePolygonsRef.current.forEach(p => p.setMap(null));
    zonePolygonsRef.current = [];

    zones.forEach(zone => {
      if (!zone.points || zone.points.length < 3) return;
      
      const assigned = teamMembers.find(u => u.id === zone.assigned_to);
      
      const polygon = new window.google.maps.Polygon({
        paths: zone.points.map(p => ({ lat: p[0], lng: p[1] })),
        map: mapInstanceRef.current,
        fillColor: assigned?.color || zone.color,
        fillOpacity: 0.2,
        strokeColor: assigned?.color || zone.color,
        strokeWeight: 3,
        clickable: mode !== "drop-pin"
      });
      
      if (mode === "select") {
        polygon.addListener('click', () => {
          setSelectedZone(zone);
        });
      }
      
      const infoWindow = new window.google.maps.InfoWindow({
        content: `
          <div style="padding:12px;min-width:180px;font-family:-apple-system,sans-serif">
            <b style="font-size:17px;color:#1e293b">${zone.name}</b><br>
            <div style="margin-top:8px">
              ${assigned ? `<span style="color:${assigned.color};font-weight:600;font-size:15px">üë§ ${assigned.name}</span>` : '<span style="color:#64748b;font-weight:600">‚ö†Ô∏è Unassigned</span>'}
            </div>
            ${mode === "select" ? '<div style="margin-top:8px;font-size:13px;color:#64748b">Click to manage zone</div>' : ''}
          </div>
        `
      });
      
      polygon.addListener('click', (e) => {
        infoWindow.setPosition(e.latLng);
        infoWindow.open(mapInstanceRef.current);
      });
      
      zonePolygonsRef.current.push(polygon);
    });
  }, [zones, teamMembers, mode, mapReady]);

  // Update user location marker with Google Maps
  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current) return;
    
    if (userMarkerRef.current) {
      userMarkerRef.current.marker?.setMap(null);
      userMarkerRef.current.circle?.setMap(null);
    }

    if (currentLocation && currentUser) {
      const gpsAge = getGPSAge(currentLocation);
      const isFresh = isGPSFresh(currentLocation);
      
      const marker = new window.google.maps.Marker({
        position: { lat: currentLocation.lat, lng: currentLocation.lng },
        map: mapInstanceRef.current,
        icon: {
          path: window.google.maps.SymbolPath.CIRCLE,
          scale: 14,
          fillColor: currentUser.color,
          fillOpacity: 1,
          strokeColor: isFresh ? '#10b981' : '#f59e0b',
          strokeWeight: 5
        },
        title: 'You'
      });
      
      const circle = new window.google.maps.Circle({
        map: mapInstanceRef.current,
        center: { lat: currentLocation.lat, lng: currentLocation.lng },
        radius: 50,
        fillColor: currentUser.color,
        fillOpacity: 0.3,
        strokeColor: currentUser.color,
        strokeWeight: 3
      });
      
      const infoWindow = new window.google.maps.InfoWindow({
        content: `
          <div style="padding:14px;text-align:center;font-family:-apple-system,sans-serif">
            <div style="font-weight:700;font-size:18px;color:${currentUser.color};margin-bottom:6px">üìç You Are Here</div>
            <div style="font-size:13px;color:#64748b">GPS: ${gpsAge}s old ${isFresh ? '‚úÖ' : '‚ö†Ô∏è Stale'}</div>
          </div>
        `
      });
      
      marker.addListener('click', () => infoWindow.open(mapInstanceRef.current, marker));
      
      userMarkerRef.current = { marker, circle };
    }
  }, [currentLocation, currentUser, mapReady]);

  // Zone drawing functions
  const startDrawingZone = () => {
    setDrawingZone(true);
    setZonePoints([]);
    showToast('Click on map to draw zone');
  };

  const addZonePoint = (lat, lng) => {
    const newPoints = [...zonePoints, { lat, lng }];
    setZonePoints(newPoints);
    
    if (drawingPolygonRef.current) {
      drawingPolygonRef.current.setMap(null);
    }
    
    if (newPoints.length > 1) {
      drawingPolygonRef.current = new window.google.maps.Polygon({
        paths: newPoints,
        map: mapInstanceRef.current,
        fillColor: '#3b82f6',
        fillOpacity: 0.2,
        strokeColor: '#3b82f6',
        strokeWeight: 2
      });
    }
  };

  const finishDrawingZone = async () => {
    if (zonePoints.length < 3) {
      showToast('Need at least 3 points');
      return;
    }
    
    const zoneName = prompt('Enter zone name:');
    if (!zoneName) return;
    
    try {
      await setSupabaseUser(currentUser.id);
      const newZone = {
        id: `zone-${Date.now()}`,
        name: zoneName,
        color: COLORS[zones.length % COLORS.length],
        points: zonePoints.map(p => [p.lat, p.lng]),
        created_by: currentUser.name,
        assigned_to: null,
        created_at: new Date().toISOString()
      };
      
      await supabase.current.from('zones').insert([newZone]);
      setZones(prev => [...prev, newZone]);
      showToast('‚úÖ Zone created!');
      cancelDrawingZone();
    } catch (error) {
      showToast('‚ùå Error creating zone: ' + error.message);
    }
  };

  const cancelDrawingZone = () => {
    setDrawingZone(false);
    setZonePoints([]);
    if (drawingPolygonRef.current) {
      drawingPolygonRef.current.setMap(null);
      drawingPolygonRef.current = null;
    }
  };

  // Keep ALL your existing useEffects for data loading, location tracking, etc.
  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    supabase.current = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    loadData();
    const saved = localStorage.getItem('current_user_id');
    if (saved) {
      try {
        const user = JSON.parse(saved);
        setCurrentUser(user);
        requestLocationPermission(user);
      } catch (e) {
        console.error('Error parsing saved user:', e);
      }
    }
  }, []);

  useEffect(() => {
    if (currentUser && teamMembers.length > 0) {
      const updatedUser = teamMembers.find(m => m.id === currentUser.id);
      if (updatedUser && updatedUser.role !== currentUser.role) {
        setCurrentUser(updatedUser);
        localStorage.setItem('current_user_id', JSON.stringify(updatedUser));
      }
    }
  }, [teamMembers]);

  useEffect(() => {
    if (!supabase.current) return;
    loadLiveLocations();
    const interval = setInterval(loadLiveLocations, 10000);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    if (searchTimeoutRef.current) {
      clearTimeout(searchTimeoutRef.current);
    }

    if (addressSearch.trim().length < 3) {
      setSearchResults([]);
      return;
    }

    setSearching(true);
    searchTimeoutRef.current = setTimeout(async () => {
      const results = await forwardGeocode(addressSearch);
      setSearchResults(results);
      setSearching(false);
    }, 500);

    return () => {
      if (searchTimeoutRef.current) {
        clearTimeout(searchTimeoutRef.current);
      }
    };
  }, [addressSearch]);

  useEffect(() => {
    window.deletePinGlobal = deletePin;
    window.updatePinStatusGlobal = updatePinStatus;
    window.openGHLCalendarGlobal = openGHLCalendar;
    window.showCalendarModal = (data) => {
      setCalendarData(data);
      setShowCalendarModal(true);
    };
    return () => {
      delete window.deletePinGlobal;
      delete window.updatePinStatusGlobal;
      delete window.openGHLCalendarGlobal;
      delete window.showCalendarModal;
    };
  }, [currentUser]);

  useEffect(() => {
    if (currentLocation && currentUser && trackingEnabled) {
      updateLiveLocation(currentUser.id, currentLocation);
    }
  }, [currentLocation, currentUser, trackingEnabled]);

  useEffect(() => () => stopLocationTracking(), []);

  // Keep ALL your existing data loading and manipulation functions
  async function loadData() {
    try {
      const [pinsRes, zonesRes, teamRes, assignedZonesRes] = await Promise.all([
        supabase.current.from('pins').select('*'),
        supabase.current.from('zones').select('*'),
        supabase.current.from('team_members').select('*'),
        supabase.current.from('assigned_zones').select('*').is('deleted_at', null)
      ]);
      setPins(pinsRes.data || []);
      setZones(zonesRes.data || []);
      setTeamMembers(teamRes.data || []);
      
      const newZones = assignedZonesRes.data || [];
      const deletion = detectZoneDeletion(previousZoneCount, newZones.length);
      
      if (deletion.deleted && deletion.severity === 'critical') {
        const backup = restoreZonesFromBackup();
        if (backup?.length > 0) {
          setZoneDebugInfo(deletion.message + ` Backup: ${backup.length} zones`);
          setShowZoneDebug(true);
          if (confirm(`CRITICAL: Zones disappeared! Restore ${backup.length} from backup?`)) {
            await restoreZonesToDatabase(backup);
            return;
          }
          setAssignedZones(backup);
          setPreviousZoneCount(backup.length);
          return;
        }
      } else if (deletion.deleted) {
        setZoneDebugInfo(deletion.message);
        setShowZoneDebug(true);
      }
      
      setAssignedZones(newZones);
      if (newZones.length > 0) {
        setPreviousZoneCount(newZones.length);
        backupZones(newZones);
      }
    } catch (e) { console.error('Load error:', e); }
    setLoading(false);
  }

  async function loadLiveLocations() {
    try {
      const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      const { data, error } = await supabase.current
        .from('live_locations')
        .select('*')
        .gte('last_updated', fiveMinutesAgo)
        .eq('is_active', true);
      if (!error && data) setLiveLocations(data);
    } catch (e) {}
  }

  async function requestLocationPermission(user) {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      () => startLocationTracking(user),
      () => {}
    );
  }

  function startLocationTracking(user) {
    if (!user || locationWatchId.current) return;
    setTrackingEnabled(true);
    locationWatchId.current = navigator.geolocation.watchPosition(
      (position) => {
        setCurrentLocation({
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: Date.now()
        });
      },
      () => {},
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
    );
    locationUpdateInterval.current = setInterval(() => {
      if (currentLocation && user) updateLiveLocation(user.id, currentLocation);
    }, 30000);
  }

  function stopLocationTracking() {
    if (locationWatchId.current) {
      navigator.geolocation.clearWatch(locationWatchId.current);
      locationWatchId.current = null;
    }
    if (locationUpdateInterval.current) {
      clearInterval(locationUpdateInterval.current);
      locationUpdateInterval.current = null;
    }
    setTrackingEnabled(false);
    if (currentUser) {
      updateLiveLocationInactive(currentUser.id);
    }
  }

  async function updateLiveLocation(userId, location) {
    try {
      await setSupabaseUser(userId);
      await supabase.current.from('live_locations').upsert({
        team_member_id: userId,
        lat: location.lat,
        lng: location.lng,
        accuracy: location.accuracy,
        last_updated: new Date().toISOString(),
        is_active: true
      }, { onConflict: 'team_member_id' });
      loadLiveLocations();
    } catch (e) {}
  }

  async function updateLiveLocationInactive(userId) {
    try {
      await setSupabaseUser(userId);
      await supabase.current.from('live_locations').update({ is_active: false }).eq('team_member_id', userId);
    } catch (e) {}
  }

  async function deletePin(pinId) {
    if (!confirm('Delete this pin?')) return;
    if (!currentUser) return;
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('pins').delete().eq('id', pinId);
      setPins(prev => prev.filter(p => p.id !== pinId));
      showToast('‚úÖ Pin deleted successfully!');
    } catch (e) {
      showToast('‚ùå Error deleting pin: ' + e.message);
    }
  }

  async function updatePinStatus(pinId, newStatus) {
    if (!currentUser) return;
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('pins').update({ status: newStatus }).eq('id', pinId);
      setPins(prev => prev.map(p => p.id === pinId ? {...p, status: newStatus} : p));
      showToast(`‚úÖ Updated to ${LEAD_TYPES[newStatus]?.label || newStatus}!`);
    } catch (e) {
      showToast('‚ùå Error updating pin: ' + e.message);
    }
  }

  async function deleteUser(userId) {
    if (!confirm('Delete this user? All their pins will remain.')) return;
    
    if (!currentUser || !ADMIN_USER_IDS.includes(currentUser.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can delete users!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').delete().eq('id', userId);
      setTeamMembers(prev => prev.filter(u => u.id !== userId));
      if (currentUser?.id === userId) setCurrentUser(null);
      showToast('‚úÖ User deleted!');
    } catch (e) {
      showToast('‚ùå Error deleting user: ' + e.message);
    }
  }

  async function updateUserRole(userId, newRole) {
    if (!currentUser || !ADMIN_USER_IDS.includes(currentUser.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can change roles!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').update({ role: newRole }).eq('id', userId);
      setTeamMembers(prev => prev.map(u => u.id === userId ? {...u, role: newRole} : u));
      if (currentUser?.id === userId) {
        const updatedUser = {...currentUser, role: newRole};
        setCurrentUser(updatedUser);
        localStorage.setItem('current_user_id', JSON.stringify(updatedUser));
      }
      setEditingUser(null);
      showToast(`‚úÖ Role updated to ${newRole}!`);
    } catch (e) {
      showToast('‚ùå Error updating role: ' + e.message);
    }
  }

  async function assignZone(zoneId, userId) {
    if (!currentUser || !ADMIN_USER_IDS.includes(currentUser.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can assign zones!');
      return;
    }
    
    const member = teamMembers.find(m => m.id === userId);
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').update({ 
        assigned_to: userId,
        color: member?.color || COLORS[0]
      }).eq('id', zoneId);
      setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: userId, color: member?.color} : z));
      setSelectedZone(null);
      showToast(`‚úÖ Zone assigned to ${member.name}!`);
    } catch (e) {
      showToast('‚ùå Error assigning zone: ' + e.message);
    }
  }

  async function unassignZone(zoneId) {
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can unassign zones!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').update({ assigned_to: null }).eq('id', zoneId);
      setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: null} : z));
      setSelectedZone(null);
      showToast('‚úÖ Zone unassigned!');
    } catch (e) {
      showToast('‚ùå Error unassigning zone: ' + e.message);
    }
  }

  async function restoreZonesToDatabase(zones) {
    try {
      showToast('Restoring zones...');
      const { error } = await supabase.current.from('assigned_zones').insert(
        zones.map(z => ({ team_member_id: z.team_member_id, bounds: z.bounds, name: z.name, color: z.color }))
      );
      if (error) throw error;
      showToast('‚úÖ Zones restored!');
      setShowZoneDebug(false);
      loadData();
    } catch (e) {
      console.error('Restore error:', e);
      showToast('‚ùå Restore failed');
    }
  }

  async function deleteAssignedZone(zoneId) {
    const zone = assignedZones.find(z => z.id === zoneId);
    if (!zone || !confirm(`‚ö†Ô∏è DELETE ZONE "${zone.name}"? Cannot be undone!`)) return;
    try {
      const { error } = await supabase.current.from('assigned_zones')
        .update({ deleted_at: new Date().toISOString() }).eq('id', zoneId);
      if (error) throw error;
      showToast(`Zone "${zone.name}" deleted`);
      loadData();
    } catch (e) {
      showToast('Delete failed');
    }
  }

  async function deleteZone(zoneId) {
    if (!confirm('Delete this zone permanently?')) return;
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can delete zones!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').delete().eq('id', zoneId);
      setZones(prev => prev.filter(z => z.id !== zoneId));
      setSelectedZone(null);
      showToast('‚úÖ Zone deleted!');
    } catch (e) {
      showToast('‚ùå Error deleting zone: ' + e.message);
    }
  }

  async function addTeamMember() {
    if (!newUserName.trim()) return;
    
    if (!currentUser || !ADMIN_USER_IDS.includes(currentUser.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can add team members!');
      return;
    }
    
    const newMember = {
      id: `user-${Date.now()}`,
      name: newUserName,
      color: COLORS[teamMembers.length % COLORS.length],
      role: newUserRole,
      created_at: new Date().toISOString()
    };
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').insert([newMember]);
      setTeamMembers(prev => [...prev, newMember]);
      setNewUserName("");
      setNewUserRole("rep");
      setShowUserModal(false);
      showToast(`‚úÖ ${newUserName} added as ${newUserRole}!`);
    } catch (e) {
      showToast('‚ùå Error adding team member: ' + e.message);
    }
  }

  function selectCurrentUser(user) {
    setCurrentUser(user);
    localStorage.setItem('current_user_id', JSON.stringify(user));
    requestLocationPermission(user);
  }

  function selectSearchResult(result) {
    if (mapInstanceRef.current) {
      mapInstanceRef.current.setCenter({ lat: result.lat, lng: result.lng });
      mapInstanceRef.current.setZoom(18);
      setAddressSearch("");
      setSearchResults([]);
    }
  }

  const handleMapClick = async (lat, lng) => {
    if (!currentUser) {
      showToast('‚ö†Ô∏è Please select a user first!');
      return;
    }

    if (!currentLocation) {
      showToast('‚ö†Ô∏è Enable GPS tracking first!');
      return;
    }

    if (!isGPSFresh(currentLocation)) {
      const age = getGPSAge(currentLocation);
      showToast(`‚ö†Ô∏è GPS data is ${age}s old! Move around to get fresh GPS signal, then try again.`, 6000);
      return;
    }

    if (fdMode) {
      const originalStatus = status;
      setStatus('flyer');
      await dropPinAtLocation(lat, lng, '', '', '', '');
      setStatus(originalStatus);
    } else {
      setPendingPinLocation({ lat, lng });
      setShowCustomerForm(true);
    }
  };

  async function dropPinAtLocation(lat, lng, custName, custPhone, custEmail, custNote) {
    setSaving(true);
    setGeocoding(true);

    try {
      const addressData = await reverseGeocode(lat, lng);
      
      let finalLat = lat;
      let finalLng = lng;
      let address = null;
      let shortAddress = null;
      
      if (addressData && addressData.fullAddress !== 'Address Not Found') {
        finalLat = addressData.lat;
        finalLng = addressData.lng;
        address = addressData.fullAddress;
        shortAddress = addressData.shortAddress;
        
        showToast(`üìç Found: ${shortAddress}`, 3000);
      } else {
        showToast('‚ö†Ô∏è No address found - saving location anyway', 3000);
      }

      const distance = calculateDistance(currentLocation.lat, currentLocation.lng, finalLat, finalLng);
      const verification = getVerificationStatus(distance);
      const clickedZone = zones.find(z => {
        if (!z.points || z.points.length < 3) return false;
        return isPointInPolygon({ lat: finalLat, lng: finalLng }, z.points.map(p => ({ lat: p[0], lng: p[1] })));
      });

      let finalNote = note || null;
      if (custName) {
        let noteParts = `${custName}${custEmail ? ' - ' + custEmail : ''}${custPhone ? ' - ' + custPhone : ''}`;
        if (custNote || note) {
          noteParts += ' | ' + [custNote, note].filter(Boolean).join(' | ');
        }
        finalNote = noteParts;
      }

      const newPin = {
        id: `pin-${Date.now()}`,
        lat: finalLat, 
        lng: finalLng, 
        status,
        address: address,
        rep_name: currentUser.name,
        team_member_id: currentUser.id,
        zone_id: clickedZone?.id || null,
        note: finalNote,
        actual_lat: currentLocation.lat,
        actual_lng: currentLocation.lng,
        distance_from_pin: Math.round(distance),
        verification_status: verification.status,
        created_at: new Date().toISOString()
      };
      
      await setSupabaseUser(currentUser.id);
      const { data, error } = await supabase.current.from('pins').insert([newPin]).select();
      
      if (error) {
        showToast('‚ùå Error saving pin: ' + error.message);
      } else {
        setPins(prev => [...prev, newPin]);
        setNote("");
        const leadTypeLabel = LEAD_TYPES[status]?.label || status;
        const gpsAge = getGPSAge(currentLocation);
        const custInfo = custName ? ` for ${custName}` : '';
        
        if (custName && (custEmail || custPhone)) {
          try {
            await sendContactToGHL({
              name: custName,
              email: custEmail,
              phone: custPhone,
              address: address,
              leadType: leadTypeLabel,
              repName: currentUser.name,
              verified: verification.status === 'verified',
              distance: Math.round(distance),
              createdAt: newPin.created_at
            });
            showToast('‚úÖ Contact added to GHL!', 3000);
          } catch (ghlError) {
            console.error('GHL sync failed:', ghlError);
            showToast('‚ö†Ô∏è Pin saved but GHL sync failed', 3000);
          }
        }
        
        if (verification.status === 'verified') {
          showToast(`‚úÖ ${leadTypeLabel}${custInfo} at ${shortAddress || 'location'}! (${Math.round(distance)}ft, GPS: ${gpsAge}s)`, 5000);
        } else if (verification.status === 'suspicious') {
          showToast(`‚ö†Ô∏è ${leadTypeLabel}${custInfo} saved but ${Math.round(distance)}ft away - marked suspicious`, 5000);
        } else {
          showToast(`‚ö†Ô∏è ${leadTypeLabel}${custInfo} saved (${Math.round(distance)}ft - questionable)`, 5000);
        }
      }
    } catch (error) {
      showToast('‚ùå Error: ' + error.message);
    }
    
    setSaving(false);
    setGeocoding(false);
    setShowCustomerForm(false);
    setPendingPinLocation(null);
    setCustomerName('');
    setCustomerPhone('');
    setCustomerEmail('');
    setCustomerNote('');
  }

  function getLeaderboard() {
    const now = new Date();
    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
    startOfWeek.setHours(0, 0, 0, 0);
    const startOfDay = new Date();
    startOfDay.setHours(0, 0, 0, 0);

    return teamMembers.map(member => {
      const memberPins = pins.filter(p => p.team_member_id === member.id);
      const weekPins = memberPins.filter(p => new Date(p.created_at) >= startOfWeek);
      const dayPins = memberPins.filter(p => new Date(p.created_at) >= startOfDay);
      
      let count = 0;
      
      if (leaderboardType === 'd2d') {
        if (leaderboardPeriod === 'week') count = weekPins.filter(p => ['estimate', 'callback', 'notinterested'].includes(p.status)).length;
        else if (leaderboardPeriod === 'day') count = dayPins.filter(p => ['estimate', 'callback', 'notinterested'].includes(p.status)).length;
        else count = memberPins.filter(p => ['estimate', 'callback', 'notinterested'].includes(p.status)).length;
      } else {
        if (leaderboardPeriod === 'week') count = weekPins.filter(p => p.status === 'flyer').length;
        else if (leaderboardPeriod === 'day') count = dayPins.filter(p => p.status === 'flyer').length;
        else count = memberPins.filter(p => p.status === 'flyer').length;
      }

      const liveLocation = liveLocations.find(l => l.team_member_id === member.id);
      const isOnline = liveLocation && new Date(liveLocation.last_updated) > new Date(Date.now() - 5 * 60 * 1000);

      return { ...member, knockCount: count, isOnline, liveLocation };
    }).sort((a, b) => b.knockCount - a.knockCount);
  }

  const stats = {
    totalPins: currentUser ? pins.filter(p => p.team_member_id === currentUser.id).length : 0,
    estimates: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'estimate').length : 0,
    callbacks: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'callback').length : 0,
    notinterested: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'notinterested').length : 0,
    knocked: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'knocked').length : 0,
    verified: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.verification_status === 'verified').length : 0,
    suspicious: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.verification_status === 'suspicious').length : 0,
    onlineUsers: liveLocations.filter(l => new Date(l.last_updated) > new Date(Date.now() - 5 * 60 * 1000)).length,
    withAddress: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.address).length : 0,
    withoutAddress: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && !p.address).length : 0
  };

  const leaderboard = getLeaderboard();
  const gpsAge = currentLocation ? getGPSAge(currentLocation) : null;
  const gpsIsFresh = currentLocation ? isGPSFresh(currentLocation) : false;
  const isAdmin = ADMIN_USER_IDS.includes(currentUser?.id);

  if (loading) {
    return (
      <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',flexDirection:'column',gap:'1.5rem',background:'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)'}}>
        <div style={{fontSize:'5rem',animation:'bounce 1s infinite'}}>üè†</div>
        <div>
          <h1 style={{color:'white',fontSize:'2.5rem',fontWeight:'bold',marginBottom:'0.5rem',textAlign:'center'}}>RepZone Pro</h1>
          <p style={{color:'rgba(255,255,255,0.9)',fontSize:'1.125rem',textAlign:'center'}}>Loading your workspace...</p>
        </div>
        <div style={{width:'200px',height:'4px',background:'rgba(255,255,255,0.2)',borderRadius:'2px',overflow:'hidden'}}>
          <div style={{width:'100%',height:'100%',background:'white',animation:'progress 1.5s ease-in-out infinite'}}></div>
        </div>
      </div>
    );
  }

  // Continue with THE REST OF YOUR JSX - I'll provide this in a follow-up message due to length...

  return (
    <>
      <div className="sidebar">
        <div className="sidebar-content">
          <div style={{ marginBottom: '1.5rem' }}>
            <h1 style={{ fontSize: '1.875rem', fontWeight: '700', color: 'white', marginBottom: '0.25rem' }}>
              üè† RepZone Pro
            </h1>
            <p style={{ fontSize: '0.875rem', color: '#94a3b8' }}>Door Knocking Tracker</p>
          </div>

          {currentUser && (
            <div className="user-badge">
              <div className="user-avatar" style={{ background: currentUser.color }}>
                {currentUser.name[0].toUpperCase()}
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontWeight: '600', color: '#1e293b' }}>{currentUser.name}</div>
                <div style={{ fontSize: '0.75rem', color: '#64748b', textTransform: 'capitalize' }}>
                  {currentUser.role}
                </div>
              </div>
              <button 
                className="btn-secondary" 
                style={{ padding: '0.5rem 1rem', fontSize: '0.75rem', background: 'white', color: '#1e293b', border: '2px solid #e5e7eb', fontWeight: '600' }}
                onClick={() => setShowUserModal(true)}
              >
                Switch
              </button>
            </div>
          )}

          <div className="tab-nav">
            <div className={`tab ${activeTab === 'controls' ? 'active' : ''}`} onClick={() => setActiveTab('controls')}>
              Controls
            </div>
            <div className={`tab ${activeTab === 'zones' ? 'active' : ''}`} onClick={() => setActiveTab('zones')}>
              Zones
            </div>
            <div className={`tab ${activeTab === 'leaderboard' ? 'active' : ''}`} onClick={() => setActiveTab('leaderboard')}>
              Stats
            </div>
            <div className={`tab ${activeTab === 'crm' ? 'active' : ''}`} onClick={() => setActiveTab('crm')}>
              CRM
            </div>
          </div>

          {activeTab === 'controls' && (
            <>
              {/* Address Search */}
              {mode === "drop-pin" && (
                <div className="card" style={{ background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%)', border: '2px solid rgba(59, 130, 246, 0.3)' }}>
                  <label style={{ display: 'block', fontSize: '0.9375rem', fontWeight: '700', marginBottom: '0.875rem', color: 'white' }}>
                    üîç Search Address
                  </label>
                  <div style={{ position: 'relative' }}>
                    <input 
                      className="input"
                      value={addressSearch} 
                      onChange={e => setAddressSearch(e.target.value)} 
                      placeholder="Type address to find location..."
                      style={{ paddingRight: '2.5rem' }}
                    />
                    {searching && (
                      <div style={{ position: 'absolute', right: '0.75rem', top: '50%', transform: 'translateY(-50%)' }}>
                        <div className="spinner" style={{ width: '20px', height: '20px', borderWidth: '2px' }}></div>
                      </div>
                    )}
                  </div>
                  {searchResults.length > 0 && (
                    <div style={{ marginTop: '0.75rem', maxHeight: '250px', overflowY: 'auto', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.75rem', border: '1px solid rgba(255, 255, 255, 0.1)' }}>
                      {searchResults.map((result, idx) => (
                        <div 
                          key={idx} 
                          onClick={() => selectSearchResult(result)}
                          style={{ padding: '1rem', borderBottom: idx < searchResults.length - 1 ? '1px solid rgba(255, 255, 255, 0.05)' : 'none', cursor: 'pointer', transition: 'background 0.2s' }}
                          onMouseEnter={e => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.05)'}
                          onMouseLeave={e => e.currentTarget.style.background = 'transparent'}
                        >
                          <div style={{ fontSize: '0.9375rem', fontWeight: '600', color: 'white', marginBottom: '0.375rem' }}>
                            üìç {result.displayName.split(',')[0]}
                          </div>
                          <div style={{ fontSize: '0.8125rem', color: '#94a3b8', lineHeight: '1.4' }}>
                            {result.displayName}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              <div className="card">
                <h3 style={{ fontSize: '1rem', fontWeight: '600', color: 'white', marginBottom: '0.75rem' }}>
                  üéØ Lead Type
                </h3>
                <div className="lead-type-grid">
                  {Object.values(LEAD_TYPES).slice(0, 4).map(type => (
                    <div
                      key={type.display}
                      className={`lead-type-btn ${status === Object.keys(LEAD_TYPES).find(k => LEAD_TYPES[k] === type) ? 'active' : ''}`}
                      style={{ background: type.color, color: 'white' }}
                      onClick={() => {
                        const key = Object.keys(LEAD_TYPES).find(k => LEAD_TYPES[k] === type);
                        setStatus(key);
                        setFdMode(key === 'flyer');
                      }}
                    >
                      <span className="emoji">{type.icon}</span>
                      <span className="label">{type.display}</span>
                    </div>
                  ))}
                </div>
                
                {status === 'flyer' && (
                  <p style={{ fontSize: '0.75rem', color: '#3b82f6', fontWeight: '700', marginTop: '1rem', textAlign: 'center' }}>
                    ‚ö° FD Mode: Pin drops instantly without customer form
                  </p>
                )}
                
                <input
                  className="input"
                  style={{ marginTop: '1rem' }}
                  placeholder="Note (gate code, dog, etc.)"
                  value={note}
                  onChange={(e) => setNote(e.target.value)}
                />
                
                {!trackingEnabled && (
                  <p style={{ marginTop: '0.75rem', fontSize: '0.8125rem', color: '#ef4444', fontWeight: '700' }}>
                    ‚ö†Ô∏è Enable GPS tracking to verify pin locations
                  </p>
                )}
                {trackingEnabled && !gpsIsFresh && (
                  <p style={{ marginTop: '0.75rem', fontSize: '0.8125rem', color: '#f59e0b', fontWeight: '700' }}>
                    ‚ö†Ô∏è GPS data is stale - walk around to refresh
                  </p>
                )}
              </div>

              <div className="card">
                <h3 style={{ fontSize: '1rem', fontWeight: '600', color: 'white', marginBottom: '1rem' }}>
                  üìä Quick Stats
                </h3>
                <div className="stat-grid">
                  <div className="stat-card">
                    <div className="stat-value" style={{ color: LEAD_TYPES.estimate.color }}>
                      {stats.estimates}
                    </div>
                    <div className="stat-label">Estimates</div>
                  </div>
                  <div className="stat-card">
                    <div className="stat-value" style={{ color: LEAD_TYPES.callback.color }}>
                      {stats.callbacks}
                    </div>
                    <div className="stat-label">Callbacks</div>
                  </div>
                  <div className="stat-card">
                    <div className="stat-value" style={{ color: '#10b981' }}>
                      {stats.verified}
                    </div>
                    <div className="stat-label">Verified</div>
                  </div>
                  <div className="stat-card">
                    <div className="stat-value" style={{ color: '#ef4444' }}>
                      {stats.suspicious}
                    </div>
                    <div className="stat-label">Suspicious</div>
                  </div>
                </div>
              </div>

              <div className="card">
                <h3 style={{ fontSize: '1rem', fontWeight: '600', color: 'white', marginBottom: '0.75rem' }}>
                  üéÆ Controls
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                  <button
                    className={`btn ${trackingEnabled ? 'btn-primary' : 'btn-secondary'}`}
                    onClick={() => trackingEnabled ? stopLocationTracking() : requestLocationPermission(currentUser)}
                  >
                    {trackingEnabled ? '‚úÖ Tracking Active' : 'üìç Start Tracking'}
                  </button>
                  {currentLocation && (
                    <div style={{ fontSize: '0.75rem', color: '#94a3b8', textAlign: 'center' }}>
                      GPS: {gpsAge}s old {gpsIsFresh ? '‚úÖ' : '‚ö†Ô∏è Stale'} | Accuracy: ¬±{currentLocation.accuracy?.toFixed(0)}ft
                    </div>
                  )}
                </div>
              </div>
            </>
          )}

          {activeTab === 'zones' && (
            <>
              <div className="card">
                <h3 style={{ fontSize: '1rem', fontWeight: '600', color: 'white', marginBottom: '1rem' }}>
                  üó∫Ô∏è Zone Management
                </h3>
                
                {!drawingZone ? (
                  <button 
                    className="btn btn-primary" 
                    style={{ width: '100%' }} 
                    onClick={startDrawingZone}
                    disabled={!isAdmin}
                  >
                    + Draw New Zone
                  </button>
                ) : (
                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                    <button className="btn btn-primary" style={{ flex: 1 }} onClick={finishDrawingZone}>
                      ‚úÖ Finish ({zonePoints.length} points)
                    </button>
                    <button className="btn btn-secondary" onClick={cancelDrawingZone}>
                      ‚úñ
                    </button>
                  </div>
                )}
              </div>

              <div className="card">
                <h3 style={{ fontSize: '0.875rem', fontWeight: '600', color: 'white', marginBottom: '0.75rem' }}>
                  Active Zones ({zones.length})
                </h3>
                <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                  {zones.length ==={activeTab === 'leaderboard' && (
        <>
          <div className="card">
            <h3 style={{ fontSize: '1rem', fontWeight: '600', color: 'white', marginBottom: '1rem' }}>
              üèÜ Leaderboard
            </h3>
            
            <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem' }}>
              {[['d2d', 'üö™ D2D'], ['flyer', 'üì¨ Flyers']].map(([type, label]) => (
                <button
                  key={type}
                  className={`btn ${leaderboardType === type ? 'btn-primary' : 'btn-secondary'}`}
                  style={{ flex: 1, padding: '0.5rem', fontSize: '0.75rem' }}
                  onClick={() => setLeaderboardType(type)}
                >
                  {label}
                </button>
              ))}
            </div>

            <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
              {[['day', 'üìÖ Today'], ['week', 'üìÜ Week'], ['all', 'üóìÔ∏è All']].map(([period, label]) => (
                <button
                  key={period}
                  className={`btn ${leaderboardPeriod === period ? 'btn-primary' : 'btn-secondary'}`}
                  style={{ flex: 1, padding: '0.5rem', fontSize: '0.75rem' }}
                  onClick={() => setLeaderboardPeriod(period)}
                >
                  {label}
                </button>
              ))}
            </div>

            <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
              {leaderboard.map((member, idx) => (
                <div key={member.id} className="leaderboard-item">
                  <div className={`rank-badge ${idx < 3 ? `rank-${idx + 1}` : ''}`} style={idx >= 3 ? { background: '#334155', color: '#94a3b8' } : {}}>
                    {idx + 1}
                  </div>
                  <div style={{ width: '32px', height: '32px', borderRadius: '50%', background: member.color, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontWeight: '600', fontSize: '0.875rem', position: 'relative' }}>
                    {member.name[0].toUpperCase()}
                    {member.isOnline && (
                      <div style={{ position: 'absolute', top: '-4px', right: '-4px', width: '12px', height: '12px', background: '#10b981', border: '2px solid #1e293b', borderRadius: '50%' }}></div>
                    )}
                  </div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: '600', color: 'white', fontSize: '0.9375rem' }}>{member.name}</div>
                    <div style={{ fontSize: '0.75rem', color: '#64748b' }}>
                      {member.knockCount} {leaderboardType === 'd2d' ? 'D2D' : 'Flyers'}
                    </div>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <div style={{ fontSize: '1.25rem', fontWeight: '700', color: 'white' }}>{member.knockCount}</div>
                    <div style={{ fontSize: '0.625rem', color: '#64748b' }}>TOTAL</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </>
      )}

      {activeTab === 'crm' && (
        <div style={{ padding: '0', height: '100%', overflow: 'auto' }}>
          <h3 style={{ fontSize: '1.125rem', fontWeight: '700', marginBottom: '1rem', color: 'white' }}>
            üìã My Leads
          </h3>
          
          {pins
            .filter(p => currentUser && p.team_member_id === currentUser.id)
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .map(pin => {
              let customerInfo = null;
              let displayNote = '';
              if (pin.note && pin.note.includes(' - ') && pin.note.includes('@')) {
                const parts = pin.note.split(' | ');
                const custPart = parts[0];
                displayNote = parts[1] || '';
                const custDetails = custPart.split(' - ');
                if (custDetails.length >= 2) {
                  customerInfo = {
                    name: custDetails[0],
                    email: custDetails[1],
                    phone: custDetails[2] || null
                  };
                }
              }
              
              if (!customerInfo) return null;
              
              const leadType = LEAD_TYPES[pin.status] || LEAD_TYPES.knocked;
              
              return (
                <div key={pin.id} className="card" style={{ background: 'rgba(255, 255, 255, 0.05)', border: `1px solid ${leadType.color}40` }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.75rem' }}>
                    <div>
                      <h4 style={{ fontSize: '1rem', fontWeight: 'bold', color: 'white', marginBottom: '0.25rem' }}>{customerInfo.name}</h4>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                        <span style={{ fontSize: '1.125rem' }}>{leadType.icon}</span>
                        <span style={{ fontSize: '0.75rem', fontWeight: '600', color: leadType.color, background: `${leadType.color}15`, padding: '0.25rem 0.5rem', borderRadius: '0.375rem' }}>
                          {leadType.label}
                        </span>
                      </div>
                    </div>
                    <span style={{ fontSize: '0.625rem', color: '#94a3b8', whiteSpace: 'nowrap' }}>
                      {new Date(pin.created_at).toLocaleDateString()}
                    </span>
                  </div>
                  
                  {customerInfo.phone && (
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem', marginBottom: '0.375rem' }}>
                      <span style={{ fontSize: '1rem' }}>üìû</span>
                      <a href={`tel:${customerInfo.phone}`} style={{ color: '#3b82f6', fontWeight: '600', fontSize: '0.875rem', textDecoration: 'none' }}>
                        {customerInfo.phone}
                      </a>
                    </div>
                  )}
                  
                  {customerInfo.email && (
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem', marginBottom: '0.375rem' }}>
                      <span style={{ fontSize: '1rem' }}>üìß</span>
                      <a href={`mailto:${customerInfo.email}`} style={{ color: '#3b82f6', fontWeight: '600', fontSize: '0.875rem', textDecoration: 'none', wordBreak: 'break-all' }}>
                        {customerInfo.email}
                      </a>
                    </div>
                  )}
                  
                  {pin.address && (
                    <div style={{ display: 'flex', alignItems: 'start', gap: '0.375rem', marginBottom: '0.5rem' }}>
                      <span style={{ fontSize: '1rem' }}>üìç</span>
                      <span style={{ fontSize: '0.75rem', color: '#94a3b8', lineHeight: '1.4' }}>{pin.address}</span>
                    </div>
                  )}
                  
                  {displayNote && (
                    <div style={{ display: 'flex', alignItems: 'start', gap: '0.375rem', marginBottom: '0.5rem', padding: '0.5rem', background: 'rgba(0, 0, 0, 0.2)', borderRadius: '0.5rem' }}>
                      <span style={{ fontSize: '1rem' }}>üìù</span>
                      <span style={{ fontSize: '0.75rem', color: '#94a3b8', lineHeight: '1.4', fontStyle: 'italic' }}>{displayNote}</span>
                    </div>
                  )}
                  
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '0.5rem', marginTop: '0.75rem' }}>
                    {customerInfo.phone && (
                      <a href={`tel:${customerInfo.phone}`} className="btn btn-primary" style={{ padding: '0.625rem', fontSize: '0.75rem', textDecoration: 'none' }}>
                        üìû Call
                      </a>
                    )}
                    {customerInfo.email && (
                      <a href={`mailto:${customerInfo.email}`} className="btn btn-primary" style={{ padding: '0.625rem', fontSize: '0.75rem', textDecoration: 'none' }}>
                        üìß Email
                      </a>
                    )}
                  </div>
                </div>
              );
            }).filter(Boolean)}
          
          {pins.filter(p => {
            if (!currentUser || p.team_member_id !== currentUser.id) return false;
            if (!p.note || !p.note.includes('@')) return false;
            return true;
          }).length === 0 && (
            <div style={{ textAlign: 'center', padding: '2rem', color: '#64748b' }}>
              <div style={{ fontSize: '3rem', marginBottom: '0.75rem' }}>üìã</div>
              <p style={{ fontSize: '1rem', fontWeight: '600', marginBottom: '0.375rem' }}>No Leads Yet</p>
              <p style={{ fontSize: '0.75rem' }}>Drop pins with customer info to see them here</p>
            </div>
          )}
        </div>
      )}
    </div>
  </div>

  <div id="map" ref={mapRef}></div>

  {toastMessage && (
    <div className="toast">
      <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
        <div style={{ fontSize: '1.5rem' }}>‚úÖ</div>
        <div style={{ fontWeight: '600', color: '#1e293b' }}>{toastMessage}</div>
      </div>
    </div>
  )}

  {(saving || geocoding) && (
    <div style={{ position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', background: 'white', padding: '2rem 2.5rem', borderRadius: '1.5rem', boxShadow: '0 20px 40px rgba(0,0,0,0.2)', zIndex: 10001, display: 'flex', flexDirection: 'column', gap: '1rem', alignItems: 'center' }}>
      <div className="spinner" style={{ width: '40px', height: '40px', borderWidth: '4px', borderTopColor: '#3b82f6' }}></div>
      <span style={{ fontWeight: '700', fontSize: '1.125rem', color: '#1e293b' }}>{geocoding ? 'üè† Finding Address...' : 'üíæ Saving...'}</span>
    </div>
  )}

  {showCustomerForm && pendingPinLocation && (
    <div className="modal" onClick={() => setShowCustomerForm(false)}>
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1.5rem' }}>
          <h3 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#1e293b' }}>üìã Customer Info</h3>
          <button 
            onClick={() => {
              setShowCustomerForm(false);
              setPendingPinLocation(null);
              setCustomerName('');
              setCustomerPhone('');
              setCustomerEmail('');
              setCustomerNote('');
            }} 
            style={{ width: '40px', height: '40px', borderRadius: '50%', border: 'none', background: '#f1f5f9', fontSize: '1.5rem', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>
            √ó
          </button>
        </div>
        <div style={{ marginBottom: '1rem' }}>
          <label style={{ display: 'block', fontSize: '0.9375rem', fontWeight: '700', marginBottom: '0.5rem', color: '#1e293b' }}>Customer Name</label>
          <input
            className="input"
            style={{ background: 'white', color: '#1e293b', border: '2px solid #e5e7eb' }}
            value={customerName}
            onChange={(e) => setCustomerName(e.target.value)}
            placeholder="Enter customer name..."
            autoFocus
          />
        </div>
        <div style={{ marginBottom: '1rem' }}>
          <label style={{ display: 'block', fontSize: '0.9375rem', fontWeight: '700', marginBottom: '0.5rem', color: '#1e293b' }}>Email <span style={{ color: '#64748b', fontWeight: '400' }}>(optional)</span></label>
          <input
            className="input"
            style={{ background: 'white', color: '#1e293b', border: '2px solid #e5e7eb' }}
            value={customerEmail}
            onChange={(e) => setCustomerEmail(e.target.value)}
            placeholder="customer@email.com"
            type="email"
          />
        </div>
        <div style={{ marginBottom: '1.5rem' }}>
          <label style={{ display: 'block', fontSize: '0.9375rem', fontWeight: '700', marginBottom: '0.5rem', color: '#1e293b' }}>Phone Number <span style={{ color: '#64748b', fontWeight: '400' }}>(optional)</span></label>
          <input
            className="input"
            style={{ background: 'white', color: '#1e293b', border: '2px solid #e5e7eb' }}
            value={customerPhone}
            onChange={(e) => setCustomerPhone(e.target.value)}
            placeholder="(555) 123-4567"
          />
        </div>
        <div style={{ marginBottom: '1.5rem' }}>
          <label style={{ display: 'block', fontSize: '0.9375rem', fontWeight: '700', marginBottom: '0.5rem', color: '#1e293b' }}>Note <span style={{ color: '#64748b', fontWeight: '400' }}>(optional)</span></label>
          <textarea
            className="input"
            style={{ background: 'white', color: '#1e293b', border: '2px solid #e5e7eb', resize: 'vertical', fontFamily: '-apple-system,sans-serif' }}
            value={customerNote}
            onChange={(e) => setCustomerNote(e.target.value)}
            placeholder="Gate code, dog in yard, callback time..."
            rows={2}
          />
        </div>
        <button
          onClick={async () => {
            await dropPinAtLocation(pendingPinLocation.lat, pendingPinLocation.lng, customerName, customerPhone, customerEmail, customerNote);
          }}
          className="btn btn-primary"
          style={{ width: '100%', padding: '1rem' }}
        >
          üìç Drop Pin
        </button>
      </div>
    </div>
  )}

  {showCalendarModal && (
    <div className="modal" onClick={() => setShowCalendarModal(false)}>
      <div className="modal-content" style={{ maxWidth: '700px' }} onClick={(e) => e.stopPropagation()}>
        <h2 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#1e293b', marginBottom: '1rem' }}>
          üìÖ Book Estimate
        </h2>
        <iframe
          src={GHL_CALENDAR_URL}
          style={{ width: '100%', height: '600px', border: 'none', borderRadius: '1rem' }}
        />
        <button
          className="btn btn-secondary"
          style={{ width: '100%', marginTop: '1rem', background: '#f1f5f9', color: '#64748b', border: '2px solid #e5e7eb' }}
          onClick={() => setShowCalendarModal(false)}
        >
          Close
        </button>
      </div>
    </div>
  )}

  {showUserModal && (
    <div className="modal">
      <div className="modal-content">
        <h2 style={{ fontSize: '1.75rem', fontWeight: '700', color: '#1e293b', marginBottom: '0.5rem' }}>
          üëã Select Your Profile
        </h2>
        <p style={{ color: '#64748b', marginBottom: '1.5rem', fontSize: '0.9375rem' }}>
          Choose your name to start tracking
        </p>
        
        <div style={{ maxHeight: '500px', overflowY: 'auto', marginBottom: '1rem' }}>
          {teamMembers.map(member => (
            <div
              key={member.id}
              className="user-selection-item"
              onClick={() => {
                selectCurrentUser(member);
                setShowUserModal(false);
              }}
            >
              <div className="user-selection-avatar" style={{ background: member.color }}>
                {member.name[0].toUpperCase()}
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontWeight: '600', color: '#1e293b', fontSize: '1.0625rem' }}>{member.name}</div>
                <div style={{ fontSize: '0.8125rem', color: '#64748b', textTransform: 'capitalize' }}>
                  {member.role}
                </div>
              </div>
            </div>
          ))}
        </div>

        {isAdmin && (
          <button 
            className="btn btn-primary" 
            style={{ width: '100%' }}
            onClick={() => {
              const name = prompt('Enter new member name:');
              if (name) {
                setNewUserName(name);
                addTeamMember();
              }
            }}
          >
            ‚ûï Add New Member
          </button>
        )}
      </div>
    </div>
  )}

  {selectedZone && (
    <div className="modal" onClick={() => setSelectedZone(null)}>
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1.5rem' }}>
          <h3 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#1e293b' }}>{selectedZone.name}</h3>
          <button onClick={() => setSelectedZone(null)} style={{ width: '40px', height: '40px', borderRadius: '50%', border: 'none', background: '#f1f5f9', fontSize: '1.5rem', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>√ó</button>
        </div>
        {selectedZone.assigned_to ? (
          <>
            <div style={{ padding: '1.25rem', background: '#f0fdf4', borderRadius: '1rem', border: '2px solid #10b981', marginBottom: '1rem' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                <div style={{ width: '56px', height: '56px', borderRadius: '50%', background: teamMembers.find(u => u.id === selectedZone.assigned_to)?.color || '#64748b', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontWeight: 'bold', fontSize: '1.5rem', boxShadow: '0 4px 12px rgba(0,0,0,0.15)' }}>
                  {teamMembers.find(u => u.id === selectedZone.assigned_to)?.name.charAt(0) || '?'}
                </div>
                <div>
                  <div style={{ fontSize: '0.8125rem', color: '#166534', fontWeight: '700' }}>ASSIGNED TO</div>
                  <div style={{ fontWeight: '700', fontSize: '1.25rem', color: '#166534' }}>{teamMembers.find(u => u.id === selectedZone.assigned_to)?.name || 'Unknown'}</div>
                </div>
              </div>
            </div>
            {isAdmin && (
              <button onClick={() => unassignZone(selectedZone.id)} className="btn" style={{ width: '100%', padding: '1rem', background: '#f59e0b', color: 'white', marginBottom: '0.75rem', fontSize: '1rem' }}>üîì Unassign Zone</button>
            )}
          </>
        ) : (
          <>
            {isAdmin ? (
              <>
                <p style={{ color: '#64748b', marginBottom: '1rem', fontSize: '0.9375rem', fontWeight: '600' }}>Select a team member to assign this zone:</p>
                <div style={{ marginBottom: '1rem', maxHeight: '320px', overflowY: 'auto' }}>
                  {teamMembers.map(member => (
                    <div key={member.id} onClick={() => assignZone(selectedZone.id, member.id)} className="user-selection-item">
                      <div className="user-selection-avatar" style={{ background: member.color }}>
                        {member.name.charAt(0)}
                      </div>
                      <div>
                        <div style={{ fontWeight: '700', fontSize: '1.0625rem', color: '#1e293b' }}>{member.name}</div>
                        <div style={{ fontSize: '0.8125rem', color: '#64748b', fontWeight: '600', textTransform: 'capitalize' }}>{member.role}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            ) : (
              <div style={{ padding: '1.25rem', background: '#fef3c7', borderRadius: '1rem', border: '2px solid #f59e0b', marginBottom: '1rem' }}>
                <p style={{ color: '#92400e', fontSize: '0.9375rem', fontWeight: '600' }}>‚ö†Ô∏è This zone is unassigned. Only admins can assign zones.</p>
              </div>
            )}
          </>
        )}
        {isAdmin && (
          <button onClick={() => deleteZone(selectedZone.id)} className="btn" style={{ width: '100%', padding: '1rem', background: '#ef4444', color: 'white', marginBottom: '0.75rem', fontSize: '1rem' }}>üóëÔ∏è Delete Zone</button>
        )}
        <button onClick={() => setSelectedZone(null)} className="btn btn-secondary" style={{ width: '100%', padding: '1rem', background: '#e5e7eb', color: '#1e293b', fontSize: '1rem' }}>Close</button>
      </div>
    </div>
  )}
</>
